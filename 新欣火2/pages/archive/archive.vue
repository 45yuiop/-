<template>
  <view class="container">
    <!-- Ëá™ÂÆö‰πâÂØºËà™Ê†è -->
    <view class="custom-navbar">
      <view class="navbar-content">
        <view class="navbar-left" @click="goBack">
          <text class="back-icon">‚Äπ</text>
          <text class="back-text">ËøîÂõû</text>
        </view>
        <text class="navbar-title">Ê°£Ê°àÁÆ°ÁêÜ</text>
        <view class="navbar-right"></view>
      </view>
    </view>
    
    <!-- ÊêúÁ¥¢Ê†è -->
    <view class="search-container">
      <view class="search-bar">
        <text class="search-icon">üîç</text>
        <input 
          class="search-input" 
          v-model="searchKeyword" 
          placeholder="ÊêúÁ¥¢Â≠¶ÁîüÂßìÂêç„ÄÅÂ≠¶Âè∑ÊàñÁè≠Á∫ß"
          @input="onSearchInput"
        />
        <view v-if="searchKeyword" class="clear-btn" @click="clearSearch">
          <text class="clear-icon">√ó</text>
        </view>
      </view>
    </view>
    
    <!-- ÂàÜÁ±ªÊ†áÁ≠æ -->
    <view class="category-tabs">
      <view 
        class="category-tab"
        :class="{active: activeTab === 'all'}"
        @click="switchTab('all')"
      >
        ÂÖ®ÈÉ®
      </view>
      <view 
        class="category-tab"
        :class="{active: activeTab === 'students'}"
        @click="switchTab('students')"
      >
        Â≠¶ÁîüÊ°£Ê°à
      </view>
      <view 
        class="category-tab"
        :class="{active: activeTab === 'classes'}"
        @click="switchTab('classes')"
      >
        Áè≠Á∫ßÊ°£Ê°à
      </view>
    </view>
    
    
    <!-- ÁºñËæëÊ®°ÂºèÂàáÊç¢ -->
    <view v-if="!isEditMode" class="edit-mode-toggle">
      <view class="edit-mode-btn" @click="enterEditMode">
        <image class="edit-icon" src="/static/745 (1).png" mode="aspectFit"></image>
      </view>
    </view>
    
    <!-- ÂêéÂè∞Âä†ËΩΩËøõÂ∫¶ÊåáÁ§∫Âô® -->
    <view v-if="localCache.isLoadingBackground" class="background-loading-indicator">
      <view class="loading-progress">
        <text class="loading-text">Ê≠£Âú®ÂêéÂè∞Âä†ËΩΩÊõ¥Â§öÊï∞ÊçÆ... {{ localCache.backgroundLoadProgress }}%</text>
        <view class="progress-bar">
          <view class="progress-fill" :style="{width: localCache.backgroundLoadProgress + '%'}"></view>
        </view>
      </view>
    </view>
    
    <!-- Á≠õÈÄâÊù°‰ª∂ -->
    <view class="filter-container">
      <view class="filter-row">
        <view class="filter-item">
          <text class="filter-label">Âπ¥Á∫ßÁ≠õÈÄâÔºö</text>
          <picker 
            mode="selector" 
            :value="gradeFilterIndex" 
            :range="gradeOptions" 
            @change="onGradeFilterChange"
          >
            <view class="filter-picker">
              {{ gradeFilter || 'ÂÖ®ÈÉ®Âπ¥Á∫ß' }}
              <text class="picker-arrow">‚ñº</text>
            </view>
          </picker>
        </view>
        
        <view class="filter-item">
          <text class="filter-label">ÊéíÂ∫èÊñπÂºèÔºö</text>
          <picker 
            mode="selector" 
            :value="sortIndex" 
            :range="sortOptions" 
            @change="onSortChange"
          >
            <view class="filter-picker">
              {{ sortOptions[sortIndex] }}
              <text class="picker-arrow">‚ñº</text>
            </view>
          </picker>
        </view>
      </view>
    </view>
    
    <!-- Êï∞ÊçÆÂàóË°® -->
    <view class="data-container">
      <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
      <view v-if="loading" class="loading-container">
        <text class="loading-text">Âä†ËΩΩ‰∏≠...</text>
      </view>
      
      <!-- Â≠¶ÁîüÊ°£Ê°àÂàóË°® -->
      <view v-if="activeTab === 'all' || activeTab === 'students'" class="section">
        <view class="section-title">
          <text class="title-text">Â≠¶ÁîüÊ°£Ê°à ({{ studentsTotal }})</text>
        </view>
        
        <view v-if="paginatedStudents.length === 0 && !loading" class="empty-state">
          <text class="empty-text">ÊöÇÊó†Â≠¶ÁîüÊ°£Ê°à</text>
        </view>
        
        <!-- Â≠¶ÁîüÂàÜÈ°µÊéß‰ª∂ -->
        <view v-if="showStudentsPagination" class="pagination-container">
          <view class="pagination-info">
            <text class="pagination-text">Á¨¨ {{ studentsPage }} È°µÔºåÂÖ± {{ studentsTotalPages }} È°µ</text>
          </view>
          <view class="pagination-buttons">
            <button 
              class="pagination-btn prev-btn" 
              :disabled="studentsPage <= 1"
              @click="prevPage('students')"
            >
              ‰∏ä‰∏ÄÈ°µ
            </button>
            <button 
              class="pagination-btn next-btn" 
              :disabled="!hasMoreStudents"
              @click="nextPage('students')"
            >
              ‰∏ã‰∏ÄÈ°µ
            </button>
          </view>
        </view>
        
        <!-- Â≠¶ÁîüÊï∞ÊçÆÂàóË°® -->
        <view v-if="paginatedStudents.length > 0" class="student-list">
          <view 
            v-for="student in paginatedStudents" 
            :key="student._id"
            class="student-card"
            :class="{selected: isStudentSelected(student)}"
            @click="isEditMode ? toggleStudentSelection(student) : navigateToStudentDetail(student)"
          >
            <view v-if="isEditMode" class="selection-checkbox">
              <view class="checkbox" :class="{checked: isStudentSelected(student)}">
                <text v-if="isStudentSelected(student)" class="check-icon">‚úì</text>
              </view>
            </view>
            <view class="student-avatar">
              <text class="avatar-text">{{ student.name.charAt(0) }}</text>
            </view>
            <view class="student-info">
              <view class="student-header">
                <text class="student-name">{{ student.name }}</text>
                <text class="student-id">{{ student.studentId }}</text>
              </view>
              <view class="student-details">
                <text class="student-grade">{{ student.grade }}</text>
                <text class="student-subjects">{{ student.subjects.join('„ÄÅ') }}</text>
                <text v-if="student.school" class="student-school">{{ student.school }}</text>
              </view>
              <view class="student-meta">
                <text class="create-time">{{ formatDate(student.createTime) }}</text>
              </view>
            </view>
            <view class="student-actions">
              <text v-if="!isEditMode" class="action-icon">‚Ä∫</text>
              <view v-else class="edit-actions">
                <button class="delete-btn" @click.stop="showDeleteConfirm(student, 'student')">Âà†Èô§</button>
              </view>
            </view>
          </view>
        </view>
      </view>
      
      <!-- Áè≠Á∫ßÊ°£Ê°àÂàóË°® -->
      <view v-if="activeTab === 'all' || activeTab === 'classes'" class="section">
        <view class="section-title">
          <text class="title-text">Áè≠Á∫ßÊ°£Ê°à ({{ classesTotal }})</text>
        </view>
        
        <view v-if="paginatedClasses.length === 0 && !loading" class="empty-state">
          <text class="empty-text">ÊöÇÊó†Áè≠Á∫ßÊ°£Ê°à</text>
        </view>
        
        <!-- Áè≠Á∫ßÂàÜÈ°µÊéß‰ª∂ -->
        <view v-if="showClassesPagination" class="pagination-container">
          <view class="pagination-info">
            <text class="pagination-text">Á¨¨ {{ classesPage }} È°µÔºåÂÖ± {{ classesTotalPages }} È°µ</text>
          </view>
          <view class="pagination-buttons">
            <button 
              class="pagination-btn prev-btn" 
              :disabled="classesPage <= 1"
              @click="prevPage('classes')"
            >
              ‰∏ä‰∏ÄÈ°µ
            </button>
            <button 
              class="pagination-btn next-btn" 
              :disabled="!hasMoreClasses"
              @click="nextPage('classes')"
            >
              ‰∏ã‰∏ÄÈ°µ
            </button>
          </view>
        </view>
        
        <!-- Áè≠Á∫ßÊï∞ÊçÆÂàóË°® -->
        <view v-if="paginatedClasses.length > 0" class="class-list">
          <view 
            v-for="classItem in paginatedClasses" 
            :key="classItem._id"
            class="class-card"
            :class="{selected: isClassSelected(classItem)}"
            @click="isEditMode ? toggleClassSelection(classItem) : navigateToClassDetail(classItem)"
          >
            <view v-if="isEditMode" class="selection-checkbox">
              <view class="checkbox" :class="{checked: isClassSelected(classItem)}">
                <text v-if="isClassSelected(classItem)" class="check-icon">‚úì</text>
              </view>
            </view>
            <view class="class-icon">
              <text class="class-icon-text">Áè≠</text>
            </view>
            <view class="class-info">
              <view class="class-header">
                <text class="class-name">{{ classItem.className }}</text>
                <text class="class-code">{{ classItem.classCode }}</text>
              </view>
              <view class="class-details">
                <text class="class-grade">{{ classItem.grade }}</text>
                <text class="class-teacher">Áè≠‰∏ª‰ªªÔºö{{ classItem.teacherName }}</text>
                <text class="class-student-count">Â≠¶ÁîüÊï∞Ôºö{{ classItem.studentCount || 0 }}</text>
              </view>
              <view class="class-meta">
                <text class="create-time">{{ formatDate(classItem.createTime) }}</text>
              </view>
            </view>
            <view class="class-actions">
              <text v-if="!isEditMode" class="action-icon">‚Ä∫</text>
              <view v-else class="edit-actions">
                <button class="delete-btn" @click.stop="showDeleteConfirm(classItem, 'class')">Âà†Èô§</button>
              </view>
            </view>
          </view>
        </view>
      </view>
    </view>
    
    <!-- ÊâπÈáèÊìç‰ΩúÂ∑•ÂÖ∑Ê†è - Âõ∫ÂÆöÂú®Â∫ïÈÉ® -->
    <view v-if="isEditMode" class="batch-toolbar-fixed">
      <view class="toolbar-left">
        <view class="select-all-btn" @click="toggleSelectAll">
          <text class="select-all-text">{{ isAllSelected ? 'ÂèñÊ∂àÂÖ®ÈÄâ' : 'ÂÖ®ÈÄâ' }}</text>
        </view>
        <text class="selected-count">Â∑≤ÈÄâÊã© {{ selectedItems.length }} È°π</text>
      </view>
      <view class="toolbar-right">
        <button class="batch-delete-btn" @click="showBatchDeleteConfirm" :disabled="selectedItems.length === 0">
          ÊâπÈáèÂà†Èô§
        </button>
        <button class="exit-edit-btn" @click="exitEditMode">
          ÂÆåÊàê
        </button>
      </view>
    </view>
    
    <!-- Âà†Èô§Á°ÆËÆ§ÂºπÁ™ó -->
    <view v-if="showDeleteModal" class="delete-modal" @click="closeDeleteModal">
      <view class="delete-modal-content" @click.stop>
        <view class="delete-header">
          <text class="delete-title">Á°ÆËÆ§Âà†Èô§</text>
        </view>
        <view class="delete-body">
          <text class="delete-message">{{ deleteMessage }}</text>
        </view>
        <view class="delete-footer">
          <button class="cancel-delete-btn" @click="closeDeleteModal">ÂèñÊ∂à</button>
          <button class="confirm-delete-btn" @click="confirmDelete">Á°ÆËÆ§Âà†Èô§</button>
        </view>
      </view>
    </view>
  </view>
</template>

<script>
export default {
  data() {
    return {
      searchKeyword: '',
      activeTab: 'all',
      gradeFilter: '',
      gradeFilterIndex: 0,
      gradeOptions: ['ÂÖ®ÈÉ®Âπ¥Á∫ß', '‰∏ÄÂπ¥Á∫ß', '‰∫åÂπ¥Á∫ß', '‰∏âÂπ¥Á∫ß', 'ÂõõÂπ¥Á∫ß', '‰∫îÂπ¥Á∫ß', 'ÂÖ≠Âπ¥Á∫ß', '‰∏ÉÂπ¥Á∫ß', 'ÂÖ´Âπ¥Á∫ß', '‰πùÂπ¥Á∫ß', 'È´ò‰∏Ä', 'È´ò‰∫å', 'È´ò‰∏â'],
      sortIndex: 0,
      sortOptions: ['ÊåâÂàõÂª∫Êó∂Èó¥', 'ÊåâÂßìÂêç', 'ÊåâÂ≠¶Âè∑', 'ÊåâÂπ¥Á∫ß'],
      loading: false,
      students: [],
      classes: [],
      // Ê∑ªÂä†ÊÄªÊï∞ÂíåÂàÜÈ°µ‰ø°ÊÅØ
      studentsTotal: 0,
      classesTotal: 0,
      studentsPage: 1,
      classesPage: 1,
      hasMoreStudents: true,
      hasMoreClasses: true,
      // ÂàÜÈ°µÊòæÁ§∫ÊéßÂà∂
      showStudentsPagination: false,
      showClassesPagination: false,
      studentsPageSize: 20,
      classesPageSize: 20,
      isEditMode: false,
      selectedItems: [],
      showDeleteModal: false,
      deleteMessage: '',
      deleteTarget: null,
      deleteType: '',
      // Êú¨Âú∞ÁºìÂ≠òÊú∫Âà∂ - Â≠òÂÇ®ÊâÄÊúâÊï∞ÊçÆ
      localCache: {
        allStudents: [], // ÊâÄÊúâÂ≠¶ÁîüÊï∞ÊçÆ
        allClasses: [], // ÊâÄÊúâÁè≠Á∫ßÊï∞ÊçÆ
        lastLoadTime: null,
        isLoaded: false, // ÊòØÂê¶Â∑≤Âä†ËΩΩÂÖ®ÈáèÊï∞ÊçÆ
        isLoadingBackground: false, // ÊòØÂê¶Ê≠£Âú®ÂêéÂè∞Âä†ËΩΩ
        backgroundLoadProgress: 0, // ÂêéÂè∞Âä†ËΩΩËøõÂ∫¶
        // ÂàÜÊâπÁºìÂ≠ò
        studentsBatches: [], // Â≠òÂÇ®Â≠¶ÁîüÊï∞ÊçÆÊâπÊ¨° [batch1, batch2, batch3...]
        classesBatches: [],  // Â≠òÂÇ®Áè≠Á∫ßÊï∞ÊçÆÊâπÊ¨° [batch1, batch2, batch3...]
        studentsBatchSize: 50, // ÊØèÊâπ50Êù°Êï∞ÊçÆ
        classesBatchSize: 50,
        studentsTotalBatches: 0, // ÊÄªÊâπÊ¨°Êï∞
        classesTotalBatches: 0,
        currentStudentsBatch: 0, // ÂΩìÂâçÂä†ËΩΩÂà∞Á¨¨Âá†Êâπ
        currentClassesBatch: 0
      }
    }
  },
  computed: {
    // ËÆ°ÁÆóÂ≠¶ÁîüÊÄªÈ°µÊï∞
    studentsTotalPages() {
      const totalPages = Math.ceil(this.studentsTotal / this.studentsPageSize);
      console.log('ËÆ°ÁÆóÂ≠¶ÁîüÊÄªÈ°µÊï∞:', this.studentsTotal, '/', this.studentsPageSize, '=', totalPages);
      return totalPages;
    },
    
    // ËÆ°ÁÆóÁè≠Á∫ßÊÄªÈ°µÊï∞
    classesTotalPages() {
      return Math.ceil(this.classesTotal / this.classesPageSize);
    },
    
    filteredStudents() {
      let filtered = this.localCache.allStudents || [];
      
      // Âπ¥Á∫ßËøáÊª§
      if (this.gradeFilter && this.gradeFilter !== 'ÂÖ®ÈÉ®Âπ¥Á∫ß') {
        filtered = filtered.filter(student => student.grade === this.gradeFilter);
      }
      
      // ÊéíÂ∫è
      return this.sortData(filtered);
    },
    filteredClasses() {
      let filtered = this.localCache.allClasses || [];
      
      // Âπ¥Á∫ßËøáÊª§
      if (this.gradeFilter && this.gradeFilter !== 'ÂÖ®ÈÉ®Âπ¥Á∫ß') {
        filtered = filtered.filter(classItem => classItem.grade === this.gradeFilter);
      }
      
      // ÊéíÂ∫è
      return this.sortData(filtered);
    },
    // ÂàÜÈ°µÂêéÁöÑÂ≠¶ÁîüÊï∞ÊçÆ
    paginatedStudents() {
      const startIndex = (this.studentsPage - 1) * this.studentsPageSize;
      const endIndex = startIndex + this.studentsPageSize;
      return this.filteredStudents.slice(startIndex, endIndex);
    },
    // ÂàÜÈ°µÂêéÁöÑÁè≠Á∫ßÊï∞ÊçÆ
    paginatedClasses() {
      const startIndex = (this.classesPage - 1) * this.classesPageSize;
      const endIndex = startIndex + this.classesPageSize;
      return this.filteredClasses.slice(startIndex, endIndex);
    },
    isAllSelected() {
      const currentItems = this.activeTab === 'students' ? this.paginatedStudents : 
                          this.activeTab === 'classes' ? this.paginatedClasses : 
                          [...this.paginatedStudents, ...this.paginatedClasses];
      return currentItems.length > 0 && this.selectedItems.length === currentItems.length;
    }
  },
  onLoad() {
    // Áõ¥Êé•Âä†ËΩΩÊï∞ÊçÆÔºå‰∏ç‰ΩøÁî®ÁºìÂ≠ò
    this.loadData();
  },
  onShow() {
    // Áõ¥Êé•Âä†ËΩΩÊï∞ÊçÆÔºå‰∏ç‰ΩøÁî®ÁºìÂ≠ò
    this.loadData();
  },
  
  onReady() {
    // ‰∏çÂÜç‰ΩøÁî®ÁºìÂ≠òÔºåÊó†ÈúÄÊ≥®ÂÜåÂÖ®Â±ÄÊñπÊ≥ï
  },
  methods: {
    goBack() {
      uni.navigateBack();
    },
    onSearchInput() {
      // ÊêúÁ¥¢Èò≤ÊäñÂ§ÑÁêÜ
      clearTimeout(this.searchTimer);
      this.searchTimer = setTimeout(() => {
        this.performSearch();
      }, 300);
    },
    
    performSearch() {
      if (!this.searchKeyword.trim()) {
        // Â¶ÇÊûúÊêúÁ¥¢ÂÖ≥ÈîÆËØç‰∏∫Á©∫ÔºåÈáçÊñ∞Â∫îÁî®Á≠õÈÄâÊù°‰ª∂
        this.applyFilters();
        return;
      }
      
      // ‰ΩøÁî®Êú¨Âú∞ÁºìÂ≠òËøõË°åÊêúÁ¥¢
      const keyword = this.searchKeyword.toLowerCase().trim();
      
      // ÊêúÁ¥¢Â≠¶Áîü
      if (this.activeTab === 'students' || this.activeTab === 'all') {
        let searchStudents = this.localCache.allStudents.filter(student => 
          student.name.toLowerCase().includes(keyword) ||
          student.studentId.toLowerCase().includes(keyword) ||
          student.school?.toLowerCase().includes(keyword)
        );
        
        // Â∫îÁî®Âπ¥Á∫ßÁ≠õÈÄâ
        if (this.gradeFilter && this.gradeFilter !== 'ÂÖ®ÈÉ®Âπ¥Á∫ß') {
          searchStudents = searchStudents.filter(student => student.grade === this.gradeFilter);
        }
        
        // Â∫îÁî®ÂàÜÈ°µÔºöÂè™ÊòæÁ§∫ÂΩìÂâçÈ°µÁöÑÊêúÁ¥¢ÁªìÊûú
        const startIndex = (this.studentsPage - 1) * this.studentsPageSize;
        const endIndex = startIndex + this.studentsPageSize;
        this.students = searchStudents.slice(startIndex, endIndex);
        // ÊêúÁ¥¢Êó∂‰øùÊåÅÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÁúüÂÆûÊÄªÊï∞Ôºå‰∏ç‰øÆÊîπ studentsTotal
      }
      
      // ÊêúÁ¥¢Áè≠Á∫ß
      if (this.activeTab === 'classes' || this.activeTab === 'all') {
        let searchClasses = this.localCache.allClasses.filter(classItem => 
          classItem.className.toLowerCase().includes(keyword) ||
          classItem.classCode.toLowerCase().includes(keyword) ||
          classItem.teacherName.toLowerCase().includes(keyword)
        );
        
        // Â∫îÁî®Âπ¥Á∫ßÁ≠õÈÄâ
        if (this.gradeFilter && this.gradeFilter !== 'ÂÖ®ÈÉ®Âπ¥Á∫ß') {
          searchClasses = searchClasses.filter(classItem => classItem.grade === this.gradeFilter);
        }
        
        // Â∫îÁî®ÂàÜÈ°µÔºöÂè™ÊòæÁ§∫ÂΩìÂâçÈ°µÁöÑÊêúÁ¥¢ÁªìÊûú
        const classStartIndex = (this.classesPage - 1) * this.classesPageSize;
        const classEndIndex = classStartIndex + this.classesPageSize;
        this.classes = searchClasses.slice(classStartIndex, classEndIndex);
        // ÊêúÁ¥¢Êó∂‰øùÊåÅÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÁúüÂÆûÊÄªÊï∞Ôºå‰∏ç‰øÆÊîπ classesTotal
      }
    },
    clearSearch() {
      this.searchKeyword = '';
      // Ê∏ÖÁ©∫ÊêúÁ¥¢Êó∂ÈáçÊñ∞Â∫îÁî®Á≠õÈÄâÊù°‰ª∂
      this.performSearch();
    },
    switchTab(tab) {
      this.activeTab = tab;
      
      // ÂàáÊç¢Ê†áÁ≠æÈ°µÊó∂ÔºåÈáçÊñ∞Â∫îÁî®Á≠õÈÄâÊù°‰ª∂
      this.applyFilters();
    },
    onGradeFilterChange(e) {
      this.gradeFilterIndex = e.detail.value;
      this.gradeFilter = this.gradeOptions[e.detail.value];
      
      // Âπ¥Á∫ßÁ≠õÈÄâÂèòÂåñÊó∂ÔºåÈáçÁΩÆÂàÜÈ°µÂà∞Á¨¨‰∏ÄÈ°µ
      this.studentsPage = 1;
      this.classesPage = 1;
      
      // Áõ¥Êé•Â∫îÁî®Á≠õÈÄâÊù°‰ª∂Ôºà‰ΩøÁî®ÁºìÂ≠òÊï∞ÊçÆÔºâ
      this.applyFilters();
    },
    onSortChange(e) {
      this.sortIndex = e.detail.value;
    },
    sortData(data) {
      const sortType = this.sortOptions[this.sortIndex];
      return data.sort((a, b) => {
        switch (sortType) {
          case 'ÊåâÂàõÂª∫Êó∂Èó¥':
            return new Date(b.createTime) - new Date(a.createTime);
          case 'ÊåâÂßìÂêç':
            return a.name.localeCompare(b.name);
          case 'ÊåâÂ≠¶Âè∑':
            return a.studentId?.localeCompare(b.studentId) || 0;
          case 'ÊåâÂπ¥Á∫ß':
            return a.grade.localeCompare(b.grade);
          default:
            return 0;
        }
      });
    },
    async loadData() {
      this.loading = true;
      try {
        console.log('ÂºÄÂßãÂä†ËΩΩÊï∞ÊçÆÔºàÁõ¥Êé•ËØªÂèñÊï∞ÊçÆÂ∫ìÔºâ');
        
        // Áõ¥Êé•Âä†ËΩΩÂ≠¶ÁîüÂíåÁè≠Á∫ßÊï∞ÊçÆ
        const studentsResult = await uniCloud.callFunction({
          name: 'archive-manager',
          data: {
            action: 'getStudents',
            page: 1,
            pageSize: 1000 // Ëé∑ÂèñÊâÄÊúâÂ≠¶Áîü
          }
        });
        
        const classesResult = await uniCloud.callFunction({
          name: 'archive-manager',
          data: {
            action: 'getClasses',
            page: 1,
            pageSize: 1000 // Ëé∑ÂèñÊâÄÊúâÁè≠Á∫ß
          }
        });
        
        if (studentsResult.result.code === 0) {
          this.localCache.allStudents = studentsResult.result.data || [];
          this.studentsTotal = studentsResult.result.total || 0;
          console.log('Â≠¶ÁîüÊï∞ÊçÆÂä†ËΩΩÊàêÂäüÔºåÊï∞Èáè:', this.localCache.allStudents.length);
          console.log('Â≠¶ÁîüÊï∞ÊçÆËØ¶ÊÉÖ:', this.localCache.allStudents);
        } else {
          console.error('Â≠¶ÁîüÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', studentsResult.result.message);
        }
        
        if (classesResult.result.code === 0) {
          this.localCache.allClasses = classesResult.result.data || [];
          this.classesTotal = classesResult.result.total || 0;
          console.log('Áè≠Á∫ßÊï∞ÊçÆÂä†ËΩΩÊàêÂäüÔºåÊï∞Èáè:', this.localCache.allClasses.length);
          console.log('Áè≠Á∫ßÊï∞ÊçÆËØ¶ÊÉÖ:', this.localCache.allClasses);
        } else {
          console.error('Áè≠Á∫ßÊï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•:', classesResult.result.message);
        }
        
        // Â∫îÁî®Á≠õÈÄâÊù°‰ª∂
        this.applyFilters();
        
      } catch (error) {
        console.error('Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•:', error);
        uni.showToast({
          title: 'Âä†ËΩΩÊï∞ÊçÆÂ§±Ë¥•',
          icon: 'error'
        });
      } finally {
        this.loading = false;
      }
    },
    
    // ‰ªéÊú¨Âú∞ÁºìÂ≠òÂä†ËΩΩÊï∞ÊçÆ
    loadFromCache() {
      console.log('‰ªéÁºìÂ≠òÂä†ËΩΩÊï∞ÊçÆ');
      console.log('Â≠¶ÁîüÊâπÊ¨°Êï∞ÊçÆ:', this.localCache.studentsBatches);
      console.log('Áè≠Á∫ßÊâπÊ¨°Êï∞ÊçÆ:', this.localCache.classesBatches);
      
      // ÂêàÂπ∂ÊâÄÊúâÊâπÊ¨°Êï∞ÊçÆ
      this.localCache.allStudents = this.localCache.studentsBatches.flat();
      this.localCache.allClasses = this.localCache.classesBatches.flat();
      
      console.log('ÂêàÂπ∂ÂêéÂ≠¶ÁîüÊï∞ÊçÆ:', this.localCache.allStudents.length, 'Êù°');
      console.log('ÂêàÂπ∂ÂêéÁè≠Á∫ßÊï∞ÊçÆ:', this.localCache.allClasses.length, 'Êù°');
      
      // Â∫îÁî®ÂΩìÂâçÁ≠õÈÄâÊù°‰ª∂
      this.applyFilters();
      
      console.log('ÁºìÂ≠òÊï∞ÊçÆÂä†ËΩΩÂÆåÊàêÔºåÂ≠¶Áîü:', this.students.length, 'Áè≠Á∫ß:', this.classes.length);
    },
    
    // ‰øùÂ≠òÁºìÂ≠òÊï∞ÊçÆÂà∞Êú¨Âú∞Â≠òÂÇ®
    saveCacheToStorage() {
      try {
        const cacheData = {
          studentsBatches: this.localCache.studentsBatches,
          classesBatches: this.localCache.classesBatches,
          studentsTotal: this.studentsTotal,
          classesTotal: this.classesTotal,
          lastLoadTime: this.localCache.lastLoadTime,
          isLoaded: this.localCache.isLoaded,
          // ‰øùÂ≠òÂàÜÈ°µ‰ø°ÊÅØ
          studentsPage: this.studentsPage,
          classesPage: this.classesPage,
          hasMoreStudents: this.hasMoreStudents,
          hasMoreClasses: this.hasMoreClasses,
          showStudentsPagination: this.showStudentsPagination,
          showClassesPagination: this.showClassesPagination
        };
        uni.setStorageSync('archive_cache', cacheData);
        console.log('ÁºìÂ≠òÊï∞ÊçÆÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®');
      } catch (error) {
        console.error('‰øùÂ≠òÁºìÂ≠òÊï∞ÊçÆÂ§±Ë¥•:', error);
      }
    },
    
    // ‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÁºìÂ≠òÊï∞ÊçÆ
    loadCacheFromStorage() {
      try {
        const cacheData = uni.getStorageSync('archive_cache');
        if (cacheData && cacheData.studentsBatches && cacheData.studentsBatches.length > 0) {
          this.localCache.studentsBatches = cacheData.studentsBatches;
          this.localCache.classesBatches = cacheData.classesBatches || [];
          this.studentsTotal = cacheData.studentsTotal || 0;
          this.classesTotal = cacheData.classesTotal || 0;
          this.localCache.lastLoadTime = cacheData.lastLoadTime;
          this.localCache.isLoaded = cacheData.isLoaded;
          
          // ËÆæÁΩÆÂàÜÈ°µ‰ø°ÊÅØ
          this.studentsPage = cacheData.studentsPage || 1;
          this.classesPage = cacheData.classesPage || 1;
          this.hasMoreStudents = cacheData.hasMoreStudents !== undefined ? cacheData.hasMoreStudents : (this.studentsTotal > this.studentsPageSize);
          this.hasMoreClasses = cacheData.hasMoreClasses !== undefined ? cacheData.hasMoreClasses : (this.classesTotal > this.classesPageSize);
          this.showStudentsPagination = cacheData.showStudentsPagination !== undefined ? cacheData.showStudentsPagination : (this.studentsTotal > 0);
          this.showClassesPagination = cacheData.showClassesPagination !== undefined ? cacheData.showClassesPagination : (this.classesTotal > 0);
          
          console.log('‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÁºìÂ≠òÊï∞ÊçÆÊàêÂäü');
          console.log('Â≠¶ÁîüÊâπÊ¨°:', this.localCache.studentsBatches.length);
          console.log('Áè≠Á∫ßÊâπÊ¨°:', this.localCache.classesBatches.length);
          console.log('ÂàÜÈ°µ‰ø°ÊÅØËÆæÁΩÆ:', {
            studentsTotal: this.studentsTotal,
            classesTotal: this.classesTotal,
            showStudentsPagination: this.showStudentsPagination,
            showClassesPagination: this.showClassesPagination,
            hasMoreStudents: this.hasMoreStudents,
            hasMoreClasses: this.hasMoreClasses
          });
          return true;
        }
      } catch (error) {
        console.error('‰ªéÊú¨Âú∞Â≠òÂÇ®Âä†ËΩΩÁºìÂ≠òÊï∞ÊçÆÂ§±Ë¥•:', error);
      }
      return false;
    },
    
    // Êõ¥Êñ∞Êú¨Âú∞ÁºìÂ≠òÔºàÂΩìÊúâÊñ∞Êï∞ÊçÆÂΩïÂÖ•Êó∂Ë∞ÉÁî®Ôºâ
    async updateLocalCache() {
      try {
        console.log('ÂºÄÂßãÊõ¥Êñ∞Êú¨Âú∞ÁºìÂ≠ò');
        
        // Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂ≠¶ÁîüÂíåÁè≠Á∫ßÊï∞ÊçÆ
        const studentsResult = await uniCloud.callFunction({
          name: 'archive-manager',
          data: {
            action: 'getStudents',
            page: 1,
            pageSize: this.localCache.studentsBatchSize
          }
        });
        
        const classesResult = await uniCloud.callFunction({
          name: 'archive-manager',
          data: {
            action: 'getClasses',
            page: 1,
            pageSize: this.localCache.classesBatchSize
          }
        });
        
        if (studentsResult.result.code === 0) {
          const newStudents = studentsResult.result.data || [];
          this.localCache.studentsBatches[0] = newStudents;
          this.studentsTotal = studentsResult.result.total || 0;
          console.log('Â≠¶ÁîüÁºìÂ≠òÂ∑≤Êõ¥Êñ∞:', newStudents.length, 'Êù°');
        }
        
        if (classesResult.result.code === 0) {
          const newClasses = classesResult.result.data || [];
          this.localCache.classesBatches[0] = newClasses;
          this.classesTotal = classesResult.result.total || 0;
          console.log('Áè≠Á∫ßÁºìÂ≠òÂ∑≤Êõ¥Êñ∞:', newClasses.length, 'Êù°');
        }
        
        // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
        this.hasMoreStudents = this.studentsTotal > this.studentsPageSize;
        this.hasMoreClasses = this.classesTotal > this.classesPageSize;
        this.showStudentsPagination = this.studentsTotal > 0;
        this.showClassesPagination = this.classesTotal > 0;
        
        // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÁºìÂ≠ò
        this.saveCacheToStorage();
        
        // ÈáçÊñ∞Âä†ËΩΩÊòæÁ§∫Êï∞ÊçÆ
        this.loadFromCache();
        
        console.log('Êú¨Âú∞ÁºìÂ≠òÊõ¥Êñ∞ÂÆåÊàê');
        
      } catch (error) {
        console.error('Êõ¥Êñ∞Êú¨Âú∞ÁºìÂ≠òÂ§±Ë¥•:', error);
      }
    },
    
    // Ê∑ªÂä†Êñ∞Áè≠Á∫ßÂà∞Êú¨Âú∞ÁºìÂ≠ò
    addClassToLocalCache(newClassData) {
      try {
        console.log('Ê∑ªÂä†Êñ∞Áè≠Á∫ßÂà∞Êú¨Âú∞ÁºìÂ≠ò:', newClassData);
        
        if (newClassData && newClassData.classId) {
          const newClass = {
            _id: newClassData.classId,
            className: newClassData.className || 'Êú™ÂëΩÂêçÁè≠Á∫ß',
            grade: newClassData.grade || '',
            subject: newClassData.subject || '',
            headTeacher: newClassData.headTeacher || '',
            headTeacherId: newClassData.headTeacherId || '',
            school: newClassData.school || 'ÈªòËÆ§Â≠¶Ê†°',
            students: [],
            studentIds: [],
            studentCount: 0,
            status: 'active',
            createTime: newClassData.createTime || new Date().toISOString(),
            updateTime: newClassData.updateTime || new Date().toISOString()
          };
          
          // Ê∑ªÂä†Âà∞Êú¨Âú∞ÁºìÂ≠ò
          this.localCache.allClasses.push(newClass);
          this.localCache.classesBatches[0].push(newClass);
          this.classesTotal = this.localCache.allClasses.length;
          
          // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
          this.hasMoreClasses = this.classesTotal > this.classesPageSize;
          this.showClassesPagination = this.classesTotal > 0;
          
          // ‰øùÂ≠òÂà∞Êú¨Âú∞Â≠òÂÇ®
          this.saveCacheToStorage();
          
          // ÈáçÊñ∞Âä†ËΩΩÊòæÁ§∫Êï∞ÊçÆ
          this.loadFromCache();
          
          console.log('Êñ∞Áè≠Á∫ßÂ∑≤Ê∑ªÂä†Âà∞Êú¨Âú∞ÁºìÂ≠ò:', newClass.className);
        }
      } catch (error) {
        console.error('Ê∑ªÂä†Êñ∞Áè≠Á∫ßÂà∞Êú¨Âú∞ÁºìÂ≠òÂ§±Ë¥•:', error);
      }
    },
    
    // Âä†ËΩΩÁ¨¨‰∏ÄÊâπÊï∞ÊçÆÔºà0-50Êù°Ôºâ
    async loadFirstBatchData() {
      try {
        console.log('ÂºÄÂßãÂä†ËΩΩÁ¨¨‰∏ÄÊâπÊï∞ÊçÆÔºà0-50Êù°Ôºâ');
        
        // Ëé∑ÂèñÂ≠¶ÁîüÊÄªÊï∞ÂíåÁè≠Á∫ßÊÄªÊï∞
        const studentsCountResult = await uniCloud.callFunction({
          name: 'archive-manager',
          data: {
            action: 'getStudents',
            page: 1,
            pageSize: 1 // Âè™Ëé∑ÂèñÊÄªÊï∞
          }
        });
        
        const classesCountResult = await uniCloud.callFunction({
          name: 'archive-manager',
          data: {
            action: 'getClasses',
            page: 1,
            pageSize: 1 // Âè™Ëé∑ÂèñÊÄªÊï∞
          }
        });
        
        if (studentsCountResult.result.code === 0) {
          this.studentsTotal = studentsCountResult.result.total || 0;
          this.localCache.studentsTotalBatches = Math.ceil(this.studentsTotal / this.localCache.studentsBatchSize);
          console.log('Â≠¶ÁîüÊÄªÊï∞:', this.studentsTotal, 'ÊÄªÊâπÊ¨°Êï∞:', this.localCache.studentsTotalBatches);
        }
        
        if (classesCountResult.result.code === 0) {
          this.classesTotal = classesCountResult.result.total || 0;
          this.localCache.classesTotalBatches = Math.ceil(this.classesTotal / this.localCache.classesBatchSize);
          console.log('Áè≠Á∫ßÊÄªÊï∞:', this.classesTotal, 'ÊÄªÊâπÊ¨°Êï∞:', this.localCache.classesTotalBatches);
        }
        
        // Âä†ËΩΩÁ¨¨‰∏ÄÊâπÂ≠¶ÁîüÊï∞ÊçÆÔºà0-50Êù°Ôºâ
        const studentsResult = await uniCloud.callFunction({
          name: 'archive-manager',
          data: {
            action: 'getStudents',
            page: 1,
            pageSize: this.localCache.studentsBatchSize
          }
        });
        
        // Âä†ËΩΩÁ¨¨‰∏ÄÊâπÁè≠Á∫ßÊï∞ÊçÆÔºà0-50Êù°Ôºâ
        const classesResult = await uniCloud.callFunction({
          name: 'archive-manager',
          data: {
            action: 'getClasses',
            page: 1,
            pageSize: this.localCache.classesBatchSize
          }
        });
        
        if (studentsResult.result.code === 0) {
          const firstBatchStudents = studentsResult.result.data || [];
          // Á°Æ‰øùÊâπÊ¨°Êï∞ÁªÑÂ≠òÂú®
          if (!this.localCache.studentsBatches) {
            this.localCache.studentsBatches = [];
          }
          this.localCache.studentsBatches[0] = firstBatchStudents;
          this.localCache.currentStudentsBatch = 1;
          console.log('Á¨¨‰∏ÄÊâπÂ≠¶ÁîüÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê:', firstBatchStudents.length, 'Êù°');
          console.log('Â≠¶ÁîüÊâπÊ¨°Êï∞ÁªÑ:', this.localCache.studentsBatches);
        }
        
        if (classesResult.result.code === 0) {
          const firstBatchClasses = classesResult.result.data || [];
          // Á°Æ‰øùÊâπÊ¨°Êï∞ÁªÑÂ≠òÂú®
          if (!this.localCache.classesBatches) {
            this.localCache.classesBatches = [];
          }
          this.localCache.classesBatches[0] = firstBatchClasses;
          this.localCache.currentClassesBatch = 1;
          console.log('Á¨¨‰∏ÄÊâπÁè≠Á∫ßÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê:', firstBatchClasses.length, 'Êù°');
          console.log('Áè≠Á∫ßÊâπÊ¨°Êï∞ÁªÑ:', this.localCache.classesBatches);
        }
        
        // Á´ãÂç≥ÊòæÁ§∫Á¨¨‰∏ÄÊâπÊï∞ÊçÆ
        this.loadFromCache();
        
        // ËÆæÁΩÆÂàÜÈ°µ‰ø°ÊÅØ
        this.studentsPage = 1;
        this.classesPage = 1;
        this.hasMoreStudents = this.localCache.currentStudentsBatch < this.localCache.studentsTotalBatches;
        this.hasMoreClasses = this.localCache.currentClassesBatch < this.localCache.classesTotalBatches;
        this.showStudentsPagination = this.studentsTotal > 0;
        this.showClassesPagination = this.classesTotal > 0;
        
        console.log('Á¨¨‰∏ÄÊâπÊï∞ÊçÆÂä†ËΩΩÂÆåÊàêÔºåÂºÄÂßãÊòæÁ§∫');
        
      } catch (error) {
        console.error('Âä†ËΩΩÁ¨¨‰∏ÄÊâπÊï∞ÊçÆÂ§±Ë¥•:', error);
        throw error;
      }
    },
    
    // ÂêéÂè∞Âä†ËΩΩÂâ©‰ΩôÊâπÊ¨°Êï∞ÊçÆ
    async loadRemainingBatchesInBackground() {
      try {
        console.log('ÂºÄÂßãÂêéÂè∞Âä†ËΩΩÂâ©‰ΩôÊâπÊ¨°Êï∞ÊçÆ');
        this.localCache.isLoadingBackground = true;
        this.localCache.backgroundLoadProgress = 0;
        
        const totalBatches = this.localCache.studentsTotalBatches + this.localCache.classesTotalBatches;
        let loadedBatches = 0;
        
        // Âä†ËΩΩÂâ©‰ΩôÂ≠¶ÁîüÊï∞ÊçÆÊâπÊ¨°
        for (let batchIndex = 1; batchIndex < this.localCache.studentsTotalBatches; batchIndex++) {
          try {
            const page = batchIndex + 1; // Á¨¨2È°µÂºÄÂßã
            const result = await uniCloud.callFunction({
              name: 'archive-manager',
              data: {
                action: 'getStudents',
                page: page,
                pageSize: this.localCache.studentsBatchSize
              }
            });
            
            if (result.result.code === 0) {
              const batchData = result.result.data || [];
              // Á°Æ‰øùÊâπÊ¨°Êï∞ÁªÑÂ≠òÂú®
              if (!this.localCache.studentsBatches) {
                this.localCache.studentsBatches = [];
              }
              this.localCache.studentsBatches[batchIndex] = batchData;
              this.localCache.currentStudentsBatch = batchIndex + 1;
              console.log(`Â≠¶ÁîüÊï∞ÊçÆÁ¨¨${batchIndex + 1}ÊâπÂä†ËΩΩÂÆåÊàê:`, batchData.length, 'Êù°');
              console.log('Â≠¶ÁîüÊâπÊ¨°Êï∞ÁªÑÊõ¥Êñ∞:', this.localCache.studentsBatches);
            }
            
            loadedBatches++;
            this.localCache.backgroundLoadProgress = Math.round((loadedBatches / totalBatches) * 100);
            
            // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÁºìÂ≠òÊï∞ÊçÆÂà∞Êú¨Âú∞Â≠òÂÇ®
            this.saveCacheToStorage();
            
            // Ê∑ªÂä†Â∞èÂª∂ËøüÔºåÈÅøÂÖçËØ∑Ê±ÇËøá‰∫éÈ¢ëÁπÅ
            await new Promise(resolve => setTimeout(resolve, 200));
          } catch (error) {
            console.error(`Âä†ËΩΩÂ≠¶ÁîüÊï∞ÊçÆÁ¨¨${batchIndex + 1}ÊâπÂ§±Ë¥•:`, error);
          }
        }
        
        // Âä†ËΩΩÂâ©‰ΩôÁè≠Á∫ßÊï∞ÊçÆÊâπÊ¨°
        for (let batchIndex = 1; batchIndex < this.localCache.classesTotalBatches; batchIndex++) {
          try {
            const page = batchIndex + 1; // Á¨¨2È°µÂºÄÂßã
            const result = await uniCloud.callFunction({
              name: 'archive-manager',
              data: {
                action: 'getClasses',
                page: page,
                pageSize: this.localCache.classesBatchSize
              }
            });
            
            if (result.result.code === 0) {
              const batchData = result.result.data || [];
              // Á°Æ‰øùÊâπÊ¨°Êï∞ÁªÑÂ≠òÂú®
              if (!this.localCache.classesBatches) {
                this.localCache.classesBatches = [];
              }
              this.localCache.classesBatches[batchIndex] = batchData;
              this.localCache.currentClassesBatch = batchIndex + 1;
              console.log(`Áè≠Á∫ßÊï∞ÊçÆÁ¨¨${batchIndex + 1}ÊâπÂä†ËΩΩÂÆåÊàê:`, batchData.length, 'Êù°');
              console.log('Áè≠Á∫ßÊâπÊ¨°Êï∞ÁªÑÊõ¥Êñ∞:', this.localCache.classesBatches);
            }
            
            loadedBatches++;
            this.localCache.backgroundLoadProgress = Math.round((loadedBatches / totalBatches) * 100);
            
            // ‰øùÂ≠òÊõ¥Êñ∞ÂêéÁöÑÁºìÂ≠òÊï∞ÊçÆÂà∞Êú¨Âú∞Â≠òÂÇ®
            this.saveCacheToStorage();
            
            // Ê∑ªÂä†Â∞èÂª∂ËøüÔºåÈÅøÂÖçËØ∑Ê±ÇËøá‰∫éÈ¢ëÁπÅ
            await new Promise(resolve => setTimeout(resolve, 200));
          } catch (error) {
            console.error(`Âä†ËΩΩÁè≠Á∫ßÊï∞ÊçÆÁ¨¨${batchIndex + 1}ÊâπÂ§±Ë¥•:`, error);
          }
        }
        
        this.localCache.backgroundLoadProgress = 100;
        console.log('ÊâÄÊúâÊâπÊ¨°Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê');
        
        // ÂêéÂè∞Âä†ËΩΩÂÆåÊàêÂêéÊõ¥Êñ∞ÊòæÁ§∫Êï∞ÊçÆ
        this.loadFromCache();
        
      } catch (error) {
        console.error('ÂêéÂè∞Âä†ËΩΩÂâ©‰ΩôÊâπÊ¨°Êï∞ÊçÆÂ§±Ë¥•:', error);
      } finally {
        this.localCache.isLoadingBackground = false;
      }
    },
    
    
    
    // Â∫îÁî®Á≠õÈÄâÊù°‰ª∂
    applyFilters() {
      console.log('ÂºÄÂßãÂ∫îÁî®Á≠õÈÄâÊù°‰ª∂');
      console.log('localCache.allStudents:', this.localCache.allStudents?.length || 0);
      console.log('localCache.allClasses:', this.localCache.allClasses?.length || 0);
      
      // Êõ¥Êñ∞ÊÄªÊï∞ÔºàÁî®‰∫éÂàÜÈ°µËÆ°ÁÆóÔºâ
      this.studentsTotal = this.filteredStudents.length;
      this.classesTotal = this.filteredClasses.length;
      
      console.log('Á≠õÈÄâÂêéÂ≠¶ÁîüÊÄªÊï∞:', this.studentsTotal);
      console.log('Á≠õÈÄâÂêéÁè≠Á∫ßÊÄªÊï∞:', this.classesTotal);
      console.log('ÂàÜÈ°µÂêéÂ≠¶ÁîüÊï∞ÊçÆ:', this.paginatedStudents.length);
      console.log('ÂàÜÈ°µÂêéÁè≠Á∫ßÊï∞ÊçÆ:', this.paginatedClasses.length);
      
      // Êõ¥Êñ∞ÂàÜÈ°µ‰ø°ÊÅØ
      this.hasMoreStudents = this.studentsTotal > this.studentsPageSize;
      this.hasMoreClasses = this.classesTotal > this.classesPageSize;
      this.showStudentsPagination = this.studentsTotal > 0;
      this.showClassesPagination = this.classesTotal > 0;
      
      console.log('Á≠õÈÄâÂÆåÊàê - Â≠¶ÁîüÊÄªÊï∞:', this.studentsTotal, 'Áè≠Á∫ßÊÄªÊï∞:', this.classesTotal);
      console.log('Â≠¶ÁîüÈ°µÊï∞:', this.studentsPage, 'Áè≠Á∫ßÈ°µÊï∞:', this.classesPage);
      console.log('ÊòæÁ§∫Â≠¶ÁîüÂàÜÈ°µ:', this.showStudentsPagination, 'ÊòæÁ§∫Áè≠Á∫ßÂàÜÈ°µ:', this.showClassesPagination);
    },
    
    // Ê∑ªÂä†Êñ∞Â≠¶ÁîüÂà∞Êú¨Âú∞ÁºìÂ≠ò
    addStudentToCache(student) {
      this.localCache.allStudents.push(student);
      this.applyFilters();
    },
    
    // Ê∑ªÂä†Êñ∞Áè≠Á∫ßÂà∞Êú¨Âú∞ÁºìÂ≠ò
    addClassToCache(classItem) {
      this.localCache.allClasses.push(classItem);
      this.applyFilters();
    },
    
    // ‰ªéÊú¨Âú∞ÁºìÂ≠òÂà†Èô§Â≠¶Áîü
    removeStudentFromCache(studentId) {
      this.localCache.allStudents = this.localCache.allStudents.filter(s => s.studentId !== studentId);
      this.applyFilters();
    },
    
    // ‰ªéÊú¨Âú∞ÁºìÂ≠òÂà†Èô§Áè≠Á∫ß
    removeClassFromCache(classId) {
      this.localCache.allClasses = this.localCache.allClasses.filter(c => c._id !== classId);
      this.applyFilters();
    },
    
    // Âà∑Êñ∞Êú¨Âú∞ÁºìÂ≠òÔºàÈáçÊñ∞‰ªéÊï∞ÊçÆÂ∫ìÂä†ËΩΩÔºâ
    async refreshCache() {
      this.localCache.isLoaded = false;
      await this.loadAllData();
    },
    
    // Âä†ËΩΩÊåáÂÆöÈ°µÁöÑÂ≠¶ÁîüÊï∞ÊçÆÔºà‰ΩøÁî®Êú¨Âú∞ÁºìÂ≠òÔºâ
    loadStudentsPage(page) {
      this.studentsPage = page;
      this.hasMoreStudents = this.studentsPage < Math.ceil(this.studentsTotal / this.studentsPageSize);
      
      // ‰ΩøÁî®Êú¨Âú∞ÁºìÂ≠òÊï∞ÊçÆÂ∫îÁî®Á≠õÈÄâÂíåÂàÜÈ°µ
      this.applyFilters();
      
      console.log(`ÂàáÊç¢Âà∞Á¨¨${page}È°µÂ≠¶ÁîüÊï∞ÊçÆ:`, this.students.length, 'Êù°');
    },
    
    // Âä†ËΩΩÊåáÂÆöÈ°µÁöÑÁè≠Á∫ßÊï∞ÊçÆÔºà‰ΩøÁî®Êú¨Âú∞ÁºìÂ≠òÔºâ
    loadClassesPage(page) {
      this.classesPage = page;
      this.hasMoreClasses = this.classesPage < Math.ceil(this.classesTotal / this.classesPageSize);
      
      // ‰ΩøÁî®Êú¨Âú∞ÁºìÂ≠òÊï∞ÊçÆÂ∫îÁî®Á≠õÈÄâÂíåÂàÜÈ°µ
      this.applyFilters();
      
      console.log(`ÂàáÊç¢Âà∞Á¨¨${page}È°µÁè≠Á∫ßÊï∞ÊçÆ:`, this.classes.length, 'Êù°');
    },
    
    // ‰∏ä‰∏ÄÈ°µ
    prevPage(type) {
      if (type === 'students' && this.studentsPage > 1) {
        this.loadStudentsPage(this.studentsPage - 1);
      } else if (type === 'classes' && this.classesPage > 1) {
        this.loadClassesPage(this.classesPage - 1);
      }
    },
    
    // ‰∏ã‰∏ÄÈ°µ
    nextPage(type) {
      if (type === 'students') {
        if (this.hasMoreStudents) {
          this.loadStudentsPage(this.studentsPage + 1);
        } else {
          uni.showToast({
            title: 'ÂΩìÂâçÂ∑≤ÊòØÊúÄÂêé‰∏ÄÈ°µ',
            icon: 'none',
            duration: 1500
          });
        }
      } else if (type === 'classes') {
        if (this.hasMoreClasses) {
          this.loadClassesPage(this.classesPage + 1);
        } else {
          uni.showToast({
            title: 'ÂΩìÂâçÂ∑≤ÊòØÊúÄÂêé‰∏ÄÈ°µ',
            icon: 'none',
            duration: 1500
          });
        }
      }
    },
    
    
    navigateToStudentDetail(student) {
      uni.navigateTo({
        url: `/pages/student-detail/student-detail?studentId=${student.studentId}`
      });
    },
    navigateToClassDetail(classItem) {
      uni.navigateTo({
        url: `/pages/class-detail/class-detail?classId=${classItem._id}`
      });
    },
    formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    },
    // ÁºñËæëÊ®°ÂºèÁõ∏ÂÖ≥ÊñπÊ≥ï
    enterEditMode() {
      this.isEditMode = true;
      this.selectedItems = [];
    },
    exitEditMode() {
      this.isEditMode = false;
      this.selectedItems = [];
    },
    toggleSelectAll() {
      const currentItems = this.activeTab === 'students' ? this.filteredStudents : 
                          this.activeTab === 'classes' ? this.filteredClasses : 
                          [...this.filteredStudents, ...this.filteredClasses];
      
      if (this.isAllSelected) {
        this.selectedItems = [];
      } else {
        this.selectedItems = [...currentItems];
      }
    },
    isStudentSelected(student) {
      return this.selectedItems.some(item => item._id === student._id);
    },
    isClassSelected(classItem) {
      return this.selectedItems.some(item => item._id === classItem._id);
    },
    toggleStudentSelection(student) {
      const index = this.selectedItems.findIndex(item => item._id === student._id);
      if (index > -1) {
        this.selectedItems.splice(index, 1);
      } else {
        this.selectedItems.push(student);
      }
    },
    toggleClassSelection(classItem) {
      const index = this.selectedItems.findIndex(item => item._id === classItem._id);
      if (index > -1) {
        this.selectedItems.splice(index, 1);
      } else {
        this.selectedItems.push(classItem);
      }
    },
    // Âà†Èô§Áõ∏ÂÖ≥ÊñπÊ≥ï
    showDeleteConfirm(item, type) {
      this.deleteTarget = item;
      this.deleteType = type;
      this.deleteMessage = `Á°ÆÂÆöË¶ÅÂà†Èô§${type === 'student' ? 'Â≠¶Áîü' : 'Áè≠Á∫ß'} "${item.name || item.className}" ÂêóÔºü`;
      this.showDeleteModal = true;
    },
    showBatchDeleteConfirm() {
      if (this.selectedItems.length === 0) return;
      
      this.deleteTarget = this.selectedItems;
      this.deleteType = 'batch';
      this.deleteMessage = `Á°ÆÂÆöË¶ÅÂà†Èô§ÈÄâ‰∏≠ÁöÑ ${this.selectedItems.length} È°πÂêóÔºü`;
      this.showDeleteModal = true;
    },
    closeDeleteModal() {
      this.showDeleteModal = false;
      this.deleteTarget = null;
      this.deleteType = '';
      this.deleteMessage = '';
    },
    async confirmDelete() {
      try {
        if (this.deleteType === 'batch') {
          await this.batchDelete();
        } else {
          await this.singleDelete();
        }
        this.closeDeleteModal();
        this.loadData(); // ÈáçÊñ∞Âä†ËΩΩÊï∞ÊçÆ
        uni.showToast({
          title: 'Âà†Èô§ÊàêÂäü',
          icon: 'success'
        });
      } catch (error) {
        console.error('Âà†Èô§Â§±Ë¥•:', error);
        uni.showToast({
          title: 'Âà†Èô§Â§±Ë¥•',
          icon: 'error'
        });
      }
    },
    async singleDelete() {
      const { deleteTarget, deleteType } = this;
      
      if (deleteType === 'student') {
        await uniCloud.callFunction({
          name: 'archive-manager',
          data: {
            action: 'deleteStudent',
            studentId: deleteTarget.studentId
          }
        });
      } else if (deleteType === 'class') {
        await uniCloud.callFunction({
          name: 'archive-manager',
          data: {
            action: 'deleteClass',
            classId: deleteTarget._id
          }
        });
      }
    },
    async batchDelete() {
      const students = this.selectedItems.filter(item => this.students.some(s => s._id === item._id));
      const classes = this.selectedItems.filter(item => this.classes.some(c => c._id === item._id));
      
      // ÊâπÈáèÂà†Èô§Â≠¶Áîü
      if (students.length > 0) {
        await uniCloud.callFunction({
          name: 'archive-manager',
          data: {
            action: 'batchDeleteStudents',
            studentIds: students.map(s => s.studentId)
          }
        });
      }
      
      // ÊâπÈáèÂà†Èô§Áè≠Á∫ß
      if (classes.length > 0) {
        await uniCloud.callFunction({
          name: 'archive-manager',
          data: {
            action: 'batchDeleteClasses',
            classIds: classes.map(c => c._id)
          }
        });
      }
      
      this.selectedItems = [];
    }
  }
}
</script>

<style scoped>
.container {
  padding: 20rpx;
  background: #f8f8f8;
  min-height: 100vh;
  padding-top: 120rpx;
  /* ‰∏∫Â∫ïÈÉ®Â∑•ÂÖ∑Ê†èÁïôÂá∫Á©∫Èó¥ */
  padding-bottom: 120rpx;
}

/* Ëá™ÂÆö‰πâÂØºËà™Ê†èÊ†∑Âºè */
.custom-navbar {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 999;
  background: #fff;
  border-bottom: 1rpx solid #e5e5e5;
}

.navbar-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  height: 88rpx;
  padding: 0 30rpx;
  padding-top: var(--status-bar-height, 0);
}

.navbar-left {
  display: flex;
  align-items: center;
  padding: 10rpx 0;
}

.back-icon {
  font-size: 40rpx;
  color: #333;
  margin-right: 8rpx;
  font-weight: bold;
}

.back-text {
  font-size: 28rpx;
  color: #333;
}

.navbar-title {
  font-size: 32rpx;
  font-weight: bold;
  color: #333;
}

.navbar-right {
  width: 100rpx;
}

/* ÊêúÁ¥¢Ê†èÊ†∑Âºè */
.search-container {
  margin-bottom: 20rpx;
}

.search-bar {
  display: flex;
  align-items: center;
  background: #fff;
  border-radius: 12rpx;
  padding: 20rpx;
  box-shadow: 0 2rpx 8rpx rgba(0,0,0,0.1);
}

.search-icon {
  font-size: 28rpx;
  color: #999;
  margin-right: 15rpx;
}

.search-input {
  flex: 1;
  font-size: 28rpx;
  color: #333;
}

.clear-btn {
  width: 40rpx;
  height: 40rpx;
  border-radius: 50%;
  background: #f0f0f0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.clear-icon {
  font-size: 24rpx;
  color: #999;
}

/* ÂàÜÁ±ªÊ†áÁ≠æÊ†∑Âºè */
.category-tabs {
  display: flex;
  background: #fff;
  border-radius: 12rpx;
  padding: 8rpx;
  margin-bottom: 20rpx;
  box-shadow: 0 2rpx 8rpx rgba(0,0,0,0.1);
}

.category-tab {
  flex: 1;
  text-align: center;
  padding: 20rpx 0;
  font-size: 28rpx;
  color: #666;
  border-radius: 8rpx;
  transition: all 0.3s;
}

.category-tab.active {
  background: #4FC3F7;
  color: #fff;
  font-weight: bold;
}

/* ÊâπÈáèÊìç‰ΩúÂ∑•ÂÖ∑Ê†èÊ†∑Âºè - Âõ∫ÂÆöÂú®Â∫ïÈÉ® */
.batch-toolbar-fixed {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: #fff;
  padding: 20rpx 30rpx;
  border-top: 1rpx solid #e5e5e5;
  box-shadow: 0 -2rpx 8rpx rgba(0,0,0,0.1);
  /* ‰∏∫Â∫ïÈÉ®Â∑•ÂÖ∑Ê†èÁïôÂá∫Á©∫Èó¥ */
  padding-bottom: calc(20rpx + env(safe-area-inset-bottom));
}

.toolbar-left {
  display: flex;
  align-items: center;
  gap: 20rpx;
}

.select-all-btn {
  padding: 10rpx 20rpx;
  background: #4FC3F7;
  color: #fff;
  border-radius: 6rpx;
  font-size: 24rpx;
}

.selected-count {
  font-size: 26rpx;
  color: #666;
}

.toolbar-right {
  display: flex;
  gap: 15rpx;
}

.batch-delete-btn,
.exit-edit-btn {
  padding: 10rpx 20rpx;
  border-radius: 6rpx;
  font-size: 24rpx;
  border: none;
}

.batch-delete-btn {
  background: #ff6b6b;
  color: #fff;
}

.batch-delete-btn:disabled {
  background: #ccc;
}

.exit-edit-btn {
  background: #4FC3F7;
  color: #fff;
}

/* ÁºñËæëÊ®°ÂºèÂàáÊç¢ÊåâÈíÆ */
.edit-mode-toggle {
  position: fixed;
  bottom: 30rpx;
  right: 30rpx;
  z-index: 100;
}

.edit-mode-btn {
  width: 100rpx;
  height: 100rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s;
}

.edit-mode-btn:active {
  transform: scale(0.95);
}

.edit-icon {
  width: 100rpx;
  height: 100rpx;
}

/* Á≠õÈÄâÊù°‰ª∂Ê†∑Âºè */
.filter-container {
  background: #fff;
  border-radius: 12rpx;
  padding: 20rpx;
  margin-bottom: 20rpx;
  box-shadow: 0 2rpx 8rpx rgba(0,0,0,0.1);
}

.filter-row {
  display: flex;
  align-items: center;
  gap: 20rpx;
}

.filter-item {
  flex: 1;
  display: flex;
  align-items: center;
}

.filter-label {
  font-size: 26rpx;
  color: #333;
  margin-right: 10rpx;
  min-width: 100rpx;
}

.filter-picker {
  flex: 1;
  padding: 15rpx 20rpx;
  border: 1rpx solid #e5e5e5;
  border-radius: 8rpx;
  font-size: 26rpx;
  color: #333;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.picker-arrow {
  font-size: 20rpx;
  color: #999;
}

/* Êï∞ÊçÆÂÆπÂô®Ê†∑Âºè */
.data-container {
  margin-bottom: 20rpx;
}

.loading-container {
  text-align: center;
  padding: 60rpx 0;
}

.loading-text {
  font-size: 28rpx;
  color: #999;
}

/* ÂàÜÁªÑÊ†∑Âºè */
.section {
  margin-bottom: 30rpx;
}

.section-title {
  margin-bottom: 20rpx;
}

.title-text {
  font-size: 30rpx;
  font-weight: bold;
  color: #333;
}

/* Â≠¶ÁîüÂç°ÁâáÊ†∑Âºè */
.student-list {
  background: #fff;
  border-radius: 12rpx;
  overflow: hidden;
  box-shadow: 0 2rpx 8rpx rgba(0,0,0,0.1);
}

.student-card {
  display: flex;
  align-items: center;
  padding: 25rpx;
  border-bottom: 1rpx solid #f0f0f0;
  transition: all 0.3s;
}

.student-card:last-child {
  border-bottom: none;
}

.student-card.selected {
  background: #f0f8ff;
  border-left: 4rpx solid #4FC3F7;
}

/* ÈÄâÊã©Ê°ÜÊ†∑Âºè */
.selection-checkbox {
  margin-right: 20rpx;
}

.checkbox {
  width: 40rpx;
  height: 40rpx;
  border: 2rpx solid #ddd;
  border-radius: 6rpx;
  display: flex;
  align-items: center;
  justify-content: center;
  background: #fff;
}

.checkbox.checked {
  background: #4FC3F7;
  border-color: #4FC3F7;
}

.check-icon {
  font-size: 24rpx;
  color: #fff;
  font-weight: bold;
}

/* ÁºñËæëÊìç‰ΩúÊåâÈíÆ */
.edit-actions {
  display: flex;
  gap: 10rpx;
}

.delete-btn {
  padding: 8rpx 16rpx;
  background: #ff6b6b;
  color: #fff;
  border: none;
  border-radius: 6rpx;
  font-size: 22rpx;
}

.student-avatar {
  width: 80rpx;
  height: 80rpx;
  border-radius: 50%;
  background: #4FC3F7;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 20rpx;
}

.avatar-text {
  font-size: 32rpx;
  color: #fff;
  font-weight: bold;
}

.student-info {
  flex: 1;
}

.student-header {
  display: flex;
  align-items: center;
  margin-bottom: 8rpx;
}

.student-name {
  font-size: 30rpx;
  font-weight: bold;
  color: #333;
  margin-right: 15rpx;
}

.student-id {
  font-size: 24rpx;
  color: #4FC3F7;
  background: #f0f8ff;
  padding: 4rpx 12rpx;
  border-radius: 6rpx;
}

.student-details {
  margin-bottom: 8rpx;
}

.student-grade,
.student-subjects,
.student-school {
  font-size: 24rpx;
  color: #666;
  margin-right: 15rpx;
}

.student-meta {
  display: flex;
  align-items: center;
}

.create-time,
.create-by {
  font-size: 22rpx;
  color: #999;
  margin-right: 15rpx;
}

.student-actions {
  margin-left: 15rpx;
}

.action-icon {
  font-size: 28rpx;
  color: #ccc;
}

/* Áè≠Á∫ßÂç°ÁâáÊ†∑Âºè */
.class-list {
  background: #fff;
  border-radius: 12rpx;
  overflow: hidden;
  box-shadow: 0 2rpx 8rpx rgba(0,0,0,0.1);
}

.class-card {
  display: flex;
  align-items: center;
  padding: 25rpx;
  border-bottom: 1rpx solid #f0f0f0;
  transition: all 0.3s;
}

.class-card:last-child {
  border-bottom: none;
}

.class-card.selected {
  background: #f0f8ff;
  border-left: 4rpx solid #4FC3F7;
}

.class-icon {
  width: 80rpx;
  height: 80rpx;
  border-radius: 12rpx;
  background: #9C27B0;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 20rpx;
}

.class-icon-text {
  font-size: 28rpx;
  color: #fff;
  font-weight: bold;
}

.class-info {
  flex: 1;
}

.class-header {
  display: flex;
  align-items: center;
  margin-bottom: 8rpx;
}

.class-name {
  font-size: 30rpx;
  font-weight: bold;
  color: #333;
  margin-right: 15rpx;
}

.class-code {
  font-size: 24rpx;
  color: #9C27B0;
  background: #f3e5f5;
  padding: 4rpx 12rpx;
  border-radius: 6rpx;
}

.class-details {
  margin-bottom: 8rpx;
}

.class-grade,
.class-teacher,
.class-student-count {
  font-size: 24rpx;
  color: #666;
  margin-right: 15rpx;
}

.class-meta {
  display: flex;
  align-items: center;
}

.class-actions {
  margin-left: 15rpx;
}

/* Á©∫Áä∂ÊÄÅÊ†∑Âºè */
.empty-state {
  text-align: center;
  padding: 80rpx 0;
  background: #fff;
  border-radius: 12rpx;
  box-shadow: 0 2rpx 8rpx rgba(0,0,0,0.1);
}

.empty-text {
  font-size: 28rpx;
  color: #999;
}

/* ÂêéÂè∞Âä†ËΩΩËøõÂ∫¶ÊåáÁ§∫Âô®Ê†∑Âºè */
.background-loading-indicator {
  background: #f0f8ff;
  border: 1rpx solid #e3f2fd;
  border-radius: 8rpx;
  margin: 20rpx;
  padding: 20rpx;
}

.loading-progress {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.loading-text {
  color: #1976d2;
  font-size: 24rpx;
  margin-bottom: 10rpx;
}

.progress-bar {
  width: 100%;
  height: 6rpx;
  background: #e0e0e0;
  border-radius: 3rpx;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #1976d2, #42a5f5);
  border-radius: 3rpx;
  transition: width 0.3s ease;
}

/* ÂàÜÈ°µÊéß‰ª∂Ê†∑Âºè */
.pagination-container {
  background: #f8f9fa;
  border: 1rpx solid #e9ecef;
  border-radius: 8rpx;
  margin: 20rpx;
  padding: 20rpx;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.pagination-info {
  flex: 1;
}

.pagination-text {
  color: #666;
  font-size: 26rpx;
}

.pagination-buttons {
  display: flex;
  gap: 20rpx;
}

.pagination-btn {
  background: #007bff;
  color: white;
  border: none;
  border-radius: 6rpx;
  padding: 12rpx 24rpx;
  font-size: 26rpx;
  min-width: 120rpx;
}

.pagination-btn:disabled {
  background: #ccc;
  color: #999;
}

.pagination-btn:not(:disabled):active {
  background: #0056b3;
}


/* Âà†Èô§Á°ÆËÆ§ÂºπÁ™óÊ†∑Âºè */
.delete-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0,0,0,0.5);
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40rpx;
}

.delete-modal-content {
  background: #fff;
  border-radius: 16rpx;
  width: 100%;
  max-width: 600rpx;
  overflow: hidden;
}

.delete-header {
  padding: 30rpx;
  border-bottom: 1rpx solid #f0f0f0;
  text-align: center;
}

.delete-title {
  font-size: 32rpx;
  font-weight: bold;
  color: #333;
}

.delete-body {
  padding: 30rpx;
  text-align: center;
}

.delete-message {
  font-size: 28rpx;
  color: #666;
  line-height: 1.5;
}

.delete-footer {
  display: flex;
  padding: 30rpx;
  gap: 20rpx;
  border-top: 1rpx solid #f0f0f0;
}

.cancel-delete-btn,
.confirm-delete-btn {
  flex: 1;
  height: 80rpx;
  border-radius: 8rpx;
  font-size: 28rpx;
  font-weight: bold;
  border: none;
}

.cancel-delete-btn {
  background: #f0f0f0;
  color: #666;
}

.confirm-delete-btn {
  background: #ff6b6b;
  color: #fff;
}
</style>
