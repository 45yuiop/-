(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/class-management/class-management"],{"25ab":function(e,t,s){"use strict";(function(e,a){var r=s("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=r(s("7eb4")),c=r(s("af34")),l=r(s("ee10")),o={data:function(){return{classList:[],filteredClassList:[],teacherList:[],showAddClassModalFlag:!1,showClassDetailModal:!1,showAddTeacherModalFlag:!1,showReplaceTeacherModalFlag:!1,showAddStudentModalFlag:!1,showToast:!1,toastMessage:"",newClass:{className:"",grade:"",teachers:[]},currentClass:{className:"",teachers:[],students:[]},newStudent:{studentName:"",grade:""},selectedTeachers:[],teacherToAdd:null,teacherToReplace:null,studentList:[],filteredStudentList:[],studentSearchKeyword:"",selectedStudents:[],filteredTeacherList:[],teacherSearchKeyword:"",filteredTeachers:[],searchKeyword:"",gradeIndex:0,subjectIndex:0,gradeOptions:["全部年级","一年级","二年级","三年级","四年级","五年级","六年级","七年级","八年级","九年级","高一","高二","高三"],subjectOptions:["全部科目","语文","数学","英语","物理","化学"]}},onLoad:function(){this.loadClassList(),this.loadTeacherList(),this.loadStudentList()},computed:{},watch:{searchKeyword:function(){this.filterClassList()},gradeIndex:function(){this.filterClassList()},subjectIndex:function(){this.filterClassList()}},methods:{goBack:function(){e.navigateBack()},loadClassList:function(){var e=this;return(0,l.default)(n.default.mark((function t(){var s;return n.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,console.log("开始加载班级列表..."),t.next=4,a.callFunction({name:"class-management",data:{action:"getClasses",page:1,pageSize:1e3}});case 4:s=t.sent,console.log("班级列表云函数返回结果:",s),0===s.result.code?(e.classList=s.result.data||[],console.log("班级列表加载成功，数量:",e.classList.length),console.log("班级列表数据:",e.classList),e.classList.length>0&&(console.log("第一个班级的teachers信息:",e.classList[0].teachers),console.log("第一个班级的headTeacher:",e.classList[0].headTeacher)),e.filterClassList()):(console.error("加载班级列表失败:",s.result.message),e.showToastMessage("加载班级列表失败: "+s.result.message)),t.next=13;break;case 9:t.prev=9,t.t0=t["catch"](0),console.error("加载班级列表失败:",t.t0),e.showToastMessage("加载班级列表失败: "+t.t0.message);case 13:case"end":return t.stop()}}),t,null,[[0,9]])})))()},filterClassList:function(){var e=(0,c.default)(this.classList);if(this.searchKeyword.trim()){var t=this.searchKeyword.toLowerCase().trim();e=e.filter((function(e){return e.className&&e.className.toLowerCase().includes(t)}))}if(this.gradeIndex>0){var s=this.gradeOptions[this.gradeIndex];e=e.filter((function(e){return e.grade===s}))}if(this.subjectIndex>0){var a=this.subjectOptions[this.subjectIndex];e=e.filter((function(e){return e.className&&e.className.includes(a)}))}this.filteredClassList=e},onSearchInput:function(){},onGradeChange:function(e){this.gradeIndex=e.detail.value},onSubjectChange:function(e){this.subjectIndex=e.detail.value},highlightText:function(e,t){if(!e)return"";if(!t||!t.trim())return e;var s=new RegExp("(".concat(t.trim(),")"),"gi");return e.replace(s,'<span class="highlight">$1</span>')},loadTeacherList:function(){var e=this;return(0,l.default)(n.default.mark((function t(){var s;return n.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,console.log("开始加载教师列表..."),t.next=4,a.callFunction({name:"class-management",data:{action:"getTeacherList"}});case 4:s=t.sent,console.log("教师列表云函数返回结果:",s),0===s.result.code?(e.teacherList=s.result.data,e.filteredTeacherList=(0,c.default)(s.result.data),e.filteredTeachers=(0,c.default)(s.result.data),console.log("教师列表加载成功，数量:",e.teacherList.length),console.log("教师列表数据:",e.teacherList)):(console.error("加载教师列表失败:",s.result.message),e.showToastMessage("加载老师列表失败: "+s.result.message)),t.next=13;break;case 9:t.prev=9,t.t0=t["catch"](0),console.error("加载老师列表失败:",t.t0),e.showToastMessage("加载老师列表失败: "+t.t0.message);case 13:case"end":return t.stop()}}),t,null,[[0,9]])})))()},showAddClassModal:function(){this.showAddClassModalFlag=!0,this.newClass={className:"",teachers:[]},this.selectedTeachers=[],this.teacherSearchKeyword="",this.filteredTeachers=(0,c.default)(this.teacherList)},closeAddClassModal:function(){this.showAddClassModalFlag=!1},onTeacherSearchInput:function(){if(console.log("老师搜索输入:",this.teacherSearchKeyword),console.log("当前教师列表长度:",this.teacherList.length),!this.teacherSearchKeyword.trim())return this.filteredTeachers=(0,c.default)(this.teacherList),void console.log("搜索关键词为空，显示所有教师:",this.filteredTeachers.length);var e=this.teacherSearchKeyword.toLowerCase().trim();this.filteredTeachers=this.teacherList.filter((function(t){var s=(t.teacherName||t.username||"").toLowerCase(),a=s.includes(e);return console.log("教师 ".concat(s," 匹配关键词 ").concat(e,":"),a),a})),console.log("搜索后过滤的教师数量:",this.filteredTeachers.length)},toggleTeacherSelection:function(e){var t=this.selectedTeachers.findIndex((function(t){return t._id===e._id}));t>-1?this.selectedTeachers.splice(t,1):this.selectedTeachers.push(e)},isSelectedTeacher:function(e){return this.selectedTeachers.some((function(t){return t._id===e._id}))},addClass:function(){var e=this;return(0,l.default)(n.default.mark((function t(){var s;return n.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.newClass.className){t.next=3;break}return e.showToastMessage("请输入班级名称"),t.abrupt("return");case 3:if(e.newClass.grade){t.next=6;break}return e.showToastMessage("请输入年级"),t.abrupt("return");case 6:return t.prev=6,t.next=9,a.callFunction({name:"class-management",data:{action:"createClass",className:e.newClass.className,grade:e.newClass.grade,teachers:e.selectedTeachers}});case 9:s=t.sent,0===s.result.code?(e.showToastMessage("班级创建成功"),e.closeAddClassModal(),e.loadClassList()):e.showToastMessage(s.result.message||"班级创建失败"),t.next=17;break;case 13:t.prev=13,t.t0=t["catch"](6),console.error("创建班级失败:",t.t0),e.showToastMessage("班级创建失败");case 17:case"end":return t.stop()}}),t,null,[[6,13]])})))()},openClassDetail:function(e){this.currentClass=JSON.parse(JSON.stringify(e)),this.showClassDetailModal=!0},closeClassDetailModal:function(){this.showClassDetailModal=!1},getTeacherNames:function(e){return e&&0!==e.length?e.map((function(e){return e.teacherName||e.username})).join(", "):"未设置"},getTeacherAvatarText:function(e){return e?e.teacherName&&e.teacherName.trim()?e.teacherName.trim().charAt(0):e.username&&e.username.trim()?e.username.trim().charAt(0):"师":"师"},showAddTeacherModal:function(){this.showAddTeacherModalFlag=!0,this.teacherToAdd=null,this.teacherSearchKeyword="",this.filteredTeacherList=(0,c.default)(this.teacherList)},closeAddTeacherModal:function(){this.showAddTeacherModalFlag=!1,this.teacherSearchKeyword=""},showReplaceTeacherModal:function(){this.showReplaceTeacherModalFlag=!0,this.teacherToReplace=null,this.teacherSearchKeyword="",this.filteredTeacherList=(0,c.default)(this.teacherList)},closeReplaceTeacherModal:function(){this.showReplaceTeacherModalFlag=!1,this.teacherSearchKeyword=""},filterTeachers:function(){if(this.teacherSearchKeyword.trim()){var e=this.teacherSearchKeyword.toLowerCase().trim();this.filteredTeacherList=this.teacherList.filter((function(t){var s=(t.teacherName||"").toLowerCase(),a=(t.username||"").toLowerCase();return s.includes(e)||a.includes(e)}))}else this.filteredTeacherList=(0,c.default)(this.teacherList)},selectTeacherToAdd:function(e){this.teacherToAdd=e},isTeacherToAddSelected:function(e){return this.teacherToAdd&&this.teacherToAdd._id===e._id},selectTeacherToReplace:function(e){this.teacherToReplace=e},isTeacherToReplaceSelected:function(e){return this.teacherToReplace&&this.teacherToReplace._id===e._id},addTeacherToClass:function(){var e=this;return(0,l.default)(n.default.mark((function t(){var s;return n.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.teacherToAdd){t.next=3;break}return e.showToastMessage("请选择要添加的老师"),t.abrupt("return");case 3:return t.prev=3,t.next=6,a.callFunction({name:"class-management",data:{action:"addTeacherToClass",classId:e.currentClass._id,teacher:e.teacherToAdd}});case 6:s=t.sent,0===s.result.code?(e.showToastMessage("老师添加成功"),e.closeAddTeacherModal(),e.currentClass.teachers||(e.currentClass.teachers=[]),e.currentClass.teachers.push(e.teacherToAdd),e.loadClassList()):e.showToastMessage(s.result.message||"添加老师失败"),t.next=14;break;case 10:t.prev=10,t.t0=t["catch"](3),console.error("添加老师到班级失败:",t.t0),e.showToastMessage("添加老师失败");case 14:case"end":return t.stop()}}),t,null,[[3,10]])})))()},replaceTeacher:function(){var e=this;return(0,l.default)(n.default.mark((function t(){var s;return n.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(e.teacherToReplace){t.next=3;break}return e.showToastMessage("请选择要替换的老师"),t.abrupt("return");case 3:return t.prev=3,t.next=6,a.callFunction({name:"class-management",data:{action:"replaceTeacher",classId:e.currentClass._id,newTeacher:e.teacherToReplace}});case 6:s=t.sent,0===s.result.code?(e.showToastMessage("老师替换成功"),e.closeReplaceTeacherModal(),e.currentClass.teachers=[e.teacherToReplace],e.loadClassList()):e.showToastMessage(s.result.message||"替换老师失败"),t.next=14;break;case 10:t.prev=10,t.t0=t["catch"](3),console.error("替换老师失败:",t.t0),e.showToastMessage("替换老师失败");case 14:case"end":return t.stop()}}),t,null,[[3,10]])})))()},removeTeacher:function(e){var t=this;return(0,l.default)(n.default.mark((function s(){var r,c;return n.default.wrap((function(s){while(1)switch(s.prev=s.next){case 0:return s.prev=0,s.next=3,a.callFunction({name:"class-management",data:{action:"removeTeacherFromClass",classId:t.currentClass._id,teacherId:e._id}});case 3:r=s.sent,0===r.result.code?(t.showToastMessage("老师移除成功"),c=t.currentClass.teachers.findIndex((function(t){return t._id===e._id})),c>-1&&t.currentClass.teachers.splice(c,1),t.loadClassList()):t.showToastMessage(r.result.message||"移除老师失败"),s.next=11;break;case 7:s.prev=7,s.t0=s["catch"](0),console.error("移除老师失败:",s.t0),t.showToastMessage("移除老师失败");case 11:case"end":return s.stop()}}),s,null,[[0,7]])})))()},showAddStudentModal:function(){this.showAddStudentModalFlag=!0,this.studentSearchKeyword="",this.selectedStudents=[],this.filteredStudentList=(0,c.default)(this.studentList)},closeAddStudentModal:function(){this.showAddStudentModalFlag=!1,this.studentSearchKeyword="",this.selectedStudents=[]},filterStudents:function(){if(this.studentSearchKeyword.trim()){var e=this.studentSearchKeyword.toLowerCase().trim();this.filteredStudentList=this.studentList.filter((function(t){var s=(t.name||"").toLowerCase(),a=(t.studentId||"").toLowerCase();return s.includes(e)||a.includes(e)}))}else this.filteredStudentList=(0,c.default)(this.studentList)},selectStudent:function(e){var t=this.selectedStudents.findIndex((function(t){return t._id===e._id}));t>-1?this.selectedStudents.splice(t,1):this.selectedStudents.push(e)},isStudentSelected:function(e){return this.selectedStudents.some((function(t){return t._id===e._id}))},loadStudentList:function(){var e=this;return(0,l.default)(n.default.mark((function t(){var s;return n.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return t.prev=0,t.next=3,a.callFunction({name:"student-manager",data:{action:"getStudents",page:1,pageSize:1e3}});case 3:s=t.sent,0===s.result.code?(e.studentList=s.result.data.list,e.filteredStudentList=(0,c.default)(s.result.data.list)):e.showToastMessage("加载学生列表失败"),t.next=11;break;case 7:t.prev=7,t.t0=t["catch"](0),console.error("加载学生列表失败:",t.t0),e.showToastMessage("加载学生列表失败");case 11:case"end":return t.stop()}}),t,null,[[0,7]])})))()},addSelectedStudentsToClass:function(){var e=this;return(0,l.default)(n.default.mark((function t(){var s,r,c;return n.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(0!==e.selectedStudents.length){t.next=3;break}return e.showToastMessage("请选择要添加的学生"),t.abrupt("return");case 3:return t.prev=3,s=e.selectedStudents.map((function(t){return a.callFunction({name:"class-management",data:{action:"addStudentToClass",classId:e.currentClass._id,studentId:t.studentId,studentName:t.name,grade:t.grade}})})),t.next=7,Promise.all(s);case 7:r=t.sent,c=r.filter((function(e){return 0===e.result.code})).length,c>0?(e.showToastMessage("成功添加 ".concat(c," 名学生")),e.closeAddStudentModal(),e.loadClassList(),e.loadStudentList()):e.showToastMessage("添加学生失败"),t.next=16;break;case 12:t.prev=12,t.t0=t["catch"](3),console.error("添加学生失败:",t.t0),e.showToastMessage("添加学生失败");case 16:case"end":return t.stop()}}),t,null,[[3,12]])})))()},removeStudent:function(e){var t=this;return(0,l.default)(n.default.mark((function s(){var r,c;return n.default.wrap((function(s){while(1)switch(s.prev=s.next){case 0:return s.prev=0,s.next=3,a.callFunction({name:"class-management",data:{action:"removeStudentFromClass",classId:t.currentClass._id,studentId:e._id}});case 3:r=s.sent,0===r.result.code?(t.showToastMessage("学生移除成功"),c=t.currentClass.students.findIndex((function(t){return t._id===e._id})),c>-1&&t.currentClass.students.splice(c,1),t.loadClassList()):t.showToastMessage(r.result.message||"移除学生失败"),s.next=11;break;case 7:s.prev=7,s.t0=s["catch"](0),console.error("移除学生失败:",s.t0),t.showToastMessage("移除学生失败");case 11:case"end":return s.stop()}}),s,null,[[0,7]])})))()},deleteClass:function(t){var s=this;return(0,l.default)(n.default.mark((function r(){return n.default.wrap((function(r){while(1)switch(r.prev=r.next){case 0:e.showModal({title:"确认删除",content:'确定要删除班级"'.concat(t.className,'"吗？此操作将删除该班级及其所有学生和老师关联。'),success:function(){var e=(0,l.default)(n.default.mark((function e(r){var c;return n.default.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(!r.confirm){e.next=12;break}return e.prev=1,e.next=4,a.callFunction({name:"class-management",data:{action:"deleteClass",classId:t._id}});case 4:c=e.sent,0===c.result.code?(s.showToastMessage("班级删除成功"),s.loadClassList()):(console.error("删除班级失败:",c.result),s.showToastMessage(c.result.message||"删除班级失败")),e.next=12;break;case 8:e.prev=8,e.t0=e["catch"](1),console.error("删除班级失败:",e.t0),s.showToastMessage("删除班级失败: "+e.t0.message);case 12:case"end":return e.stop()}}),e,null,[[1,8]])})));return function(t){return e.apply(this,arguments)}}()});case 1:case"end":return r.stop()}}),r)})))()},showToastMessage:function(e){var t=this;this.toastMessage=e,this.showToast=!0,setTimeout((function(){t.showToast=!1}),2e3)}}};t.default=o}).call(this,s("df3c")["default"],s("861b")["uniCloud"])},"41df":function(e,t,s){"use strict";(function(e,t){var a=s("47a9");s("a226"),s("861b");a(s("3240"));var r=a(s("aef7"));e.__webpack_require_UNI_MP_PLUGIN__=s,t(r.default)}).call(this,s("3223")["default"],s("df3c")["createPage"])},"42c3":function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"c",(function(){return r})),s.d(t,"a",(function(){}));var a=function(){var e=this,t=e.$createElement,s=(e._self._c,e.filteredClassList.length),a=e.__map(e.filteredClassList,(function(t,s){var a=e.__get_orig(t),r=t.students?t.students.length:null,n=t.teachers&&t.teachers.length>0,c=n?e.getTeacherNames(t.teachers):null;return{$orig:a,g1:r,g2:n,m0:c}})),r=e.showAddClassModalFlag?e.__map(e.filteredTeachers,(function(t,s){var a=e.__get_orig(t),r=e.isSelectedTeacher(t),n=e.getTeacherAvatarText(t),c=e.isSelectedTeacher(t);return{$orig:a,m1:r,m2:n,m3:c}})):null,n=e.showAddClassModalFlag?0===e.filteredTeachers.length&&e.teacherSearchKeyword:null,c=e.showClassDetailModal?e.__map(e.currentClass.teachers,(function(t,s){var a=e.__get_orig(t),r=e.getTeacherAvatarText(t);return{$orig:a,m4:r}})):null,l=e.showClassDetailModal?e.currentClass.teachers&&e.currentClass.teachers.length>0:null,o=e.showClassDetailModal?e.__map(e.currentClass.students,(function(t,s){var a=e.__get_orig(t),r=(t.name||"学").charAt(0);return{$orig:a,g5:r}})):null,i=e.showClassDetailModal?!e.currentClass.students||0===e.currentClass.students.length:null,d=e.showAddTeacherModalFlag?e.__map(e.filteredTeacherList,(function(t,s){var a=e.__get_orig(t),r=e.isTeacherToAddSelected(t),n=e.getTeacherAvatarText(t),c=e.isTeacherToAddSelected(t);return{$orig:a,m5:r,m6:n,m7:c}})):null,u=e.showAddTeacherModalFlag?0===e.filteredTeacherList.length&&e.teacherSearchKeyword:null,h=e.showAddTeacherModalFlag?0===e.filteredTeacherList.length&&!e.teacherSearchKeyword:null,f=e.showReplaceTeacherModalFlag?e.__map(e.filteredTeacherList,(function(t,s){var a=e.__get_orig(t),r=e.isTeacherToReplaceSelected(t),n=e.getTeacherAvatarText(t),c=e.isTeacherToReplaceSelected(t);return{$orig:a,m8:r,m9:n,m10:c}})):null,g=e.showReplaceTeacherModalFlag?0===e.filteredTeacherList.length&&e.teacherSearchKeyword:null,w=e.showReplaceTeacherModalFlag?0===e.filteredTeacherList.length&&!e.teacherSearchKeyword:null,T=e.showAddStudentModalFlag?e.__map(e.filteredStudentList,(function(t,s){var a=e.__get_orig(t),r=e.isStudentSelected(t),n=(t.name||"学").charAt(0),c=e.isStudentSelected(t);return{$orig:a,m11:r,g11:n,m12:c}})):null,m=e.showAddStudentModalFlag?0===e.filteredStudentList.length&&e.studentSearchKeyword:null,p=e.showAddStudentModalFlag?0===e.filteredStudentList.length&&!e.studentSearchKeyword:null,v=e.showAddStudentModalFlag?e.selectedStudents.length:null,S=e.showAddStudentModalFlag?e.selectedStudents.length:null;e.$mp.data=Object.assign({},{$root:{g0:s,l0:a,l1:r,g3:n,l2:c,g4:l,l3:o,g6:i,l4:d,g7:u,g8:h,l5:f,g9:g,g10:w,l6:T,g12:m,g13:p,g14:v,g15:S}})},r=[]},"515b":function(e,t,s){"use strict";s.r(t);var a=s("25ab"),r=s.n(a);for(var n in a)["default"].indexOf(n)<0&&function(e){s.d(t,e,(function(){return a[e]}))}(n);t["default"]=r.a},8990:function(e,t,s){"use strict";var a=s("cb1c"),r=s.n(a);r.a},aef7:function(e,t,s){"use strict";s.r(t);var a=s("42c3"),r=s("515b");for(var n in r)["default"].indexOf(n)<0&&function(e){s.d(t,e,(function(){return r[e]}))}(n);s("8990");var c=s("828b"),l=Object(c["a"])(r["default"],a["b"],a["c"],!1,null,"0cccd6b3",null,!1,a["a"],void 0);t["default"]=l.exports},cb1c:function(e,t,s){}},[["41df","common/runtime","common/vendor"]]]);