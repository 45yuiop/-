(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/admin-teacher-schedule/admin-teacher-schedule"],{"0770":function(e,t,a){"use strict";a.r(t);var n=a("4101"),r=a("f9c6");for(var o in r)["default"].indexOf(o)<0&&function(e){a.d(t,e,(function(){return r[e]}))}(o);a("ab61");var i=a("828b"),s=Object(i["a"])(r["default"],n["b"],n["c"],!1,null,"353b1f01",null,!1,n["a"],void 0);t["default"]=s.exports},4101:function(e,t,a){"use strict";a.d(t,"b",(function(){return n})),a.d(t,"c",(function(){return r})),a.d(t,"a",(function(){}));var n=function(){var e=this,t=e.$createElement,a=(e._self._c,e.__map(e.days,(function(t,a){var n=e.__get_orig(t),r=e.isToday(t.fullDate);return{$orig:n,m0:r}}))),n=e.__map(e.days,(function(t,a){var n=e.__get_orig(t),r=e.__map(e.coursesByDay[a],(function(a,n){var r=e.__get_orig(a),o=e.isLoading?null:e.canApplyChange(a,t.fullDate);return{$orig:r,m1:o}}));return{$orig:n,l1:r}}));e.$mp.data=Object.assign({},{$root:{l0:a,l2:n}})},r=[]},"8f98":function(e,t,a){"use strict";(function(e,t){var n=a("47a9");a("a226"),a("861b");n(a("3240"));var r=n(a("0770"));e.__webpack_require_UNI_MP_PLUGIN__=a,t(r.default)}).call(this,a("3223")["default"],a("df3c")["createPage"])},ab61:function(e,t,a){"use strict";var n=a("d462"),r=a.n(n);r.a},d462:function(e,t,a){},d70b:function(e,t,a){"use strict";(function(e,n){var r=a("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=r(a("7eb4")),i=r(a("ee10")),s=r(a("7ca3")),c=a("8bf8");function u(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?u(Object(a),!0).forEach((function(t){(0,s.default)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):u(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var h={data:function(){return{allTeacherList:[],teacherIndex:-1,searchKeyword:"",selectedTeacher:null,allCourses:[],isLoading:!0,isImageClicked:!1,periods:["8:00","10:00","10:10","12:10","14:00","16:00","16:10","18:10","18:00","20:00","20:00","22:00"],days:[],currentDate:function(){var e=new Date;e.setHours(0,0,0,0);var t=e.getDay(),a=0===t?6:t-1;return e.setDate(e.getDate()-a),e}(),isTeacher:!1,isSelf:!1,imageStartX:0,imageStartY:0,imageTranslateX:0,imageTranslateY:0,isImageDragging:!1,showBubble:!1,greetingText:""}},computed:{bubbleStyle:function(){var t=e.getWindowInfo?e.getWindowInfo():e.getSystemInfoSync(),a=t.windowWidth,n=t.windowHeight,r=.68*a,o=this.imageTranslateX-20,i=this.imageTranslateY-120;return o<10&&(o=10),o+r>a-10&&(o=a-r-10),i<10&&(i=10),i+120>n-10&&(i=this.imageTranslateY+120),"transform: translate(".concat(o,"px, ").concat(i,"px)")},isBubbleBelow:function(){var t=e.getWindowInfo?e.getWindowInfo():e.getSystemInfoSync(),a=t.windowHeight,n=this.imageTranslateY-120;return n+120>a-10},currentWeek:function(){var e=new Date(this.currentDate.getFullYear(),0,1),t=(this.currentDate-e)/864e5;return Math.ceil((t+e.getDay()+1)/7)},currentMonth:function(){var e=this.getMondayOfWeek(this.currentDate);return e.getMonth()+1},filteredTeacherList:function(){var e=this;return this.searchKeyword?this.allTeacherList.filter((function(t){return t.teacherName&&t.teacherName.toLowerCase().includes(e.searchKeyword.toLowerCase())})):this.allTeacherList},userInfo:function(){return e.getStorageSync("userInfo")||{}},featureList:function(){return this.userInfo.featureList||[]},hasSchedulePermission:function(){var e=this.userInfo,t=this.featureList;return"超级管理员"===e.role||"superadmin"===e.permission||(t.includes("schedule")||t.includes("教师排课"))},coursesByDay:function(){for(var e=this,t={},a=0;a<7;a++)t[a]=[];var n={1:{start:0,end:1},2:{start:2,end:3},3:{start:4,end:5},4:{start:6,end:7},5:{start:8,end:9},6:{start:10,end:11}};return console.log("时间段数组:",this.periods),console.log("课程节数映射:",n),this.allCourses.forEach((function(a){if(console.log("处理课程:",{name:a.course_name,date:a.date,start_period:a.start_period,end_period:a.end_period,start_time:a.start_time,end_time:a.end_time}),a.start_period<1||a.start_period>7||a.end_period<1||a.end_period>7)console.warn("跳过无效的课程节数:",a);else{var r=new Date(a.date).getDay(),o=0===r?6:r-1;if(o>=0&&o<7){var i=n[a.start_period];if(i){var s=i.start,u=i.end,h=u-s+1,d=80*s,g=80*h;console.log("高度计算详情:",{startTimeIndex:s,endTimeIndex:u,actualDuration:h,top:"".concat(d,"px"),height:"".concat(g,"px"),startTime:e.periods[s],endTime:e.periods[u]}),console.log("课程 ".concat(a.course_name," (第").concat(a.start_period,"节课) 显示在:"),{dayIndex:o,startTimeIndex:s,endTimeIndex:u,actualDuration:h,top:"".concat(d,"px"),height:"".concat(g,"px"),style:"top: ".concat(d,"px; height: ").concat(g,"px; ").concat((0,c.getCourseColor)(a.course_type,a.course_name)),periods:e.periods,startTime:e.periods[s],endTime:e.periods[u]}),t[o].push(l(l({},a),{},{name:a.course_name,location:a.location,class:a.class_name,style:"top: ".concat(d,"px; height: ").concat(g,"px; ").concat((0,c.getCourseColor)(a.course_type,a.course_name)),teacher_name:a.teacher_name||e.selectedTeacher.teacherName||"",type:a.course_type||a.type||"",remark:a.remark}))}}}})),t}},onLoad:function(t){var a=e.getStorageSync("userInfo")||{};t&&"true"===t.isSelf?(this.isSelf=!0,this.isTeacher=!0,this.selectedTeacher={_id:a._id,teacherName:a.teacherName||a.username},this.currentDate=this.getMondayOfWeek(new Date),this.generateWeekData()):(this.isTeacher=!1,this.fetchTeachers()),this.initImagePosition();var n=a.realName||a.teacherName||a.nickname||a.username||"",r=n?n.charAt(0):"";this.greetingText="你好，".concat(r,"老师，我是你的智能小助手小言。请问我有什么可以帮助你的？")},onShow:function(){this.initImagePosition()},methods:{getMondayOfWeek:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.currentDate,t=new Date(e);t.setHours(0,0,0,0);var a=t.getDay(),n=0===a?6:a-1;return t.setDate(t.getDate()-n),t},getDayOfWeek:function(e){var t=new Date(e),a=t.getDay();return["周一","周二","周三","周四","周五","周六","周日"][0===a?6:a-1]},generateWeekData:function(){var e=this.getMondayOfWeek(this.currentDate);this.days=[];for(var t=0;t<7;t++){var a=new Date(e);a.setDate(e.getDate()+t);var n=this.formatDate(a);this.days.push({name:this.getDayOfWeek(n),date:a.getDate(),fullDate:n})}console.log("days:",this.days.map((function(e){return e.fullDate+" "+e.name}))),this.selectedTeacher&&this.fetchWeekCourses()},getWeekRangeText:function(){var e=this.getMondayOfWeek(),t=new Date(e);return t.setDate(e.getDate()+6),"".concat(this.formatDate(e)," ~ ").concat(this.formatDate(t))},changeWeek:function(e){var t=this.getMondayOfWeek(this.currentDate);t.setDate(t.getDate()+7*e),this.currentDate=this.getMondayOfWeek(t),this.generateWeekData()},returnToCurrentWeek:function(){this.currentDate=this.getMondayOfWeek(new Date),this.generateWeekData()},isToday:function(e){var t=new Date,a=new Date(e);return t.getFullYear()===a.getFullYear()&&t.getMonth()===a.getMonth()&&t.getDate()===a.getDate()},formatDate:function(e){var t=e.getFullYear(),a=("0"+(e.getMonth()+1)).slice(-2),n=("0"+e.getDate()).slice(-2);return"".concat(t,"-").concat(a,"-").concat(n)},initImagePosition:function(){var t=this;this.$nextTick((function(){var a=e.getWindowInfo?e.getWindowInfo():e.getSystemInfoSync(),n=a.windowWidth,r=a.windowHeight;t.imageTranslateX=n-110-10,t.imageTranslateY=r-110-10}))},goBack:function(){var t=getCurrentPages();1===t.length?e.switchTab({url:"/pages/home/home"}):e.navigateBack()},fetchTeachers:function(){var t=this;return(0,i.default)(o.default.mark((function a(){var r;return o.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return t.isLoading=!0,a.prev=1,a.next=4,n.callFunction({name:"user-center",data:{action:"getAllUsersByRole",params:{role:"teacher"}}});case 4:r=a.sent,r.result&&r.result.data?(t.allTeacherList=r.result.data.map((function(e){return{_id:e._id,username:e.username,nickname:e.nickname,teacherName:e.nickname||e.teacherName||e.username}})),t.allTeacherList.length>0?(t.teacherIndex=0,t.selectedTeacher=t.filteredTeacherList[0],t.currentDate=t.getMondayOfWeek(new Date),t.generateWeekData()):t.isLoading=!1):(e.showToast({title:r.result&&r.result.errMsg||"获取教师列表失败",icon:"none"}),t.isLoading=!1),a.next=13;break;case 8:a.prev=8,a.t0=a["catch"](1),console.error("获取教师列表失败",a.t0),e.showToast({title:"教师加载失败",icon:"none"}),t.isLoading=!1;case 13:case"end":return a.stop()}}),a,null,[[1,8]])})))()},onTeacherChange:function(e){this.teacherIndex=e.detail.value,this.selectedTeacher=this.filteredTeacherList[this.teacherIndex],this.currentDate=this.getMondayOfWeek(new Date),this.generateWeekData()},onSearchInput:function(e){this.searchKeyword=e.detail.value,this.searchTeachers()},onSearchFocus:function(){console.log("搜索框获得焦点")},onSearchBlur:function(){console.log("搜索框失去焦点")},searchTeachers:function(){var t=this;if(this.searchKeyword.trim()){var a=this.allTeacherList.filter((function(e){return e.teacherName&&e.teacherName.toLowerCase().includes(t.searchKeyword.toLowerCase())}));a.length>0?(this.selectedTeacher=a[0],this.teacherIndex=this.allTeacherList.findIndex((function(e){return e._id===a[0]._id})),this.currentDate=this.getMondayOfWeek(new Date),this.generateWeekData()):e.showToast({title:"未找到匹配的教师",icon:"none"})}},fetchWeekCourses:function(){var t=this;return(0,i.default)(o.default.mark((function a(){var r,i,s;return o.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(t.selectedTeacher){a.next=2;break}return a.abrupt("return");case 2:return t.isLoading=!0,t.allCourses=[],a.prev=4,r=t.getMondayOfWeek(t.currentDate),i=new Date(r),i.setDate(r.getDate()+6),a.next=10,n.callFunction({name:"schedule-center",data:{action:"getSchedulesByTeacher",params:{teacher_id:t.selectedTeacher._id,startDate:t.formatDate(r),endDate:t.formatDate(i)}}});case 10:s=a.sent,s.result&&s.result.data?(t.allCourses=s.result.data.map((function(e){return l(l({},e),{},{_id:e._id})})),console.log("加载的课程数据:",t.allCourses),console.log("第4节课数据:",t.allCourses.filter((function(e){return 4===e.start_period}))),t.isLoading=!1):(e.showToast({title:s.result&&s.result.errMsg||"获取课程失败",icon:"none"}),t.isLoading=!1),a.next=19;break;case 14:a.prev=14,a.t0=a["catch"](4),console.error("获取课程失败",a.t0),e.showToast({title:"课程加载失败",icon:"none"}),t.isLoading=!1;case 19:case"end":return a.stop()}}),a,null,[[4,14]])})))()},getCourseColor:function(e,t){return(0,c.getCourseColor)(e,t)},isFutureCourse:function(e){var t=new Date;t.setHours(0,0,0,0);var a=new Date(e);return a.setHours(0,0,0,0),a>=t},goToApplyChange:function(t,a){var n="";n=t.start_period?{1:"8:00-10:00",2:"10:10-12:10",3:"14:00-16:00",4:"16:10-18:10",5:"18:00-20:00",6:"20:00-22:00"}[t.start_period]||t.start_time||t.time||t.originalTime||"8:00":t.start_time||t.time||t.originalTime||"8:00";var r={courseId:t._id,courseName:t.name,date:a,time:n,location:t.location,className:t.class};console.log("goToApplyChange 传递 courseId",t._id,"time:",n),e.navigateTo({url:"/pages/apply-change-course/apply-change-course?courseInfo="+encodeURIComponent(JSON.stringify(r))})},toggleImage:function(){this.isImageClicked=!this.isImageClicked,this.showBubble=!this.showBubble},canApplyChange:function(e,t){var a=new Date,n=new Date(t),r=new Date(a.getFullYear(),a.getMonth(),a.getDate()+6);return!(n<r)},handleCourseClick:function(t,a,n){var r=this;e.showModal({title:"课程详情",content:"课程名称：".concat(t.name,"\n教师：").concat(t.teacher_name,"\n教室：").concat(t.location,"\n类型：").concat(t.type,"\n备注：").concat(t.remark||""),showCancel:!1}),n>=4&&this.isSelf&&this.canApplyChange(t,a)&&e.showModal({title:"操作选择",content:"您要查看课程详情还是申请调课？",showCancel:!0,cancelText:"查看详情",confirmText:"申请调课",success:function(e){e.confirm&&r.goToApplyChange(t,a)}})},saveSchedule:function(){e.showToast({title:"排课保存成功!",icon:"success"})},handleImageTouchStart:function(e){this.imageStartX=e.touches[0].clientX,this.imageStartY=e.touches[0].clientY,this.isImageDragging=!0,e.preventDefault(),e.stopPropagation()},handleImageTouchMove:function(t){if(this.isImageDragging){t.preventDefault(),t.stopPropagation();var a=t.touches[0].clientX,n=t.touches[0].clientY,r=a-this.imageStartX,o=n-this.imageStartY,i=this.imageTranslateX+r,s=this.imageTranslateY+o,c=e.getWindowInfo?e.getWindowInfo():e.getSystemInfoSync(),u=c.windowWidth,l=c.windowHeight;i=Math.max(0,Math.min(i,u-110)),s=Math.max(0,Math.min(s,l-110)),this.imageTranslateX=i,this.imageTranslateY=s,this.imageStartX=a,this.imageStartY=n}},handleImageTouchEnd:function(e){this.isImageDragging=!1,e.preventDefault(),e.stopPropagation()},goToScheduleArrange:function(){var t=this.selectedTeacher||{},a=e.getStorageSync("userInfo")||{},n=t._id||a._id||"",r=t.username||a.username||"",o=this.formatDate(new Date,"yyyy-MM-dd"),i="uid=".concat(encodeURIComponent(n),"&username=").concat(encodeURIComponent(r),"&date=").concat(encodeURIComponent(o));e.navigateTo({url:"/pages/schedule-manage/schedule-manage?".concat(i)})}}};t.default=h}).call(this,a("df3c")["default"],a("861b")["uniCloud"])},f9c6:function(e,t,a){"use strict";a.r(t);var n=a("d70b"),r=a.n(n);for(var o in n)["default"].indexOf(o)<0&&function(e){a.d(t,e,(function(){return n[e]}))}(o);t["default"]=r.a}},[["8f98","common/runtime","common/vendor"]]]);