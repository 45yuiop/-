(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/schedule-manage/schedule-manage"],{"2c68":function(e,t,s){},5167:function(e,t,s){"use strict";var a=s("2c68"),r=s.n(a);r.a},"740c":function(e,t,s){"use strict";s.r(t);var a=s("a69c"),r=s("bc5f");for(var n in r)["default"].indexOf(n)<0&&function(e){s.d(t,e,(function(){return r[e]}))}(n);s("5167");var o=s("828b"),c=Object(o["a"])(r["default"],a["b"],a["c"],!1,null,null,null,!1,a["a"],void 0);t["default"]=c.exports},"7da4":function(e,t,s){"use strict";(function(e,t){var a=s("47a9");s("a226"),s("861b");a(s("3240"));var r=a(s("740c"));e.__webpack_require_UNI_MP_PLUGIN__=s,t(r.default)}).call(this,s("3223")["default"],s("df3c")["createPage"])},a69c:function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"c",(function(){return r})),s.d(t,"a",(function(){}));var a=function(){var e=this,t=e.$createElement,s=(e._self._c,e.isTeacher?null:e.filteredUserList.length),a=e.isMultiDateMode?e.selectedDates.length:null,r=e.isMultiDateMode?e.getCurrentWeekRange():null,n=e.isMultiDateMode?e.__map(e.getAllAvailableDates(),(function(t,s){var a=e.__get_orig(t),r=e.isDateSelected(t),n=e.isMonthStart(t),o=e.isDifferentMonth(t,s),c=e.formatDate(t,"MM-dd"),i=e.getWeekdayName(t),l=e.isMonthStart(t),u=l?e.formatDate(t,"MM月"):null;return{$orig:a,m1:r,m2:n,m3:o,m4:c,m5:i,m6:l,m7:u}})):null,o=e.showWeekPickerModal?e.getWeekOptions():null,c=!e.isLoading&&e.daySchedule?e.__map(e.visibleSlots,(function(t,s){var a=e.__get_orig(t),r=e.getTimeLabel(t-1),n=e.getTypeIndex(t-1),o=e.getTypeDisplay(t-1);return{$orig:a,m8:r,m9:n,m10:o}})):null;e._isMounted||(e.e0=function(t,s){var a=arguments[arguments.length-1].currentTarget.dataset,r=a.eventParams||a["event-params"];s=r.date;return e.toggleDateSelection(s)},e.e1=function(t,s){var a=arguments[arguments.length-1].currentTarget.dataset,r=a.eventParams||a["event-params"];s=r.week;return e.selectWeek(s.weekOffset)}),e.$mp.data=Object.assign({},{$root:{g0:s,g1:a,m0:r,l0:n,l1:o,l2:c}})},r=[]},bc5f:function(e,t,s){"use strict";s.r(t);var a=s("c1ab"),r=s.n(a);for(var n in a)["default"].indexOf(n)<0&&function(e){s.d(t,e,(function(){return a[e]}))}(n);t["default"]=r.a},c1ab:function(e,t,s){"use strict";(function(e,a){var r=s("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var n=r(s("7ca3")),o=s("8bf8");function c(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,a)}return s}function i(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?c(Object(s),!0).forEach((function(t){(0,n.default)(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):c(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}var l={data:function(){return{allUserList:[],userIndex:0,isTeacher:!1,currentUser:null,currentDate:new Date,selectedDates:[],isMultiDateMode:!1,daySchedule:{courses:["","","","","",""],types:["无","无","无","无","无","无"],locations:["","","","","",""],classes:["","","","","",""],remarks:["","","","","",""]},isLoading:!0,searchKeyword:"",courseTypes:["无","一对一","班课","脱产生"],remark:"",visibleSlots:[1,2,3,4,5,6],weekOffset:0,scrollLeft:0,showWeekPickerModal:!1}},computed:{dayDisplay:function(){var e=this.currentDate,t=this.formatDate(new Date,"yyyy-MM-dd")===this.formatDate(e,"yyyy-MM-dd");return"".concat(this.formatDate(e,"yyyy-MM-dd")," ").concat(["周日","周一","周二","周三","周四","周五","周六"][e.getDay()]," ").concat(t?"(今天)":"")},filteredUserList:function(){var e,t=this;e=this.searchKeyword?this.allUserList.filter((function(e){return e.teacherName&&e.teacherName.toLowerCase().includes(t.searchKeyword.toLowerCase())})):this.allUserList;var s=e.map((function(e){return i(i({},e),{},{displayName:e.teacherName||e.username||e.nickname||"未知用户"})}));return console.log("🔍 filteredUserList 处理结果:",s.length,"个用户"),s.length>0&&(console.log("🔍 第一个用户:",s[0]),console.log("🔍 当前 userIndex:",this.userIndex),this.userIndex<s.length&&console.log("🔍 当前选中用户:",s[this.userIndex])),s}},watch:{searchKeyword:function(){var e=this;this.userIndex=0,this.$nextTick((function(){e.updateCurrentUserAndFetchSchedule()}))}},onLoad:function(){var t=getCurrentPages(),s=t[t.length-1]||{},a=s.options||{},r=a.uid,n=a.username,o=a.date;if(o)try{this.currentDate=new Date(o)}catch(i){}if(r)return this.isTeacher=!1,this._pendingUid=r,this._pendingUsername=n||"",void this.fetchUsers();var c=e.getStorageSync("userInfo");c&&c.role&&c.role.includes("教师")?(this.isTeacher=!0,this.currentUser=c,this.fetchDaySchedule()):this.fetchUsers()},onReady:function(){this.$forceUpdate()},methods:{fetchUsers:function(){var t=this;console.log("🔍 开始获取用户列表..."),a.callFunction({name:"user-center",data:{action:"get-accounts"},success:function(e){console.log("📡 用户列表返回结果:",e);var s=e.result;if(200===s.code&&s.data.length>0){if(console.log("✅ 获取用户列表成功，用户数量:",s.data.length),t.allUserList=s.data,console.log("用户列表:",t.allUserList),t._pendingUid){var a=t.allUserList.findIndex((function(e){return e._id===t._pendingUid}));if(-1!==a){t.currentUser=t.allUserList[a],console.log("🎯 通过uid定位到用户:",t.currentUser);var r=t.filteredUserList.findIndex((function(e){return e._id===t._pendingUid}));return-1!==r?(t.userIndex=r,console.log("🎯 在过滤列表中用户索引已设置为:",t.userIndex)):console.warn("⚠️ 用户在过滤列表中未找到，可能被搜索关键词过滤"),t._pendingUid="",t._pendingUsername="",void t.fetchDaySchedule()}if(t._pendingUsername){var n=t.allUserList.findIndex((function(e){return e.username===t._pendingUsername||e.teacherName===t._pendingUsername||e.nickname===t._pendingUsername}));if(-1!==n){t.currentUser=t.allUserList[n],console.log("🎯 通过用户名定位到用户:",t.currentUser);var o=t.filteredUserList.findIndex((function(e){return e._id===t.allUserList[n]._id}));return-1!==o?(t.userIndex=o,console.log("🎯 在过滤列表中用户索引已设置为:",t.userIndex)):console.warn("⚠️ 用户在过滤列表中未找到，可能被搜索关键词过滤"),t._pendingUid="",t._pendingUsername="",void t.fetchDaySchedule()}}}t.$nextTick((function(){t.updateCurrentUserAndFetchSchedule(),t.$forceUpdate()}))}else console.error("❌ 获取用户列表失败:",s.message||"未知错误"),t.allUserList=[],t.isLoading=!1},fail:function(s){console.error("❌ 获取用户列表请求失败:",s),t.isLoading=!1,e.showToast({title:"获取用户列表失败: "+(s.message||"网络错误"),icon:"none"})}})},fetchDaySchedule:function(){var t=this;if(this.currentUser){this.isLoading=!0;var s=this.formatDate(this.currentDate,"yyyy-MM-dd");console.log("🔍 开始获取课表数据:"),console.log("当前用户:",this.currentUser),console.log("查询日期:",s),console.log("用户ID:",this.currentUser._id),console.log("用户名:",this.currentUser.username),a.callFunction({name:"schedule-center",data:{action:"get-schedules",params:{username:this.currentUser.username,uid:this.currentUser._id,date:s}},success:function(s){console.log("📡 云函数返回结果:",s);var a=s.result;if(200===a.code)if(console.log("✅ 查询成功，返回数据:",a.data),a.data){if(a.data.uid&&t.currentUser&&a.data.uid!==t.currentUser._id||a.data.username&&t.currentUser&&a.data.username!==t.currentUser.username)return console.warn("⚠️ 返回数据的用户与当前选择不一致，已忽略",{currentUser:t.currentUser,resultUser:{uid:a.data.uid,username:a.data.username}}),void e.showToast({title:"系统返回了其他教师的数据，已忽略",icon:"none"});t.$set(t,"daySchedule",{courses:[a.data.course_slot_1||"",a.data.course_slot_2||"",a.data.course_slot_3||"",a.data.course_slot_4||"",a.data.course_slot_5||"",a.data.course_slot_6||""],types:[a.data.course_slot_1_type||"无",a.data.course_slot_2_type||"无",a.data.course_slot_3_type||"无",a.data.course_slot_4_type||"无",a.data.course_slot_5_type||"无",a.data.course_slot_6_type||"无"],locations:[a.data.course_slot_1_location||"",a.data.course_slot_2_location||"",a.data.course_slot_3_location||"",a.data.course_slot_4_location||"",a.data.course_slot_5_location||"",a.data.course_slot_6_location||""],classes:[a.data.course_slot_1_class||"",a.data.course_slot_2_class||"",a.data.course_slot_3_class||"",a.data.course_slot_4_class||"",a.data.course_slot_5_class||"",a.data.course_slot_6_class||""],remarks:[a.data.course_slot_1_remark||"",a.data.course_slot_2_remark||"",a.data.course_slot_3_remark||"",a.data.course_slot_4_remark||"",a.data.course_slot_5_remark||"",a.data.course_slot_6_remark||""]}),console.log("✅ 课表数据已更新:",t.daySchedule)}else console.log("⚠️ 查询结果为空，设置默认空数据"),t.$set(t,"daySchedule",{courses:["","","","","",""],types:["无","无","无","无","无","无"],locations:["","","","","",""],classes:["","","","","",""],remarks:["","","","","",""]});else console.error("❌ 查询失败:",a.message),e.showToast({title:"查询失败: "+(a.message||"未知错误"),icon:"none"})},fail:function(t){console.error("❌ 请求失败:",t),e.showToast({title:"查询请求失败: "+(t.message||"网络错误"),icon:"none"})},complete:function(){t.isLoading=!1,console.log("🏁 课表获取完成")}})}else console.log("❌ 当前用户为空，无法获取课表")},onTypeChange:function(e,t){var s=t.detail.value;this.$set(this.daySchedule.types,e,this.courseTypes[s])},getTypeIndex:function(e){return this.courseTypes.indexOf(this.daySchedule.types[e])},getTypeDisplay:function(e){return this.daySchedule.types[e]||"无"},saveSchedule:function(){var t=this,s=this.currentUser;if(s&&s._id||(s=e.getStorageSync("userInfo")||{}),s._id){var r=this.isMultiDateMode?this.selectedDates:[this.currentDate];if(this.isMultiDateMode&&0===this.selectedDates.length)e.showToast({title:"请选择要排课的日期",icon:"none"});else{console.log("💾 开始保存排课数据，日期数量:",r.length),e.showLoading({title:"正在保存".concat(r.length,"个日期的排课...")});var n=r.map((function(r){var n=t.formatDate(r,"yyyy-MM-dd");console.log("📅 保存日期:",n);var o={username:s.username,uid:s._id,date:n};if(!s.username||!s._id||!n)throw console.error("❌ 缺少必要参数:",{username:s.username,uid:s._id,date:n}),new Error("缺少必要参数");for(var c=0;c<6;c++){var l=c+1;o["course_slot_".concat(l)]=t.daySchedule.courses[c]||"",o["course_slot_".concat(l,"_type")]=t.daySchedule.types[c]||"",o["course_slot_".concat(l,"_location")]=t.daySchedule.locations[c]||"",o["course_slot_".concat(l,"_class")]=t.daySchedule.classes[c]||"",o["course_slot_".concat(l,"_remark")]=t.daySchedule.remarks[c]||""}for(var u=6;u<8;u++){var d=u+1;o["course_slot_".concat(d)]="",o["course_slot_".concat(d,"_type")]="无",o["course_slot_".concat(d,"_location")]="",o["course_slot_".concat(d,"_class")]="",o["course_slot_".concat(d,"_remark")]=""}var h=e.getStorageSync("userInfo")||{},f=h.realName||h.username||"",g=t.remark||"",_=t.daySchedule.courses[0]||"",m=t.daySchedule.classes[0]||"",D=t.daySchedule.locations[0]||"",y=t.daySchedule.types[0]||"",p="".concat(n," 08:00-10:00");return console.log("排课参数",i(i({},o),{},{adminName:f,remark:g,courseName:_,className:m,classroom:D,courseType:y,scheduleTime:p})),a.callFunction({name:"schedule-center",data:{action:"set-schedule",params:i(i({},o),{},{adminId:s._id,adminName:f,remark:g,courseName:_,className:m,classroom:D,courseType:y,scheduleTime:p})}}).then((function(e){return console.log("📡 云函数返回结果:",e),e.result&&200!==e.result.code&&console.error("❌ 云函数返回错误:",{code:e.result.code,message:e.result.message,error:e.result.error}),e})).catch((function(e){return console.error("❌ 云函数调用失败:",e),{result:{code:500,message:"云函数调用失败: "+e.message}}}))}));Promise.all(n).then((function(t){e.hideLoading(),console.log("📡 批量保存结果:",t),t.forEach((function(e,t){console.log("📊 第".concat(t+1,"个日期的保存结果:"),{success:e.success,errCode:e.errCode,result:e.result}),e.result&&200!==e.result.code&&console.error("❌ 第".concat(t+1,"个日期保存失败:"),{code:e.result.code,message:e.result.message,error:e.result.error})}));var s=t.filter((function(e){return e.result&&200===e.result.code})).length,a=t.length;if(s===a)e.showToast({title:"成功保存".concat(s,"个日期的排课"),icon:"success",duration:2e3});else{var r=a-s;e.showToast({title:"保存完成：".concat(s,"/").concat(a,"个日期成功，").concat(r,"个失败"),icon:"none",duration:3e3})}})).catch((function(t){e.hideLoading(),console.error("❌ 批量保存失败:",t),e.showToast({title:"保存失败，请重试",icon:"none"})}))}}else e.showToast({title:"用户信息缺失，请重新登录",icon:"none"})},changeDay:function(e){this.currentDate.setDate(this.currentDate.getDate()+e),this.currentDate=new Date(this.currentDate),this.fetchDaySchedule()},onUserChange:function(e){this.userIndex=e.detail.value,this.updateCurrentUserAndFetchSchedule()},toggleMultiDateMode:function(){this.isMultiDateMode=!this.isMultiDateMode,this.isMultiDateMode&&0===this.selectedDates.length&&(this.selectedDates=[new Date(this.currentDate)])},getWeekDates:function(){var e=[],t=new Date(this.currentDate),s=new Date(t);s.setDate(t.getDate()-t.getDay());for(var a=0;a<7;a++){var r=new Date(s);r.setDate(s.getDate()+a),e.push(r)}return e},getAllAvailableDates:function(){var e=[],t=new Date,s=new Date(t);s.setDate(t.getDate()-t.getDay());for(var a=0;a<18;a++)for(var r=0;r<7;r++){var n=new Date(s);n.setDate(s.getDate()+7*a+r),e.push(n)}return e},getCurrentWeekRange:function(){var e=new Date,t=new Date(e);t.setDate(e.getDate()-e.getDay());var s=new Date(t);return s.setDate(t.getDate()+6),t.getMonth()!==s.getMonth()?"".concat(this.formatDate(t,"MM月dd日")," ~ ").concat(this.formatDate(s,"MM月dd日")):"".concat(this.formatDate(t,"MM-dd")," ~ ").concat(this.formatDate(s,"MM-dd"))},isDateSelected:function(e){var t=this,s=e instanceof Date?e:new Date(e);return this.selectedDates.some((function(e){var a=e instanceof Date?e:new Date(e);return t.formatDate(a,"yyyy-MM-dd")===t.formatDate(s,"yyyy-MM-dd")}))},toggleDateSelection:function(e){var t=this,s=e instanceof Date?e:new Date(e),a=this.formatDate(s,"yyyy-MM-dd"),r=this.selectedDates.findIndex((function(e){var s=e instanceof Date?e:new Date(e);return t.formatDate(s,"yyyy-MM-dd")===a}));r>-1?this.selectedDates.splice(r,1):this.selectedDates.push(new Date(s))},selectAllWeekdays:function(){var e=this;this.selectedDates=[];var t=this.getWeekDates();t.forEach((function(t){var s=t.getDay();s>=1&&s<=5&&e.selectedDates.push(new Date(t))}))},clearSelectedDates:function(){this.selectedDates=[]},changeWeek:function(e){var t=this;this.weekOffset+=e,this.weekOffset=Math.max(0,Math.min(this.weekOffset,18)),this.$nextTick((function(){t.scrollToCurrentWeek()}))},scrollToCurrentWeek:function(){this.scrollLeft=7*this.weekOffset*80},onDateScroll:function(e){var t=e.detail.scrollLeft,s=Math.round(t/560);this.weekOffset=Math.max(0,Math.min(s,18))},getWeekdayName:function(e){return["日","一","二","三","四","五","六"][e.getDay()]},isMonthStart:function(e){return 1===e.getDate()},isDifferentMonth:function(e,t){if(0===t)return!1;var s=this.getAllAvailableDates()[t-1];return e.getMonth()!==s.getMonth()},showWeekPicker:function(){this.showWeekPickerModal=!0},hideWeekPicker:function(){this.showWeekPickerModal=!1},getWeekOptions:function(){var e=[],t=new Date,s=new Date(t);s.setDate(t.getDate()-t.getDay());for(var a=0;a<18;a++){var r=new Date(s);r.setDate(s.getDate()+7*a);var n=new Date(r);n.setDate(r.getDate()+6);var o="";o=0===a?"本周 (".concat(this.formatDate(r,"MM-dd")," ~ ").concat(this.formatDate(n,"MM-dd"),")"):1===a?"下周 (".concat(this.formatDate(r,"MM-dd")," ~ ").concat(this.formatDate(n,"MM-dd"),")"):"第".concat(a+1,"周 (").concat(this.formatDate(r,"MM-dd")," ~ ").concat(this.formatDate(n,"MM-dd"),")"),e.push({weekOffset:a,label:o})}return e},selectWeek:function(e){var t=this;this.weekOffset=e,this.hideWeekPicker(),this.$nextTick((function(){t.scrollToCurrentWeek()}))},updateCurrentUserAndFetchSchedule:function(){console.log("🔄 更新当前用户并获取课表..."),console.log("当前搜索关键词:",this.searchKeyword),console.log("原始用户列表长度:",this.allUserList.length),console.log("过滤后用户列表长度:",this.filteredUserList.length),console.log("当前用户索引:",this.userIndex),this.filteredUserList.length>0?(this.userIndex>=this.filteredUserList.length&&(this.userIndex=0,console.log("⚠️ 用户索引超出范围，重置为0")),this.currentUser=this.filteredUserList[this.userIndex],console.log("✅ 当前用户已更新:",this.currentUser),console.log("用户索引:",this.userIndex),console.log("✅ 当前用户 displayName:",this.currentUser.displayName),this.fetchDaySchedule()):(console.warn("⚠️ 过滤后用户列表为空，设置默认状态"),this.currentUser=null,this.$set(this,"daySchedule",{courses:["","","","","",""],types:["无","无","无","无","无","无"],locations:["","","","","",""],classes:["","","","","",""],remarks:["","","","","",""]}),this.isLoading=!1)},formatDate:function(e,t){if(e instanceof Date||(e=new Date(e)),isNaN(e.getTime()))return console.error("Invalid date:",e),"";var s={"M+":e.getMonth()+1,"d+":e.getDate()};for(var a in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(e.getFullYear()+"").substr(4-RegExp.$1.length))),s)new RegExp("("+a+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?s[a]:("00"+s[a]).substr((""+s[a]).length)));return t},goBack:function(){e.navigateBack()},returnToToday:function(){this.currentDate=new Date,this.fetchDaySchedule()},getTimeLabel:function(e){return["8:00-10:00","10:10-12:10","14:00-16:00","16:10-18:10","18:00-20:00","20:00-22:00"][e]},getCourseColor:function(e,t){return(0,o.getCourseColor)(e,t)},onCourseChange:function(e,t,s){var a=e.detail.value;switch(console.log("课程信息变化:",{slotIndex:t,field:s,value:a}),s){case"course":this.$set(this.daySchedule.courses,t,a);break;case"location":this.$set(this.daySchedule.locations,t,a);break;case"class":this.$set(this.daySchedule.classes,t,a);break;case"remark":this.$set(this.daySchedule.remarks,t,a);break}},onInputFocus:function(e){console.log("输入框获得焦点:",e)},onInputChange:function(e){console.log("输入框内容变化:",e)}}};t.default=l}).call(this,s("df3c")["default"],s("861b")["uniCloud"])}},[["7da4","common/runtime","common/vendor"]]]);