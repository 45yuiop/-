(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/student-progress/student-progress"],{2952:function(e,t,n){"use strict";n.r(t);var r=n("defc"),a=n.n(r);for(var s in r)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return r[e]}))}(s);t["default"]=a.a},"41e5":function(e,t,n){"use strict";var r=n("86d6"),a=n.n(r);a.a},"86d6":function(e,t,n){},a069:function(e,t,n){"use strict";n.r(t);var r=n("b5b4"),a=n("2952");for(var s in a)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return a[e]}))}(s);n("41e5");var u=n("828b"),o=Object(u["a"])(a["default"],r["b"],r["c"],!1,null,"47815e9d",null,!1,r["a"],void 0);t["default"]=o.exports},b159:function(e,t,n){"use strict";(function(e,t){var r=n("47a9");n("a226"),n("861b");r(n("3240"));var a=r(n("a069"));e.__webpack_require_UNI_MP_PLUGIN__=n,t(a.default)}).call(this,n("3223")["default"],n("df3c")["createPage"])},b5b4:function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"c",(function(){return a})),n.d(t,"a",(function(){}));var r=function(){var e=this,t=e.$createElement,n=(e._self._c,e.__map(e.currentClassList,(function(t,n){var r=e.__get_orig(t),a=e.parseClassName(t.name),s=e.parseClassName(t.name),u=e.parseClassName(t.name);return{$orig:r,m0:a,m1:s,m2:u}}))),r=e.loading?null:e.__map(e.filteredStudents,(function(t,n){var r=e.__get_orig(t),a=e.scoresLabel(t);return{$orig:r,m3:a}})),a=!e.loading&&null!==e.classAvgRate&&"class"===e.activeTab&&e.classTotalCount>0?(e.classProgressCount/e.classTotalCount*100).toFixed(1):null,s=e.loading||null===e.classAvgRate||"class"!==e.activeTab?null:Number(e.classAvgRate),u=e.loading||null===e.classAvgRate||"class"!==e.activeTab?null:Number(e.classAvgRate);e.$mp.data=Object.assign({},{$root:{l0:n,l1:r,g0:a,m4:s,m5:u}})},a=[]},defc:function(e,t,n){"use strict";(function(e,r){var a=n("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s=a(n("7eb4")),u=a(n("af34")),o=a(n("ee10"));function i(e,t){var n="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=function(e,t){if(!e)return;if("string"===typeof e)return c(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return c(e,t)}(e))||t&&e&&"number"===typeof e.length){n&&(e=n);var r=0,a=function(){};return{s:a,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,u=!0,o=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return u=e.done,e},e:function(e){o=!0,s=e},f:function(){try{u||null==n.return||n.return()}finally{if(o)throw s}}}}function c(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var l={data:function(){return{activeTab:"class",classList:[],one2oneList:[],tuochanshengList:[],selectedClass:"",classStudents:[],oneToOneStudents:[],tuochanshengStudents:[],filteredStudents:[],loading:!1,classAvgRate:null,classProgressCount:0,classTotalCount:0,classPrevAvg:"-",classLatestAvg:"-"}},computed:{currentClassList:function(){return"class"===this.activeTab?this.classList:"one2one"===this.activeTab?this.one2oneList:this.tuochanshengList}},onLoad:function(){var t=e.getStorageSync("userInfo"),n=t&&(Array.isArray(t.role)?t.role.includes("教务"):"教务"===t.role);if(n)return e.showToast({title:"教务管理员无权限访问进步分析功能",icon:"none",duration:2e3}),void setTimeout((function(){e.navigateBack()}),2e3);this.loadAllStudents()},methods:{loadAllStudents:function(){var t=this;return(0,o.default)(s.default.mark((function n(){var a,o,i,c,l,f,d,g,m;return s.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(t.loading=!0,n.prev=1,a=e.getStorageSync("userInfo"),o=null===a||void 0===a?void 0:a._id,o){n.next=7;break}return e.showToast({title:"未登录",icon:"none"}),n.abrupt("return");case 7:return n.next=9,r.callFunction({name:"student-hours",data:{action:"getMyClassStudentsByType",teacherId:o}});case 9:if(i=n.sent,200===i.result.code){n.next=13;break}return e.showToast({title:i.result.message,icon:"none"}),n.abrupt("return");case 13:return c=i.result.data.classStudents||[],l=i.result.data.oneToOneStudents||[],f=[].concat((0,u.default)(c),(0,u.default)(l)).filter((function(e){return"脱产生"===(e.courseType||"").trim()})),d={},c.forEach((function(e){var t=(e.className||"").trim();t||(t=e.grade||"未分组"),e._group=t,d[t]||(d[t]=0),d[t]++})),t.classList=Object.keys(d).map((function(e){return{name:e,count:d[e]}})),g={},l.forEach((function(e){var t=(e.grade||"未分组").trim();e._group=t,g[t]||(g[t]=0),g[t]++})),t.one2oneList=Object.keys(g).map((function(e){return{name:e,count:g[e]}})),m={},f.forEach((function(e){var t=(e.grade||"未分组").trim();e._group=t,m[t]||(m[t]=0),m[t]++})),t.tuochanshengList=Object.keys(m).map((function(e){return{name:e,count:m[e]}})),t.classStudents=c,t.oneToOneStudents=l,t.tuochanshengStudents=f,t.activeTab="class",t.selectedClass=t.classList.length?t.classList[0].name:"",n.next=32,t.updateFilteredStudents();case 32:n.next=37;break;case 34:n.prev=34,n.t0=n["catch"](1),e.showToast({title:"加载失败",icon:"none"});case 37:t.loading=!1;case 38:case"end":return n.stop()}}),n,null,[[1,34]])})))()},updateFilteredStudents:function(){var e=this;return(0,o.default)(s.default.mark((function t(){var n,a,u,o,c,l,f,d,g,m,v,h,p,b,S,N,T,y,_,w,x,C,L,A;return s.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:b=function(e){var t=h(e.grade),n=Number(e.latestScore),r=Number(e.prevScore);if(isNaN(t)||isNaN(n)||isNaN(r))return!1;var a=p(t,n),s=p(t,r),u=["low","middle","upper","high"],o=u.indexOf(a),i=u.indexOf(s);if(-1===o||-1===i)return!1;if(o>i)return!0;if(o===i){if("high"===a)return!0;if("upper"===a&&n>=r)return!0;if("middle"===a&&n>r)return!0;if("low"===a&&n>r)return!0}return!1},p=function(e,t){if(e>=1&&e<=6){if(t>=95&&t<=100)return"high";if(t>=90&&t<=94)return"upper";if(t>=60&&t<=89)return"middle";if(t>=0&&t<=59)return"low"}else if(e>=7&&e<=9){if(t>=100&&t<=120)return"high";if(t>=90&&t<100)return"upper";if(t>=72&&t<90)return"middle";if(t>=0&&t<72)return"low"}return null},h=function(e){if(!e)return null;var t=e.match(/(\d+)/);if(t)return parseInt(t[1]);var n=e.match(/([一二三四五六七八九])/);return n?{"一":1,"二":2,"三":3,"四":4,"五":5,"六":6,"七":7,"八":8,"九":9}[n[1]]:null},e.loading=!0,n="class"===e.activeTab?e.classStudents:"one2one"===e.activeTab?e.oneToOneStudents:e.tuochanshengStudents,a=n.filter((function(t){return(t._group||"").trim()===e.selectedClass})),u=i(a),t.prev=7,u.s();case 9:if((o=u.n()).done){t.next=27;break}return c=o.value,t.next=13,r.callFunction({name:"exam-scores",data:{action:"getLatestTwoScores",studentId:c._id,subject:c.subject}});case 13:l=t.sent,f=200===l.result.code?l.result.data:[],f.sort((function(e,t){var n=new Date(e.examDate||e.createTime||0).getTime(),r=new Date(t.examDate||t.createTime||0).getTime();return r-n})),d=Number(c.entranceTestScore),g=null,m=null,v=null,1===f.length?(m=Number(f[0].score),v=d,!isNaN(d)&&d>0&&(g=((m-d)/d*100).toFixed(1))):f.length>=2&&(m=Number(f[0].score),v=Number(f[1].score),!isNaN(v)&&v>0&&(g=((m-v)/v*100).toFixed(1))),console.log("学生:",c.studentName,"entranceTestScore:",d,"latestScore:",m,"prevScore:",v,"progressRate:",g,"scores:",f),c.latestScore=m,c.prevScore=v,c.progressRate=null===g||isNaN(g)?null:g;case 25:t.next=9;break;case 27:t.next=32;break;case 29:t.prev=29,t.t0=t["catch"](7),u.e(t.t0);case 32:return t.prev=32,u.f(),t.finish(32);case 35:e.filteredStudents=a,S=a.filter((function(e){return null!==e.latestScore&&null!==e.prevScore&&!isNaN(Number(e.latestScore))&&!isNaN(Number(e.prevScore))&&Number(e.prevScore)>0})),N=null,T="-",y="-",S.length>0&&(_=S.filter((function(e){return null!==e.prevScore&&!isNaN(Number(e.prevScore))})).map((function(e){return Number(e.prevScore)})),w=_.length>0?_.reduce((function(e,t){return e+t}),0)/_.length:null,x=a.filter((function(e){return null!==e.latestScore&&!isNaN(Number(e.latestScore))})).map((function(e){return Number(e.latestScore)})),C=x.length>0?x.reduce((function(e,t){return e+t}),0)/x.length:null,T=null!==w?w.toFixed(1):"-",y=null!==C?C.toFixed(1):"-",w>0&&(N=((C-w)/w*100).toFixed(1))),e.classAvgRate=N,e.classPrevAvg=T,e.classLatestAvg=y,L=S.filter((function(e){return b(e)})).length,A=S.length,e.classProgressCount=L,e.classTotalCount=A,e.loading=!1,console.log("进步人数:",e.classProgressCount,"总人数:",e.classTotalCount,"filteredStudents:",e.filteredStudents);case 50:case"end":return t.stop()}}),t,null,[[7,29,32,35]])})))()},switchTab:function(e){if(this.activeTab!==e){this.activeTab=e;var t=this.currentClassList;this.selectedClass=t.length?t[0].name:"",this.updateFilteredStudents()}},onClassChange:function(e){this.selectedClass=e,this.updateFilteredStudents()},goBack:function(){e.reLaunch({url:"/pages/service/service"})},scoresLabel:function(e){return e.prevScore===Number(e.entranceTestScore)?"入门测":"上一次"},parseClassName:function(e){if(!e)return{grade:"",subject:"",type:""};var t=e.match(/^(.*年级)([^班]+)?([\u4e00-\u9fa5]+班)?$/);return t?{grade:t[1]?t[1].trim():"",subject:t[2]?t[2].trim():"",type:t[3]?t[3].trim():""}:{grade:e,subject:"",type:""}}}};t.default=l}).call(this,n("df3c")["default"],n("861b")["uniCloud"])}},[["b159","common/runtime","common/vendor"]]]);