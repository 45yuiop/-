(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/message/message"],{"005c":function(e,t,n){},"1b54":function(e,t,n){"use strict";n.r(t);var a=n("b479"),r=n.n(a);for(var s in a)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return a[e]}))}(s);t["default"]=r.a},"4c5c":function(e,t,n){"use strict";n.d(t,"b",(function(){return a})),n.d(t,"c",(function(){return r})),n.d(t,"a",(function(){}));var a=function(){var e=this,t=e.$createElement,n=(e._self._c,e.loading?null:e.filteredMessages.length),a=e.loading||0===n?null:e.__map(e.filteredMessages,(function(t,n){var a=e.__get_orig(t),r=e.getMessagePreview(t),s=e.formatTime(t.createTime);return{$orig:a,m0:r,m1:s}})),r=e.filteredMessages.length>0&&!e.loading;e.$mp.data=Object.assign({},{$root:{g0:n,l0:a,g1:r}})},r=[]},6303:function(e,t,n){"use strict";(function(e,t){var a=n("47a9");n("a226"),n("861b");a(n("3240"));var r=a(n("b726"));e.__webpack_require_UNI_MP_PLUGIN__=n,t(r.default)}).call(this,n("3223")["default"],n("df3c")["createPage"])},b479:function(e,t,n){"use strict";(function(e,a){var r=n("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s=r(n("7eb4")),c=r(n("af34")),o=r(n("ee10")),i={data:function(){return{userInfo:null,activeTab:"all",messages:[],loading:!0,showSubscriptionPrompt:!1}},computed:{filteredMessages:function(){var e=this;return"all"===this.activeTab?this.messages:this.messages.filter((function(t){return t.type===e.activeTab}))}},onShow:function(){this.userInfo=e.getStorageSync("userInfo"),this.loadMessages(),this.checkSubscriptionStatus()},methods:{loadMessages:function(){var e=this;return(0,o.default)(s.default.mark((function t(){var n,r,o,i;return s.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:return e.loading=!0,t.prev=1,t.next=4,a.callFunction({name:"news-service",data:{action:"listNews",page:1,pageSize:20}});case 4:if(n=t.sent,r=[],0===n.result.code&&(r=n.result.data.map((function(t){return{_id:"news_"+t._id,title:t.title,content:e.extractTextFromContentBlocks(t.contentBlocks),contentBlocks:t.contentBlocks,type:"system",read:!1,createTime:new Date(t.createTime),source:"news",newsId:t._id}}))),o=[],!e.userInfo||"管理员"!==e.userInfo.permission&&"superadmin"!==e.userInfo.permission){t.next=19;break}return t.prev=9,t.next=12,a.callFunction({name:"course-change",data:{action:"list"}});case 12:i=t.sent,i.result&&i.result.success&&(o=i.result.data.filter((function(e){return"pending"===e.status})).map((function(e){return{_id:"courseChange_"+e._id,title:"调课申请待审批",content:"".concat(e.teacherName,"申请调课：").concat(e.courseName,"，原时间：").concat(e.originalDate," ").concat(e.originalTime,"，新时间：").concat(e.newDate," ").concat(e.newTime),type:"courseChange",read:!1,createTime:new Date(e.createTime),source:"courseChange",applicationId:e._id}}))),t.next=19;break;case 16:t.prev=16,t.t0=t["catch"](9),console.error("获取调课申请失败:",t.t0);case 19:e.messages=[].concat((0,c.default)(r),(0,c.default)(o)).sort((function(e,t){return new Date(t.createTime)-new Date(e.createTime)})),t.next=26;break;case 22:t.prev=22,t.t1=t["catch"](1),console.error("获取消息失败:",t.t1),e.loadDemoMessages();case 26:return t.prev=26,e.loading=!1,t.finish(26);case 29:case"end":return t.stop()}}),t,null,[[1,22,26,29],[9,16]])})))()},loadDemoMessages:function(){this.messages=[{_id:"1",title:"排课通知",content:"您有一节新的课程已安排，请查看课表",type:"notification",read:!1,createTime:new Date(Date.now()-36e5)},{_id:"2",title:"系统维护通知",content:"系统将于今晚22:00-24:00进行维护，请提前保存数据",type:"system",read:!0,createTime:new Date(Date.now()-864e5)},{_id:"3",title:"调课申请",content:"您有一条调课申请待审批",type:"courseChange",read:!1,createTime:new Date(Date.now()-18e5)},{_id:"4",title:"新功能上线",content:"成绩分析功能已上线，欢迎体验",type:"system",read:!0,createTime:new Date(Date.now()-1728e5)}]},extractTextFromContentBlocks:function(e){return e&&Array.isArray(e)?e.filter((function(e){return"text"===e.type})).map((function(e){return e.content})).join(" "):""},getMessagePreview:function(e){return e.contentBlocks?this.extractTextFromContentBlocks(e.contentBlocks).substring(0,50)+"...":e.content?e.content.substring(0,50)+"...":""},switchTab:function(e){this.activeTab=e},readMessage:function(t){t.read=!0,"news"===t.source?e.navigateTo({url:"/pages/news-detail/news-detail?id=".concat(t.newsId)}):"courseChange"===t.source?e.navigateTo({url:"/pages/course-change-approval/course-change-approval"}):e.showToast({title:"标记为已读",icon:"none"})},markAllRead:function(){this.messages.forEach((function(e){e.read=!0})),e.showToast({title:"全部标记为已读",icon:"success"})},clearAllMessages:function(){var t=this;e.showModal({title:"清空消息",content:"确定要清空所有消息吗？此操作不可恢复",success:function(n){n.confirm&&(t.messages=[],e.showToast({title:"消息已清空",icon:"success"}))}})},formatTime:function(e){var t=new Date,n=new Date(e);if(n.toDateString()===t.toDateString())return"".concat(n.getHours().toString().padStart(2,"0"),":").concat(n.getMinutes().toString().padStart(2,"0"));var a=new Date(t);return a.setDate(a.getDate()-1),n.toDateString()===a.toDateString()?"昨天 ".concat(n.getHours().toString().padStart(2,"0"),":").concat(n.getMinutes().toString().padStart(2,"0")):"".concat(n.getMonth()+1,"-").concat(n.getDate())},checkSubscriptionStatus:function(){var t=this;return(0,o.default)(s.default.mark((function n(){var r,c;return s.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(n.prev=0,r=e.getStorageSync("openid"),r){n.next=5;break}return t.showSubscriptionPrompt=!0,n.abrupt("return");case 5:return n.next=7,a.callFunction({name:"subscription-message",data:{action:"get-subscription-status",openid:r}});case 7:c=n.sent,200===c.result.code?t.showSubscriptionPrompt=!c.result.data.isSubscribed:t.showSubscriptionPrompt=!0,n.next=15;break;case 11:n.prev=11,n.t0=n["catch"](0),console.error("检查订阅状态失败:",n.t0),t.showSubscriptionPrompt=!0;case 15:case"end":return n.stop()}}),n,null,[[0,11]])})))()},goToSubscription:function(){e.navigateTo({url:"/pages/subscription-settings/subscription-settings"})}}};t.default=i}).call(this,n("df3c")["default"],n("861b")["uniCloud"])},b726:function(e,t,n){"use strict";n.r(t);var a=n("4c5c"),r=n("1b54");for(var s in r)["default"].indexOf(s)<0&&function(e){n.d(t,e,(function(){return r[e]}))}(s);n("c528");var c=n("828b"),o=Object(c["a"])(r["default"],a["b"],a["c"],!1,null,"260a27f9",null,!1,a["a"],void 0);t["default"]=o.exports},c528:function(e,t,n){"use strict";var a=n("005c"),r=n.n(a);r.a}},[["6303","common/runtime","common/vendor"]]]);