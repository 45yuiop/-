(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/student-detail/student-detail"],{"138a":function(e,t,a){},"471c":function(e,t,a){"use strict";a.r(t);var s=a("7d82"),n=a("d1bd");for(var r in n)["default"].indexOf(r)<0&&function(e){a.d(t,e,(function(){return n[e]}))}(r);a("cd5e");var c=a("828b"),o=Object(c["a"])(n["default"],s["b"],s["c"],!1,null,"5f62c136",null,!1,s["a"],void 0);t["default"]=o.exports},6444:function(e,t,a){"use strict";(function(e,t){var s=a("47a9");a("a226"),a("861b");s(a("3240"));var n=s(a("471c"));e.__webpack_require_UNI_MP_PLUGIN__=a,t(n.default)}).call(this,a("3223")["default"],a("df3c")["createPage"])},"72da":function(e,t,a){"use strict";(function(e,s){var n=a("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=n(a("7eb4")),c=n(a("7ca3")),o=n(a("af34")),i=n(a("ee10"));function u(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,s)}return a}function l(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?u(Object(a),!0).forEach((function(t){(0,c.default)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):u(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function d(e,t){var a="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!a){if(Array.isArray(e)||(a=function(e,t){if(!e)return;if("string"===typeof e)return f(e,t);var a=Object.prototype.toString.call(e).slice(8,-1);"Object"===a&&e.constructor&&(a=e.constructor.name);if("Map"===a||"Set"===a)return Array.from(e);if("Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a))return f(e,t)}(e))||t&&e&&"number"===typeof e.length){a&&(e=a);var s=0,n=function(){};return{s:n,n:function(){return s>=e.length?{done:!0}:{done:!1,value:e[s++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,c=!0,o=!1;return{s:function(){a=a.call(e)},n:function(){var e=a.next();return c=e.done,e},e:function(e){o=!0,r=e},f:function(){try{c||null==a.return||a.return()}finally{if(o)throw r}}}}function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,s=new Array(t);a<t;a++)s[a]=e[a];return s}var h={data:function(){return{studentData:null,originalStudentData:null,gradeIndex:0,gradeOptions:["一年级","二年级","三年级","四年级","五年级","六年级","七年级","八年级","九年级","高一","高二","高三"],allSubjects:["语文","数学","英语","物理","化学"],showSubjectModalFlag:!1,tempSubjects:[],availableClasses:[],showClassModalFlag:!1,classSearchKeyword:"",filteredClasses:[],tempClasses:[],activeTab:"courses",courses:[],scores:[],showScoreEditModal:!1,editScoreData:{id:"",subject:"",subjectIndex:-1,examType:"",examTypeIndex:-1,score:"",examDate:"",remark:""},editScoreIndex:-1,examTypeOptions:["期中","期末","月考","中考"]}},onLoad:function(e){e.studentId&&this.loadStudentDetail(e.studentId)},methods:{goBack:function(){e.navigateBack()},loadStudentDetail:function(t){var a=this;return(0,i.default)(r.default.mark((function n(){var c;return r.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,s.callFunction({name:"archive-manager",data:{action:"getStudentDetail",studentId:t}});case 3:c=n.sent,0===c.result.code?(a.studentData=c.result.data,a.originalStudentData=JSON.parse(JSON.stringify(c.result.data)),a.gradeIndex=a.gradeOptions.indexOf(a.studentData.grade),a.tempSubjects=(0,o.default)(a.studentData.subjects),a.tempClasses=(0,o.default)(a.studentData.classes),a.loadAvailableClasses(),a.loadAcademicRecords(t)):(e.showToast({title:"加载学生信息失败",icon:"error"}),setTimeout((function(){e.navigateBack()}),1500)),n.next=12;break;case 7:n.prev=7,n.t0=n["catch"](0),console.error("加载学生详情失败:",n.t0),e.showToast({title:"加载学生信息失败",icon:"error"}),setTimeout((function(){e.navigateBack()}),1500);case 12:case"end":return n.stop()}}),n,null,[[0,7]])})))()},loadAvailableClasses:function(){var t=this;return(0,i.default)(r.default.mark((function a(){var n;return r.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:return a.prev=0,a.next=3,s.callFunction({name:"archive-manager",data:{action:"getClasses"}});case 3:n=a.sent,0===n.result.code&&(t.availableClasses=n.result.data||[],t.filteredClasses=t.availableClasses),a.next=11;break;case 7:a.prev=7,a.t0=a["catch"](0),console.error("加载班级列表失败:",a.t0),e.showToast({title:"加载班级失败",icon:"error"});case 11:case"end":return a.stop()}}),a,null,[[0,7]])})))()},loadAcademicRecords:function(t){var a=this;return(0,i.default)(r.default.mark((function n(){var c;return r.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.prev=0,n.next=3,s.callFunction({name:"archive-manager",data:{action:"getStudentAcademicRecords",studentId:t}});case 3:c=n.sent,0===c.result.code&&(a.courses=c.result.data.courses||[],a.scores=c.result.data.scores||[],0===a.courses.length&&a.studentData.classes.length>0&&a.syncCoursesWithClasses()),n.next=11;break;case 7:n.prev=7,n.t0=n["catch"](0),console.error("加载学生学术档案失败:",n.t0),e.showToast({title:"加载学术档案失败",icon:"error"});case 11:case"end":return n.stop()}}),n,null,[[0,7]])})))()},onGradeChange:function(e){this.gradeIndex=e.detail.value,this.studentData.grade=this.gradeOptions[e.detail.value]},showSubjectModal:function(){this.tempSubjects=(0,o.default)(this.studentData.subjects),this.showSubjectModalFlag=!0},closeSubjectModal:function(){this.showSubjectModalFlag=!1},toggleSubject:function(e){var t=this.tempSubjects.indexOf(e);t>-1?this.tempSubjects.splice(t,1):this.tempSubjects.push(e)},removeSubject:function(e){this.studentData.subjects.splice(e,1)},confirmSubjects:function(){this.studentData.subjects=(0,o.default)(this.tempSubjects),this.showSubjectModalFlag=!1},saveStudentInfo:function(){var t=this;return(0,i.default)(r.default.mark((function a(){var n;return r.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(t.studentData.name&&t.studentData.grade){a.next=3;break}return e.showToast({title:"请填写完整信息",icon:"none"}),a.abrupt("return");case 3:return a.prev=3,e.showLoading({title:"保存中..."}),a.next=7,s.callFunction({name:"student-manager",data:{action:"updateStudent",studentId:t.studentData.studentId,updateData:{name:t.studentData.name,grade:t.studentData.grade,subjects:t.studentData.subjects,classes:t.studentData.classes,updateTime:(new Date).toISOString()}}});case 7:n=a.sent,e.hideLoading(),0===n.result.code?(e.showToast({title:"保存成功",icon:"success"}),t.loadStudentDetail(),t.updateArchiveCache()):e.showToast({title:n.result.message||"保存失败",icon:"error"}),a.next=17;break;case 12:a.prev=12,a.t0=a["catch"](3),e.hideLoading(),console.error("保存学生信息失败:",a.t0),e.showToast({title:"保存失败，请重试",icon:"error"});case 17:case"end":return a.stop()}}),a,null,[[3,12]])})))()},showClassModal:function(){this.tempClasses=(0,o.default)(this.studentData.classes),this.showClassModalFlag=!0,this.filteredClasses=this.availableClasses,this.classSearchKeyword=""},closeClassModal:function(){this.showClassModalFlag=!1},isClassSelected:function(e){return this.tempClasses.some((function(t){return t._id===e._id}))},toggleClass:function(e){var t=this.tempClasses.findIndex((function(t){return t._id===e._id}));t>-1?this.tempClasses.splice(t,1):this.tempClasses.push(e)},removeClass:function(t){var a=this;return(0,i.default)(r.default.mark((function n(){var c,o;return r.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return c=a.studentData.classes[t],n.prev=1,n.next=4,s.callFunction({name:"class-management",data:{action:"removeStudentFromClass",classId:c._id,studentId:a.studentData.studentId}});case 4:if(o=n.sent,0!==o.result.code){n.next=11;break}a.studentData.classes.splice(t,1),a.removeCourseByClass(c),e.showToast({title:"删除班级成功",icon:"success"}),n.next=12;break;case 11:throw new Error(o.result.message||"删除班级失败");case 12:n.next=18;break;case 14:n.prev=14,n.t0=n["catch"](1),console.error("删除班级失败:",n.t0),e.showToast({title:"删除班级失败，请重试",icon:"error"});case 18:case"end":return n.stop()}}),n,null,[[1,14]])})))()},confirmClasses:function(){var t=this;return(0,i.default)(r.default.mark((function a(){var n,c,i,u,l,f,h,m,p,b,g,v;return r.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:a.prev=0,n=t.studentData.classes.map((function(e){return e._id})),c=t.tempClasses.map((function(e){return e._id})),i=t.tempClasses.filter((function(e){return!n.includes(e._id)})),u=t.studentData.classes.filter((function(e){return!c.includes(e._id)})),l=d(i),a.prev=6,l.s();case 8:if((f=l.n()).done){a.next=17;break}return h=f.value,a.next=12,s.callFunction({name:"class-management",data:{action:"addStudentsToClass",classId:h._id,studentIds:[t.studentData.studentId]}});case 12:if(m=a.sent,0===m.result.code){a.next=15;break}throw new Error(m.result.message||"添加班级失败");case 15:a.next=8;break;case 17:a.next=22;break;case 19:a.prev=19,a.t0=a["catch"](6),l.e(a.t0);case 22:return a.prev=22,l.f(),a.finish(22);case 25:p=d(u),a.prev=26,p.s();case 28:if((b=p.n()).done){a.next=37;break}return g=b.value,a.next=32,s.callFunction({name:"class-management",data:{action:"removeStudentFromClass",classId:g._id,studentId:t.studentData.studentId}});case 32:if(v=a.sent,0===v.result.code){a.next=35;break}throw new Error(v.result.message||"删除班级失败");case 35:a.next=28;break;case 37:a.next=42;break;case 39:a.prev=39,a.t1=a["catch"](26),p.e(a.t1);case 42:return a.prev=42,p.f(),a.finish(42);case 45:t.studentData.classes=(0,o.default)(t.tempClasses),t.showClassModalFlag=!1,t.syncCoursesWithClasses(),e.showToast({title:"班级更新成功",icon:"success"}),a.next=55;break;case 51:a.prev=51,a.t2=a["catch"](0),console.error("更新班级失败:",a.t2),e.showToast({title:"更新班级失败，请重试",icon:"error"});case 55:case"end":return a.stop()}}),a,null,[[0,51],[6,19,22,25],[26,39,42,45]])})))()},onClassSearchInput:function(){if(this.classSearchKeyword){var e=this.classSearchKeyword.toLowerCase();this.filteredClasses=this.availableClasses.filter((function(t){return t.className&&t.className.toLowerCase().includes(e)||t.grade&&t.grade.toLowerCase().includes(e)}))}else this.filteredClasses=this.availableClasses},createNewClass:function(){e.showToast({title:"请到班级管理页面创建新班级",icon:"none"})},syncCoursesWithClasses:function(){var e=this;this.courses=this.studentData.classes.map((function(t){var a=e.extractSubjectFromClassName(t.className);return{courseName:a,year:(new Date).getFullYear(),semester:"秋季",status:"在学",enroll_date:(new Date).toISOString(),completion_date:null,className:t.className}}))},extractSubjectFromClassName:function(e){for(var t=0,a=["语文","数学","英语","物理","化学"];t<a.length;t++){var s=a[t];if(e.includes(s))return s}return"未知科目"},removeCourseByClass:function(e){var t=this.extractSubjectFromClassName(e.className);this.courses=this.courses.filter((function(a){return!(a.courseName===t&&a.className===e.className)}))},switchTab:function(e){this.activeTab=e},formatDate:function(e){return e?"string"===typeof e?new Date(e).toLocaleDateString():e instanceof Date?e.toLocaleDateString():new Date(e).toLocaleDateString():""},getSubjectByCourseId:function(e){return this.allSubjects.includes(e)?e:this.studentData&&this.studentData.subjects&&this.studentData.subjects.find((function(t){return t===e}))||"未知科目"},editScore:function(e,t){console.log("编辑成绩 - 原始数据:",e),this.editScoreIndex=t;var a=e._id||e.id||e.examScoreId;console.log("成绩ID:",a),this.editScoreData={id:a,subject:this.getSubjectByCourseId(e.course_id),subjectIndex:this.allSubjects.indexOf(this.getSubjectByCourseId(e.course_id)),examType:e.exam_name||e.examType,examTypeIndex:this.examTypeOptions.indexOf(e.exam_name||e.examType),score:e.score.toString(),examDate:this.formatDateForInput(e.exam_date),remark:e.remark||"",inputUser:e.inputUser||"系统用户"},console.log("编辑成绩 - 处理后的数据:",this.editScoreData),this.showScoreEditModal=!0},closeScoreEditModal:function(){this.showScoreEditModal=!1,this.editScoreIndex=-1,this.editScoreData={id:"",subject:"",subjectIndex:-1,examType:"",examTypeIndex:-1,score:"",examDate:"",remark:""}},onEditSubjectChange:function(e){this.editScoreData.subjectIndex=e.detail.value,this.editScoreData.subject=this.allSubjects[e.detail.value]},onEditExamTypeChange:function(e){this.editScoreData.examTypeIndex=e.detail.value,this.editScoreData.examType=this.examTypeOptions[e.detail.value]},saveScore:function(){var t=this;return(0,i.default)(r.default.mark((function a(){var n,c;return r.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(t.editScoreData.subject&&t.editScoreData.examType&&t.editScoreData.score&&t.editScoreData.examDate){a.next=3;break}return e.showToast({title:"请填写完整信息",icon:"none"}),a.abrupt("return");case 3:return a.prev=3,n={subject:t.editScoreData.subject,examType:t.editScoreData.examType,exam_name:t.editScoreData.examType,score:Number(t.editScoreData.score),examDate:t.editScoreData.examDate,exam_date:t.editScoreData.examDate,remark:t.editScoreData.remark,inputUser:t.editScoreData.inputUser||"系统用户",lastModified:Date.now(),editTimestamp:(new Date).toISOString()},n.score&&"string"===typeof n.score&&(n.score=Number(n.score)),console.log("保存成绩 - 发送数据:",{action:"updateScore",id:t.editScoreData.id,data:n}),a.next=9,s.callFunction({name:"exam-scores",data:{action:"updateScore",id:t.editScoreData.id,data:n}});case 9:if(c=a.sent,console.log("保存成绩 - 云函数返回:",c),200!==c.result.code){a.next=17;break}t.scores[t.editScoreIndex]=l(l({},t.scores[t.editScoreIndex]),{},{courseName:t.editScoreData.subject,exam_name:t.editScoreData.examType,score:Number(t.editScoreData.score),exam_date:t.editScoreData.examDate,remark:t.editScoreData.remark}),e.showToast({title:"修改成功",icon:"success"}),t.closeScoreEditModal(),a.next=19;break;case 17:throw console.error("云函数返回错误:",c.result),new Error(c.result.message||"修改失败");case 19:a.next=25;break;case 21:a.prev=21,a.t0=a["catch"](3),console.error("修改成绩失败:",a.t0),e.showToast({title:"修改失败，请重试",icon:"error"});case 25:case"end":return a.stop()}}),a,null,[[3,21]])})))()},deleteScore:function(){var t=this;e.showModal({title:"确认删除",content:"确定要删除这条成绩记录吗？",success:function(){var a=(0,i.default)(r.default.mark((function a(n){var c;return r.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(!n.confirm){a.next=20;break}return a.prev=1,console.log("删除成绩 - ID:",t.editScoreData.id),a.next=5,s.callFunction({name:"exam-scores",data:{action:"deleteScore",id:t.editScoreData.id}});case 5:if(c=a.sent,console.log("删除成绩 - 云函数返回:",c),200!==c.result.code){a.next=13;break}t.scores.splice(t.editScoreIndex,1),e.showToast({title:"删除成功",icon:"success"}),t.closeScoreEditModal(),a.next=14;break;case 13:throw new Error(c.result.message||"删除失败");case 14:a.next=20;break;case 16:a.prev=16,a.t0=a["catch"](1),console.error("删除成绩失败:",a.t0),e.showToast({title:"删除失败，请重试",icon:"error"});case 20:case"end":return a.stop()}}),a,null,[[1,16]])})));return function(e){return a.apply(this,arguments)}}()})},formatDateForInput:function(e){if(!e)return"";var t=new Date(e),a=t.getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0");return"".concat(a,"-").concat(s,"-").concat(n)},deleteStudent:function(){var t=this;e.showModal({title:"确认删除",content:"确定要删除学生 ".concat(this.studentData.name," 吗？"),success:function(){var a=(0,i.default)(r.default.mark((function a(n){var c;return r.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(!n.confirm){a.next=17;break}return a.prev=1,a.next=4,s.callFunction({name:"archive-manager",data:{action:"deleteStudent",studentId:t.studentData.studentId}});case 4:if(c=a.sent,0!==c.result.code){a.next=10;break}e.showToast({title:"删除成功",icon:"success"}),setTimeout((function(){e.navigateBack()}),1500),a.next=11;break;case 10:throw new Error(c.result.message||"删除失败");case 11:a.next=17;break;case 13:a.prev=13,a.t0=a["catch"](1),console.error("删除学生失败:",a.t0),e.showToast({title:"删除失败，请重试",icon:"error"});case 17:case"end":return a.stop()}}),a,null,[[1,13]])})));return function(e){return a.apply(this,arguments)}}()})},updateArchiveCache:function(){try{var e=getApp();e.globalData&&e.globalData.updateArchiveCache?(e.globalData.updateArchiveCache(),console.log("已通知档案管理页面更新缓存")):console.log("档案管理页面未加载，无法更新缓存")}catch(t){console.error("更新档案管理缓存失败:",t)}}}};t.default=h}).call(this,a("df3c")["default"],a("861b")["uniCloud"])},"7d82":function(e,t,a){"use strict";a.d(t,"b",(function(){return s})),a.d(t,"c",(function(){return n})),a.d(t,"a",(function(){}));var s=function(){var e=this,t=e.$createElement,a=(e._self._c,e.studentData?e.studentData.subjects.length:null),s=e.studentData?e.studentData.classes.length:null,n=e.studentData&&"courses"===e.activeTab?e.courses.length:null,r=e.studentData&&"courses"===e.activeTab&&0!==n?e.__map(e.courses,(function(t,a){var s=e.__get_orig(t),n=e.formatDate(t.enroll_date),r=t.completion_date?e.formatDate(t.completion_date):null;return{$orig:s,m0:n,m1:r}})):null,c=e.studentData&&"scores"===e.activeTab?e.scores.length:null,o=e.studentData&&"scores"===e.activeTab&&0!==c?e.__map(e.scores,(function(t,a){var s=e.__get_orig(t),n=e.formatDate(t.exam_date),r=e.getSubjectByCourseId(t.course_id);return{$orig:s,m2:n,m3:r}})):null,i=e.showSubjectModalFlag?e.__map(e.allSubjects,(function(t,a){var s=e.__get_orig(t),n=e.tempSubjects.includes(t),r=e.tempSubjects.includes(t);return{$orig:s,g4:n,g5:r}})):null,u=e.showClassModalFlag?e.__map(e.filteredClasses,(function(t,a){var s=e.__get_orig(t),n=e.isClassSelected(t),r=e.isClassSelected(t);return{$orig:s,m4:n,m5:r}})):null,l=e.showClassModalFlag?e.classSearchKeyword&&0===e.filteredClasses.length:null,d=e.showClassModalFlag?0===e.filteredClasses.length&&!e.classSearchKeyword:null;e.$mp.data=Object.assign({},{$root:{g0:a,g1:s,g2:n,l0:r,g3:c,l1:o,l2:i,l3:u,g6:l,g7:d}})},n=[]},cd5e:function(e,t,a){"use strict";var s=a("138a"),n=a.n(s);n.a},d1bd:function(e,t,a){"use strict";a.r(t);var s=a("72da"),n=a.n(s);for(var r in s)["default"].indexOf(r)<0&&function(e){a.d(t,e,(function(){return s[e]}))}(r);t["default"]=n.a}},[["6444","common/runtime","common/vendor"]]]);