(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/teacher-schedule/teacher-schedule"],{"0aa5":function(e,t,o){},"327a":function(e,t,o){"use strict";var c=o("0aa5"),n=o.n(c);n.a},4873:function(e,t,o){"use strict";(function(e,t){var c=o("47a9");o("a226"),o("861b");c(o("3240"));var n=c(o("521c"));e.__webpack_require_UNI_MP_PLUGIN__=o,t(n.default)}).call(this,o("3223")["default"],o("df3c")["createPage"])},"521c":function(e,t,o){"use strict";o.r(t);var c=o("9369"),n=o("873e");for(var r in n)["default"].indexOf(r)<0&&function(e){o.d(t,e,(function(){return n[e]}))}(r);o("327a");var s=o("828b"),a=Object(s["a"])(n["default"],c["b"],c["c"],!1,null,"d1b561f2",null,!1,c["a"],void 0);t["default"]=a.exports},"873e":function(e,t,o){"use strict";o.r(t);var c=o("f44b"),n=o.n(c);for(var r in c)["default"].indexOf(r)<0&&function(e){o.d(t,e,(function(){return c[e]}))}(r);t["default"]=n.a},9369:function(e,t,o){"use strict";o.d(t,"b",(function(){return c})),o.d(t,"c",(function(){return n})),o.d(t,"a",(function(){}));var c=function(){var e=this,t=e.$createElement,o=(e._self._c,e.selectedTeacher&&!e.isLoading?e.__map(e.weekSchedule,(function(t,o){var c=e.__get_orig(t),n=e.formatDateWithWeek(t.course_date),r=e.__map(e.periods,(function(o,c){var n=e.__get_orig(o),r=5===o||6===o?e.getClassOptionIndex(t["course_slot_"+o+"_class"]):null,s=5===o||6===o?e.getTypeIndex(t["course_slot_"+o+"_type"]):null,a=5!==o&&6!==o?e.getTypeIndex(t["course_slot_"+o+"_type"]):null;return{$orig:n,m1:r,m2:s,m3:a}}));return{$orig:c,m0:n,l0:r}})):null);e.$mp.data=Object.assign({},{$root:{l1:o}})},n=[]},f44b:function(e,t,o){"use strict";(function(e,c){var n=o("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=n(o("7eb4")),s=n(o("7ca3")),a=n(o("ee10")),l=o("8bf8");function i(e,t){var o="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!o){if(Array.isArray(e)||(o=function(e,t){if(!e)return;if("string"===typeof e)return u(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);"Object"===o&&e.constructor&&(o=e.constructor.name);if("Map"===o||"Set"===o)return Array.from(e);if("Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o))return u(e,t)}(e))||t&&e&&"number"===typeof e.length){o&&(e=o);var c=0,n=function(){};return{s:n,n:function(){return c>=e.length?{done:!0}:{done:!1,value:e[c++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,s=!0,a=!1;return{s:function(){o=o.call(e)},n:function(){var e=o.next();return s=e.done,e},e:function(e){a=!0,r=e},f:function(){try{s||null==o.return||o.return()}finally{if(a)throw r}}}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,c=new Array(t);o<t;o++)c[o]=e[o];return c}function h(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);t&&(c=c.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,c)}return o}function d(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?h(Object(o),!0).forEach((function(t){(0,s.default)(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):h(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function f(e){var t=e.getFullYear(),o=(e.getMonth()+1).toString().padStart(2,"0"),c=e.getDate().toString().padStart(2,"0");return"".concat(t,"-").concat(o,"-").concat(c)}var g={data:function(){return{allTeacherList:[],teacherIndex:-1,searchKeyword:"",selectedTeacher:null,rawScheduleList:[],weekSchedule:[],isLoading:!1,weekOffset:0,initialScheduleState:"",courseTypes:["æ— ","ä¸€å¯¹ä¸€","ç­è¯¾","è„±äº§ç”Ÿ","ä¹ æƒ¯ç­"],courseOptions:["ä¸€å¹´çº§","äºŒå¹´çº§","ä¸‰å¹´çº§","å››å¹´çº§","äº”å¹´çº§","å…­å¹´çº§","ä¸ƒå¹´çº§","å…«å¹´çº§","ä¹å¹´çº§","é«˜ä¸€","èƒŒè¯µ"],periods:[1,2,3,4,5,6],periodTimes:["8:00-10:00","10:10-12:10","14:00-16:00","16:10-18:10","18:00-20:00","20:00-22:00"],weekDaysOrder:[1,2,3,4,5,6,0],currentDate:function(){var e=new Date;e.setHours(0,0,0,0);var t=e.getDay(),o=0===t?6:t-1;return e.setDate(e.getDate()-o),e}()}},computed:{filteredTeacherList:function(){var e=this;return this.searchKeyword?this.allTeacherList.filter((function(t){return t.teacherName&&t.teacherName.toLowerCase().includes(e.searchKeyword.toLowerCase())})):this.allTeacherList},weekTitle:function(){return"è¿™å‘¨è¯¾ç¨‹"},weekRangeText:function(){var e=this.getMondayOfWeek(),t=new Date(e);return t.setDate(e.getDate()+6),"".concat(f(e)," ~ ").concat(f(t))}},watch:{weekSchedule:{handler:function(t){if(this.selectedTeacher&&t.length>0){var o=this.selectedTeacher._id,c=this.getMondayOfWeek(this.currentDate),n=f(c),r="teacherScheduleCache_"+o+"_"+n;e.setStorageSync(r,t),console.log("æ•°æ®å·²è‡ªåŠ¨ä¿å­˜åˆ°ç¼“å­˜")}},deep:!0}},onShow:function(){var t=this;console.log("ğŸ“± é¡µé¢æ˜¾ç¤ºï¼Œå¼€å§‹åˆå§‹åŒ–...");var o=e.getStorageSync("userInfo"),c="";this.selectedTeacher&&this.selectedTeacher._id?(c=this.selectedTeacher._id,console.log("ğŸ‘¤ ä½¿ç”¨å·²é€‰ä¸­çš„æ•™å¸ˆID:",c)):o&&o._id&&(c=o._id,console.log("ğŸ‘¤ ä½¿ç”¨å½“å‰ç”¨æˆ·IDä½œä¸ºæ•™å¸ˆID:",c)),console.log("ğŸ‘¤ å½“å‰æ•™å¸ˆID:",c),this.currentDate=this.getMondayOfWeek(new Date);var n=this.currentDate,r=f(n);console.log("ğŸ“… å½“å‰å‘¨:",r);var s="teacherScheduleCache_"+c+"_"+r,a=e.getStorageSync(s);a&&Array.isArray(a)&&7===a.length?(console.log("ğŸ“¦ å‘ç°ç¼“å­˜æ•°æ®ï¼Œé•¿åº¦:",a.length),this.weekSchedule=a,setTimeout((function(){t.selectedTeacher&&(console.log("ğŸ”„ å¼‚æ­¥æ›´æ–°æ•°æ®..."),t.fetchTeacherSchedule())}),100)):(console.log("ğŸ†• æ— ç¼“å­˜æ•°æ®ï¼Œæ„å»ºæ–°çš„å‘¨è®¡åˆ’"),this.buildWeekSchedule()),this.checkAdminRoleAndFetchTeachers()},onUnload:function(){var t=e.getStorageSync("fromService");t&&(e.switchTab({url:"/pages/service/service"}),e.removeStorageSync("fromService"))},methods:{checkAdminRoleAndFetchTeachers:function(){var t=e.getStorageSync("userInfo"),o=t&&t.role&&t.role.includes("ç®¡ç†å‘˜")||"ç®¡ç†å‘˜"===t.permission,c=t&&"superadmin"===t.permission,n=t&&t.featureList&&t.featureList.includes("schedule");if(!(o||c||n))return e.showToast({title:"æ— æƒé™è®¿é—®",icon:"none"}),void setTimeout((function(){e.reLaunch({url:"/pages/home/home"})}),1200);this.fetchTeachers()},fetchTeachers:function(){var t=this;c.callFunction({name:"user-center",data:{action:"get-accounts"},success:function(){var o=(0,a.default)(r.default.mark((function o(c){var n;return r.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:if(n=c.result,200!==n.code||!n.data){o.next=8;break}return t.allTeacherList=n.data.filter((function(e){return e.role&&e.role.includes("æ•™å¸ˆ")})),o.next=5,t.enrichTeachersWithOpenid();case 5:t.allTeacherList.length>0?t.selectTeacher(0):e.showToast({title:"æš‚æ— æ•™å¸ˆä¿¡æ¯",icon:"none"}),o.next=9;break;case 8:e.showToast({title:"è·å–æ•™å¸ˆåˆ—è¡¨å¤±è´¥: "+(n.message||"æœªçŸ¥é”™è¯¯"),icon:"none"});case 9:case"end":return o.stop()}}),o)})));return function(e){return o.apply(this,arguments)}}(),fail:function(t){e.showToast({title:"è·å–æ•™å¸ˆåˆ—è¡¨è¯·æ±‚å¤±è´¥",icon:"none"})}})},enrichTeachersWithOpenid:function(){var e=this;return(0,a.default)(r.default.mark((function t(){var o,n,s,a;return r.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:t.prev=0,console.log("ğŸ” å¼€å§‹è¡¥å……æ•™å¸ˆopenidä¿¡æ¯..."),o=0;case 3:if(!(o<e.allTeacherList.length)){t.next=18;break}return n=e.allTeacherList[o],t.prev=5,t.next=8,c.callFunction({name:"user-center",data:{action:"get-user-detail",params:{userId:n._id}}});case 8:s=t.sent,s.result&&200===s.result.code&&(a=s.result.data,a.openid?(e.allTeacherList[o].openid=a.openid,console.log("âœ… æ•™å¸ˆ ".concat(n.teacherName||n.username," openid è·å–æˆåŠŸ"))):console.log("âš ï¸ æ•™å¸ˆ ".concat(n.teacherName||n.username," æ²¡æœ‰openid"))),t.next=15;break;case 12:t.prev=12,t.t0=t["catch"](5),console.error("âŒ è·å–æ•™å¸ˆ ".concat(n.teacherName||n.username," openid å¤±è´¥:"),t.t0);case 15:o++,t.next=3;break;case 18:console.log("âœ… æ•™å¸ˆopenidä¿¡æ¯è¡¥å……å®Œæˆ"),t.next=24;break;case 21:t.prev=21,t.t1=t["catch"](0),console.error("âŒ è¡¥å……æ•™å¸ˆopenidä¿¡æ¯å¤±è´¥:",t.t1);case 24:case"end":return t.stop()}}),t,null,[[0,21],[5,12]])})))()},selectTeacher:function(e){console.log("ğŸ‘¤ é€‰æ‹©æ•™å¸ˆï¼Œç´¢å¼•:",e),this.teacherIndex=e,this.selectedTeacher=this.filteredTeacherList[e],console.log("é€‰ä¸­çš„æ•™å¸ˆ:",this.selectedTeacher),this.currentDate=this.getMondayOfWeek(new Date),this.rawScheduleList=[],this.weekSchedule=[],this.initialScheduleState="",console.log("ğŸ”„ å¼€å§‹è·å–é€‰ä¸­æ•™å¸ˆçš„è¯¾è¡¨..."),this.fetchTeacherSchedule()},fetchTeacherSchedule:function(){var t=this;if(this.selectedTeacher){this.isLoading=!0;var o=this.selectedTeacher._id,n=this.getMondayOfWeek(),r=new Date(n);r.setDate(n.getDate()+6),console.log("ğŸ” å¼€å§‹è·å–æ•™å¸ˆè¯¾è¡¨æ•°æ®..."),console.log("é€‰ä¸­çš„æ•™å¸ˆ:",this.selectedTeacher),console.log("æ•™å¸ˆID:",o),console.log("æŸ¥è¯¢æ—¥æœŸèŒƒå›´:",f(n),"åˆ°",f(r)),c.callFunction({name:"schedule-center",data:{action:"getSchedulesByTeacher",params:{teacher_id:o,startDate:f(n),endDate:f(r)}},success:function(c){console.log("ğŸ“¡ äº‘å‡½æ•°è¿”å›ç»“æœ:",c);var r=c.result;if(200===r.code&&r.data){console.log("âœ… è·å–è¯¾è¡¨æ•°æ®æˆåŠŸï¼Œæ•°æ®æ¡æ•°:",r.data.length),console.log("åŸå§‹æ•°æ®:",r.data),t.rawScheduleList=r.data,t.buildWeekSchedule();var s=f(n),a="teacherScheduleCache_"+o+"_"+s;e.setStorageSync(a,t.weekSchedule),console.log("âœ… æ–°æ•°æ®å·²ä¿å­˜åˆ°ç¼“å­˜")}else console.error("âŒ è·å–è¯¾è¡¨æ•°æ®å¤±è´¥:",r.message||"æœªçŸ¥é”™è¯¯"),t.rawScheduleList=[],t.buildWeekSchedule()},fail:function(e){console.error("âŒ è¯·æ±‚å¤±è´¥:",e),t.rawScheduleList=[],t.buildWeekSchedule()},complete:function(){t.isLoading=!1,console.log("ğŸ è¯¾è¡¨è·å–å®Œæˆ")}})}},buildWeekSchedule:function(){var e=this;this.currentDate=this.getMondayOfWeek(this.currentDate);var t=this.currentDate;console.log("ğŸ”¨ å¼€å§‹æ„å»ºå‘¨è®¡åˆ’..."),console.log("å½“å‰æ—¥æœŸ:",this.currentDate),console.log("å‘¨ä¸€æ—¥æœŸ:",t),console.log("åŸå§‹æ•°æ®åˆ—è¡¨:",this.rawScheduleList),this.weekSchedule=[];for(var o=[],c=function(c){var n=new Date(t.getTime()+24*c*60*60*1e3),r=f(n);console.log("ğŸ“… å¤„ç†ç¬¬".concat(c,"å¤©ï¼Œæ—¥æœŸ: ").concat(r));var s={course_date:r,course_slot_1:"",course_slot_1_type:"æ— ",course_slot_1_class:"",course_slot_1_location:"",course_slot_1_remark:"",course_slot_2:"",course_slot_2_type:"æ— ",course_slot_2_class:"",course_slot_2_location:"",course_slot_2_remark:"",course_slot_3:"",course_slot_3_type:"æ— ",course_slot_3_class:"",course_slot_3_location:"",course_slot_3_remark:"",course_slot_4:"",course_slot_4_type:"æ— ",course_slot_4_class:"",course_slot_4_location:"",course_slot_4_remark:"",course_slot_5:"",course_slot_5_type:"æ— ",course_slot_5_class:"",course_slot_5_location:"",course_slot_5_remark:"",course_slot_6:"",course_slot_6_type:"æ— ",course_slot_6_class:"",course_slot_6_location:"",course_slot_6_remark:""},a=e.rawScheduleList.filter((function(e){var t=e.date;"string"===typeof t&&t.length>=10?t=t.slice(0,10):t instanceof Date&&(t=f(t));var o=t===r;return console.log("  è¯¾ç¨‹æ—¥æœŸ: ".concat(t,", åŒ¹é…: ").concat(o)),o}));console.log("  æ‰¾åˆ° ".concat(a.length," é—¨è¯¾ç¨‹")),a.forEach((function(e){if(console.log("  ğŸ“š å¤„ç†è¯¾ç¨‹: ".concat(e.course_name,", æ—¶é—´æ®µ: ").concat(e.start_period)),e.start_period<1||e.start_period>6)console.log("    âš ï¸ æ—¶é—´æ®µè¶…å‡ºèŒƒå›´: ".concat(e.start_period));else{var t=e.start_period;t>=1&&t<=6&&(s["course_slot_".concat(t)]=e.course_name||"",s["course_slot_".concat(t,"_type")]=e.course_type||"æ— ",s["course_slot_".concat(t,"_class")]=e.class_name||"",s["course_slot_".concat(t,"_location")]=e.location||"",s["course_slot_".concat(t,"_remark")]=e.remark||"",console.log("    âœ… å·²æ˜ å°„åˆ°ç¬¬".concat(t,"èŠ‚è¯¾:"),{"è¯¾ç¨‹å":e.course_name,"ç±»å‹":e.course_type,"ç­çº§":e.class_name,"æ•™å®¤":e.location,"å¤‡æ³¨":e.remark}))}})),o.push(s),console.log("  ğŸ“‹ ç¬¬".concat(c,"å¤©è¯¾è¡¨:"),s)},n=0;n<7;n++)c(n);this.weekSchedule=o,this.initialScheduleState=JSON.stringify(this.weekSchedule),console.log("ğŸ¯ å‘¨è®¡åˆ’æ„å»ºå®Œæˆ:"),console.log("æ—¥æœŸåˆ—è¡¨:",this.weekSchedule.map((function(e){return e.course_date}))),console.log("ç¬¬ä¸€å¤©æ•°æ®ç»“æ„:",this.weekSchedule[0]),this.$forceUpdate()},getMondayOfWeek:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.currentDate,t=new Date(e);t.setHours(0,0,0,0);var o=t.getDay(),c=0===o?6:o-1;return t.setDate(t.getDate()-c),t},onInputChange:function(t,o,c,n){var r=n?"course_slot_".concat(c,"_").concat(n):"course_slot_".concat(c),s=t.detail.value;if(console.log("è¾“å…¥äº‹ä»¶è§¦å‘:",{dayIndex:o,slot:c,field:n,value:s,event:t}),this.weekSchedule[o]){this.weekSchedule[o][r]=s,console.log("æ•°æ®å·²æ›´æ–°:",{dayIndex:o,slot:c,field:n,value:s,key:r});var a=this.selectedTeacher?this.selectedTeacher._id:"",l=this.getMondayOfWeek(this.currentDate),i=f(l),u="teacherScheduleCache_"+a+"_"+i;e.setStorageSync(u,this.weekSchedule),console.log("æ•°æ®å·²ä¿å­˜åˆ°ç¼“å­˜")}},onTypeChange:function(t,o,c){if(this.weekSchedule[o]){this.weekSchedule[o]["course_slot_".concat(c,"_type")]=this.courseTypes[t.detail.value],console.log("ç±»å‹å˜åŒ–:",{dayIndex:o,slot:c,value:this.courseTypes[t.detail.value]});var n=this.selectedTeacher?this.selectedTeacher._id:"",r=this.getMondayOfWeek(this.currentDate),s=f(r),a="teacherScheduleCache_"+n+"_"+s;e.setStorageSync(a,this.weekSchedule)}},getTypeIndex:function(e){return this.courseTypes.indexOf(e)},getCourseOptionIndex:function(e){return this.courseOptions.indexOf(e)},getClassOptionIndex:function(e){return this.courseOptions.indexOf(e)},onCourseOptionChange:function(t,o,c){if(this.weekSchedule[o]){this.weekSchedule[o]["course_slot_".concat(c)]=this.courseOptions[t.detail.value],console.log("è¯¾ç¨‹é€‰é¡¹å˜åŒ–:",{dayIndex:o,slot:c,value:this.courseOptions[t.detail.value]});var n=this.selectedTeacher?this.selectedTeacher._id:"",r=this.getMondayOfWeek(this.currentDate),s=f(r),a="teacherScheduleCache_"+n+"_"+s;e.setStorageSync(a,this.weekSchedule)}},onClassOptionChange:function(t,o,c){if(this.weekSchedule[o]){var n=this.courseOptions[t.detail.value];this.weekSchedule[o]["course_slot_".concat(c,"_class")]=n,this.weekSchedule[o]["course_slot_".concat(c)]=n,console.log("ç­çº§é€‰é¡¹å˜åŒ–:",{dayIndex:o,slot:c,value:n});var r=this.selectedTeacher?this.selectedTeacher._id:"",s=this.getMondayOfWeek(this.currentDate),a=f(s),l="teacherScheduleCache_"+r+"_"+a;e.setStorageSync(l,this.weekSchedule)}},changeWeek:function(t){var o=this;console.log("ğŸ“… åˆ‡æ¢å‘¨ï¼Œåç§»é‡:",t);var c=this.getMondayOfWeek(this.currentDate);c.setDate(c.getDate()+7*t),this.currentDate=c,console.log("æ–°çš„å½“å‰æ—¥æœŸ:",this.currentDate),this.rawScheduleList=[],this.weekSchedule=[];var n=this.selectedTeacher?this.selectedTeacher._id:"",r=f(c),s="teacherScheduleCache_"+n+"_"+r,a=e.getStorageSync(s);a&&Array.isArray(a)&&7===a.length?(console.log("ğŸ“¦ å‘ç°ç¼“å­˜æ•°æ®ï¼Œé•¿åº¦:",a.length),this.weekSchedule=a,setTimeout((function(){o.selectedTeacher&&(console.log("ğŸ”„ å¼‚æ­¥æ›´æ–°æ•°æ®..."),o.fetchTeacherSchedule())}),100)):(console.log("ğŸ†• æ— ç¼“å­˜æ•°æ®ï¼Œé‡æ–°è·å–æ•°æ®"),this.selectedTeacher?this.fetchTeacherSchedule():this.buildWeekSchedule())},saveSchedule:function(){var t=this,o=this.weekSchedule.map((function(e){return d(d({},e),{},{teacher_id:t.selectedTeacher._id,uid:t.selectedTeacher._id,username:t.selectedTeacher.username})})),n=e.getStorageSync("userInfo"),s=n.realName||n.username||"ç®¡ç†å‘˜";c.callFunction({name:"schedule-center",data:{action:"updateSchedules",params:{schedules:o,adminName:s}},success:function(){var c=(0,a.default)(r.default.mark((function c(n){var s,a,l,i;return r.default.wrap((function(c){while(1)switch(c.prev=c.next){case 0:if(200!==n.result.code){c.next=12;break}return e.showToast({title:"æ’è¯¾ä¿å­˜æˆåŠŸ!",icon:"success"}),s=t.selectedTeacher?t.selectedTeacher._id:"",a=t.getMondayOfWeek(t.currentDate),l=f(a),i="teacherScheduleCache_"+s+"_"+l,e.setStorageSync(i,t.weekSchedule),c.next=9,t.sendScheduleNotifications(o);case 9:t.fetchTeacherSchedule(),c.next=13;break;case 12:e.showToast({title:"ä¿å­˜å¤±è´¥: "+n.result.message,icon:"none"});case 13:case"end":return c.stop()}}),c)})));return function(e){return c.apply(this,arguments)}}(),fail:function(t){e.showToast({title:"ä¿å­˜è¯·æ±‚å¤±è´¥",icon:"none"})}})},sendScheduleNotifications:function(e){var t=this;return(0,a.default)(r.default.mark((function o(){var n,s,a,l,u,h,f,g,p,_,m,S,v,T,y,k,b,w,D,x,O,C,W,N;return r.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:o.prev=0,console.log("å¼€å§‹å‘é€æ’è¯¾è®¢é˜…æ¶ˆæ¯é€šçŸ¥..."),n=t.selectedTeacher._id,s=null,a=null,l=null,u=i(e),o.prev=7,u.s();case 9:if((h=u.n()).done){o.next=18;break}if(f=h.value,g=f.course_date,p=f.uid,f.username,p===n){o.next=15;break}return console.log("è·³è¿‡éå½“å‰æ•™å¸ˆçš„è¯¾ç¨‹: ".concat(p," vs ").concat(n)),o.abrupt("continue",16);case 15:for(_=1;_<=6;_++)m="course_slot_".concat(_),S="course_slot_".concat(_,"_type"),v="course_slot_".concat(_,"_class"),T="course_slot_".concat(_,"_location"),y=f[m],k=f[S],b=f[v],w=f[T],y&&""!==y.trim()&&(D=new Date("".concat(g," ").concat(t.getSlotStartTime(_))),(!l||D>l)&&(l=D,s=f,a={courseName:y,courseType:k,className:b,location:w,date:g,slot:_},console.log("æ‰¾åˆ°æ›´æ™šçš„è¯¾ç¨‹:",a,"æ—¶é—´:",D)));case 16:o.next=9;break;case 18:o.next=23;break;case 20:o.prev=20,o.t0=o["catch"](7),u.e(o.t0);case 23:return o.prev=23,u.f(),o.finish(23);case 26:if(!s||!a){o.next=58;break}if(console.log("å‡†å¤‡å‘é€æœ€æ–°æ’è¯¾è¯¾ç¨‹çš„è®¢é˜…æ¶ˆæ¯:",a),x=t.selectedTeacher.openid||"",console.log("æ•™å¸ˆopenidä¿¡æ¯:",{teacherId:t.selectedTeacher._id,teacherName:t.selectedTeacher.teacherName||t.selectedTeacher.username,openid:x,hasOpenid:!!x,openidType:x?x.startsWith("mock_")?"æµ‹è¯•æ¨¡å¼":x.startsWith("temp_")?"ä¸´æ—¶æ¨¡å¼":"çœŸå®openid":"æ— openid"}),x){o.next=33;break}return console.log("âš ï¸ æ•™å¸ˆ ".concat(t.selectedTeacher.teacherName||t.selectedTeacher.username," æ²¡æœ‰openidï¼Œè·³è¿‡è®¢é˜…æ¶ˆæ¯å‘é€")),o.abrupt("return");case 33:if(!x.startsWith("mock_")&&!x.startsWith("temp_")){o.next=36;break}return console.log("âš ï¸ æ•™å¸ˆ ".concat(t.selectedTeacher.teacherName||t.selectedTeacher.username," ä½¿ç”¨æµ‹è¯•openid: ").concat(x,"ï¼Œè·³è¿‡è®¢é˜…æ¶ˆæ¯å‘é€")),o.abrupt("return");case 36:if(o.prev=36,O=t.checkSessionSubscription(x),!O){o.next=46;break}return console.log("âœ… ä½¿ç”¨ä¼šè¯è®¢é˜…å‘é€æ’è¯¾é€šçŸ¥ï¼Œé¿å…å¾®ä¿¡APIé™åˆ¶"),o.next=42,t.sendScheduleNotificationWithSession(d(d({},a),{},{openid:x}));case 42:C=o.sent,C.success?console.log("æœ€æ–°æ’è¯¾è¯¾ç¨‹ä¼šè¯è®¢é˜…æ¶ˆæ¯å‘é€æˆåŠŸ: ".concat(a.courseName)):console.log("ä¼šè¯è®¢é˜…æ¶ˆæ¯å‘é€å¤±è´¥: ".concat(C.error)),o.next=51;break;case 46:return console.log("ğŸ“± ä½¿ç”¨å¾®ä¿¡APIå‘é€è®¢é˜…æ¶ˆæ¯"),o.next=49,c.callFunction({name:"subscription-message",data:{action:"send-schedule-notification",openid:t.selectedTeacher.openid||"",courseName:a.courseName,classTime:t.formatClassTime(a.date,a.slot),remark:(a.location||"æœªæŒ‡å®š")+"æ•™å®¤",studentName:a.courseType||"æœªæŒ‡å®šç±»å‹",page:"pages/schedule-tab/schedule-tab"}});case 49:W=o.sent,W.result&&200===W.result.code?console.log("æœ€æ–°æ’è¯¾è¯¾ç¨‹è®¢é˜…æ¶ˆæ¯å‘é€æˆåŠŸ: ".concat(a.courseName)):(N=W.result&&W.result.error?W.result.error:"",console.log("æœ€æ–°æ’è¯¾è¯¾ç¨‹è®¢é˜…æ¶ˆæ¯å‘é€å¤±è´¥:",{message:W.result&&W.result.message?W.result.message:"",error:N,code:W.result&&W.result.code?W.result.code:""}),N&&N.includes("43101")&&(console.log('âš ï¸ è¯¾ç¨‹ "'.concat(a.courseName,'" è®¢é˜…æ¶ˆæ¯è¢«ç”¨æˆ·æ‹’ç»ï¼Œéœ€è¦é‡æ–°æˆæƒ')),t.createSessionSubscriptionForTeacher(x)));case 51:o.next=56;break;case 53:o.prev=53,o.t1=o["catch"](36),console.error("æœ€æ–°æ’è¯¾è¯¾ç¨‹è®¢é˜…æ¶ˆæ¯å‘é€å¤±è´¥:",o.t1);case 56:o.next=59;break;case 58:console.log("æœªæ‰¾åˆ°éœ€è¦å‘é€è®¢é˜…æ¶ˆæ¯çš„è¯¾ç¨‹");case 59:console.log("æ’è¯¾è®¢é˜…æ¶ˆæ¯é€šçŸ¥å‘é€å®Œæˆ"),o.next=65;break;case 62:o.prev=62,o.t2=o["catch"](0),console.error("å‘é€æ’è¯¾è®¢é˜…æ¶ˆæ¯é€šçŸ¥å¤±è´¥:",o.t2);case 65:case"end":return o.stop()}}),o,null,[[0,62],[7,20,23,26],[36,53]])})))()},getSlotStartTime:function(e){return["08:00","10:10","14:00","16:10","18:00","20:00"][e-1]||"08:00"},formatClassTime:function(e,t){var o=new Date(e),c=o.getFullYear(),n=(o.getMonth()+1).toString().padStart(2,"0"),r=o.getDate().toString().padStart(2,"0"),s=["08:00","10:10","14:00","16:10","18:00","20:00"][t-1]||"08:00";return"".concat(c,"-").concat(n,"-").concat(r," ").concat(s)},getDayOfWeek:function(e){var t=new Date(e).getDay();return["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"][t]},getDayOfWeekIndex:function(e){return new Date(e).getDay()},getCourseColor:function(e,t){return(0,l.getCourseColor)(e,t)},goHome:function(){e.switchTab({url:"/pages/service/service"})},returnToCurrentWeek:function(){this.currentDate=this.getMondayOfWeek(new Date),this.buildWeekSchedule()},formatDateWithWeek:function(e){if(!e)return"";var t=new Date(e),o=t.getFullYear(),c=(t.getMonth()+1).toString().padStart(2,"0"),n=t.getDate().toString().padStart(2,"0"),r=["å‘¨æ—¥","å‘¨ä¸€","å‘¨äºŒ","å‘¨ä¸‰","å‘¨å››","å‘¨äº”","å‘¨å…­"][t.getDay()];return"".concat(o,"-").concat(c,"-").concat(n," ").concat(r)},onInputFocus:function(e){console.log("è¾“å…¥æ¡†è·å¾—ç„¦ç‚¹:",e)},checkSessionSubscription:function(t){try{var o="session_subscription_".concat(t),c=e.getStorageSync(o);if(c&&c.isValid){var n=Date.now();return n<c.expireTime?(console.log("âœ… æ‰¾åˆ°æœ‰æ•ˆçš„ä¼šè¯è®¢é˜…"),!0):(console.log("âš ï¸ ä¼šè¯è®¢é˜…å·²è¿‡æœŸ"),!1)}return!1}catch(r){return console.error("æ£€æŸ¥ä¼šè¯è®¢é˜…å¤±è´¥:",r),!1}},createSessionSubscriptionForTeacher:function(t){try{var o="session_subscription_".concat(t),c={isValid:!0,createTime:Date.now(),expireTime:Date.now()+864e5,usageCount:0,openid:t,type:"teacher_schedule"};return e.setStorageSync(o,c),console.log("ğŸ” ä¸ºæ•™å¸ˆåˆ›å»ºä¼šè¯è®¢é˜…æˆåŠŸ:",c),!0}catch(n){return console.error("åˆ›å»ºæ•™å¸ˆä¼šè¯è®¢é˜…å¤±è´¥:",n),!1}},sendScheduleNotificationWithSession:function(t){var o=this;return(0,a.default)(r.default.mark((function n(){var s,a,l;return r.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.prev=0,console.log("ğŸ” ä½¿ç”¨ä¼šè¯è®¢é˜…å‘é€æ’è¯¾é€šçŸ¥..."),console.log("ğŸ“¤ å‘é€å‚æ•°:",{openid:t.openid,courseName:t.courseName,classTime:o.formatClassTime(t.date,t.slot),remark:(t.location||"æœªæŒ‡å®š")+"æ•™å®¤",studentName:t.courseType||"æœªæŒ‡å®šç±»å‹",isSessionSubscription:!0}),n.next=5,c.callFunction({name:"subscription-message",data:{action:"send-schedule-notification",openid:t.openid,courseName:t.courseName,classTime:o.formatClassTime(t.date,t.slot),remark:(t.location||"æœªæŒ‡å®š")+"æ•™å®¤",studentName:t.courseType||"æœªæŒ‡å®šç±»å‹",page:"pages/schedule-tab/schedule-tab",isSessionSubscription:!0}});case 5:if(s=n.sent,console.log("ğŸ“¥ äº‘å‡½æ•°è¿”å›ç»“æœ:",s),!s.result||200!==s.result.code){n.next=17;break}return console.log("âœ… ä¼šè¯è®¢é˜…æ¶ˆæ¯å‘é€æˆåŠŸ"),console.log("ğŸ“Š è¿”å›æ•°æ®:",s.result.data),a=s.result.data&&s.result.data.method,"session_subscription_bypass"===a&&(console.log("ğŸ¯ ä½¿ç”¨ä¼šè¯è®¢é˜…ç‰¹æ®Šç­–ç•¥å¤„ç†æˆåŠŸ"),e.showModal({title:"ä¼šè¯è®¢é˜…æ¨¡å¼",content:"æ‚¨çš„è®¢é˜…æ¶ˆæ¯å·²é€šè¿‡ä¼šè¯è®¢é˜…æ¨¡å¼å¤„ç†æˆåŠŸï¼\n\nç‰¹ç‚¹ï¼š\nâ€¢ æ— éœ€é‡å¤æˆæƒ\nâ€¢ å¯ä»¥æ— é™æ¬¡ä½¿ç”¨\nâ€¢ æ¶ˆæ¯è®°å½•å®Œæ•´\nâ€¢ é¿å…å¾®ä¿¡é™åˆ¶\n\næ³¨æ„ï¼šè¿™æ˜¯ä¼šè¯è®¢é˜…æ¨¡å¼ï¼Œæ¶ˆæ¯ä¼šè®°å½•ä½†ä¸ä¼šé‡å¤å‘é€å¾®ä¿¡é€šçŸ¥ã€‚",showCancel:!1,confirmText:"æ˜ç™½äº†"})),o.logSessionScheduleMessage(t,s.result),o.updateSessionUsage(t.openid),n.abrupt("return",{success:!0,data:s.result});case 17:return console.log("âŒ ä¼šè¯è®¢é˜…æ¶ˆæ¯å‘é€å¤±è´¥:",s.result&&s.result.message?s.result.message:"æœªçŸ¥é”™è¯¯"),console.log("ğŸ” è¯¦ç»†é”™è¯¯ä¿¡æ¯:",s.result),l=s.result&&s.result.error?s.result.error:"",l&&l.includes("43101")&&(console.log("âš ï¸ æ£€æµ‹åˆ°43101é”™è¯¯ï¼Œç”¨æˆ·éœ€è¦é‡æ–°æˆæƒè®¢é˜…æ¶ˆæ¯"),e.showModal({title:"è®¢é˜…æ¶ˆæ¯å‘é€å¤±è´¥",content:'æ‚¨çš„è®¢é˜…æ¶ˆæ¯æˆæƒå·²å¤±æ•ˆï¼Œéœ€è¦é‡æ–°æˆæƒæ‰èƒ½æ¥æ”¶é€šçŸ¥ã€‚\n\nå»ºè®®ï¼š\n1. è¿›å…¥"è®¢é˜…è®¾ç½®"é¡µé¢\n2. é‡æ–°å¼€å¯è®¢é˜…å¼€å…³\n3. å®Œæˆå¾®ä¿¡æˆæƒ',showCancel:!0,cancelText:"ç¨åå¤„ç†",confirmText:"å»è®¾ç½®",success:function(t){t.confirm&&e.navigateTo({url:"/pages/subscription-settings/subscription-settings"})}})),n.next=23,o.fallbackToTraditionalSubscription(t);case 23:return n.abrupt("return",n.sent);case 24:n.next=32;break;case 26:return n.prev=26,n.t0=n["catch"](0),console.error("ä¼šè¯è®¢é˜…å‘é€æ’è¯¾é€šçŸ¥å¤±è´¥:",n.t0),n.next=31,o.fallbackToTraditionalSubscription(t);case 31:return n.abrupt("return",n.sent);case 32:case"end":return n.stop()}}),n,null,[[0,26]])})))()},fallbackToTraditionalSubscription:function(e){var t=this;return(0,a.default)(r.default.mark((function o(){var n;return r.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:return o.prev=0,console.log("ğŸ”„ é™çº§åˆ°ä¼ ç»Ÿè®¢é˜…æ–¹å¼..."),o.next=4,c.callFunction({name:"subscription-message",data:{action:"send-schedule-notification",openid:e.openid,courseName:e.courseName,classTime:t.formatClassTime(e.date,e.slot),remark:(e.location||"æœªæŒ‡å®š")+"æ•™å®¤",studentName:e.courseType||"æœªæŒ‡å®šç±»å‹",page:"pages/schedule-tab/schedule-tab",isSessionSubscription:!1}});case 4:if(n=o.sent,!n.result||200!==n.result.code){o.next=10;break}return console.log("âœ… ä¼ ç»Ÿè®¢é˜…æ–¹å¼å‘é€æˆåŠŸ"),o.abrupt("return",{success:!0,data:n.result,method:"traditional"});case 10:return console.log("âŒ ä¼ ç»Ÿè®¢é˜…æ–¹å¼ä¹Ÿå¤±è´¥:",n.result&&n.result.message?n.result.message:"æœªçŸ¥é”™è¯¯"),o.abrupt("return",{success:!1,error:n.result&&n.result.message?n.result.message:"å‘é€å¤±è´¥"});case 12:o.next=18;break;case 14:return o.prev=14,o.t0=o["catch"](0),console.error("ä¼ ç»Ÿè®¢é˜…æ–¹å¼å¤±è´¥:",o.t0),o.abrupt("return",{success:!1,error:o.t0.message});case 18:case"end":return o.stop()}}),o,null,[[0,14]])})))()},logSessionScheduleMessage:function(t,o){try{var c=e.getStorageSync("session_schedule_messages")||[];c.push(d(d({},t),{},{result:o,timestamp:Date.now(),type:"schedule_notification"})),c.length>100&&c.splice(0,c.length-100),e.setStorageSync("session_schedule_messages",c),console.log("ğŸ“ ä¼šè¯æ’è¯¾æ¶ˆæ¯å·²è®°å½•åˆ°æœ¬åœ°æ—¥å¿—")}catch(n){console.error("è®°å½•ä¼šè¯æ’è¯¾æ¶ˆæ¯å¤±è´¥:",n)}},updateSessionUsage:function(t){try{var o="session_subscription_".concat(t),c=e.getStorageSync(o);c&&(c.usageCount=(c.usageCount||0)+1,c.lastUsageTime=Date.now(),c.expireTime=Date.now()+864e5,e.setStorageSync(o,c),console.log("ğŸ“Š æ•™å¸ˆä¼šè¯è®¢é˜…ä½¿ç”¨æ¬¡æ•°: ".concat(c.usageCount)))}catch(n){console.error("æ›´æ–°ä¼šè¯ä½¿ç”¨æ¬¡æ•°å¤±è´¥:",n)}},formatDate:function(e){var t=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0");return"".concat(t,"-").concat(o,"-").concat(c)}}};t.default=g}).call(this,o("df3c")["default"],o("861b")["uniCloud"])}},[["4873","common/runtime","common/vendor"]]]);