(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/teacher-schedule/teacher-schedule"],{"0aa5":function(e,t,o){},"327a":function(e,t,o){"use strict";var c=o("0aa5"),n=o.n(c);n.a},4873:function(e,t,o){"use strict";(function(e,t){var c=o("47a9");o("a226"),o("861b");c(o("3240"));var n=c(o("521c"));e.__webpack_require_UNI_MP_PLUGIN__=o,t(n.default)}).call(this,o("3223")["default"],o("df3c")["createPage"])},"521c":function(e,t,o){"use strict";o.r(t);var c=o("9369"),n=o("873e");for(var r in n)["default"].indexOf(r)<0&&function(e){o.d(t,e,(function(){return n[e]}))}(r);o("327a");var s=o("828b"),a=Object(s["a"])(n["default"],c["b"],c["c"],!1,null,"d1b561f2",null,!1,c["a"],void 0);t["default"]=a.exports},"873e":function(e,t,o){"use strict";o.r(t);var c=o("f44b"),n=o.n(c);for(var r in c)["default"].indexOf(r)<0&&function(e){o.d(t,e,(function(){return c[e]}))}(r);t["default"]=n.a},9369:function(e,t,o){"use strict";o.d(t,"b",(function(){return c})),o.d(t,"c",(function(){return n})),o.d(t,"a",(function(){}));var c=function(){var e=this,t=e.$createElement,o=(e._self._c,e.selectedTeacher&&!e.isLoading?e.__map(e.weekSchedule,(function(t,o){var c=e.__get_orig(t),n=e.formatDateWithWeek(t.course_date),r=e.__map(e.periods,(function(o,c){var n=e.__get_orig(o),r=5===o||6===o?e.getClassOptionIndex(t["course_slot_"+o+"_class"]):null,s=5===o||6===o?e.getTypeIndex(t["course_slot_"+o+"_type"]):null,a=5!==o&&6!==o?e.getTypeIndex(t["course_slot_"+o+"_type"]):null;return{$orig:n,m1:r,m2:s,m3:a}}));return{$orig:c,m0:n,l0:r}})):null);e.$mp.data=Object.assign({},{$root:{l1:o}})},n=[]},f44b:function(e,t,o){"use strict";(function(e,c){var n=o("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=n(o("7eb4")),s=n(o("7ca3")),a=n(o("ee10")),l=o("8bf8");function i(e,t){var o="undefined"!==typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!o){if(Array.isArray(e)||(o=function(e,t){if(!e)return;if("string"===typeof e)return u(e,t);var o=Object.prototype.toString.call(e).slice(8,-1);"Object"===o&&e.constructor&&(o=e.constructor.name);if("Map"===o||"Set"===o)return Array.from(e);if("Arguments"===o||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(o))return u(e,t)}(e))||t&&e&&"number"===typeof e.length){o&&(e=o);var c=0,n=function(){};return{s:n,n:function(){return c>=e.length?{done:!0}:{done:!1,value:e[c++]}},e:function(e){throw e},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,s=!0,a=!1;return{s:function(){o=o.call(e)},n:function(){var e=o.next();return s=e.done,e},e:function(e){a=!0,r=e},f:function(){try{s||null==o.return||o.return()}finally{if(a)throw r}}}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var o=0,c=new Array(t);o<t;o++)c[o]=e[o];return c}function h(e,t){var o=Object.keys(e);if(Object.getOwnPropertySymbols){var c=Object.getOwnPropertySymbols(e);t&&(c=c.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),o.push.apply(o,c)}return o}function d(e){for(var t=1;t<arguments.length;t++){var o=null!=arguments[t]?arguments[t]:{};t%2?h(Object(o),!0).forEach((function(t){(0,s.default)(e,t,o[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(o)):h(Object(o)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(o,t))}))}return e}function f(e){var t=e.getFullYear(),o=(e.getMonth()+1).toString().padStart(2,"0"),c=e.getDate().toString().padStart(2,"0");return"".concat(t,"-").concat(o,"-").concat(c)}var g={data:function(){return{allTeacherList:[],teacherIndex:-1,searchKeyword:"",selectedTeacher:null,rawScheduleList:[],weekSchedule:[],isLoading:!1,weekOffset:0,initialScheduleState:"",courseTypes:["无","一对一","班课","脱产生","习惯班"],courseOptions:["一年级","二年级","三年级","四年级","五年级","六年级","七年级","八年级","九年级","高一","背诵"],periods:[1,2,3,4,5,6],periodTimes:["8:00-10:00","10:10-12:10","14:00-16:00","16:10-18:10","18:00-20:00","20:00-22:00"],weekDaysOrder:[1,2,3,4,5,6,0],currentDate:function(){var e=new Date;e.setHours(0,0,0,0);var t=e.getDay(),o=0===t?6:t-1;return e.setDate(e.getDate()-o),e}()}},computed:{filteredTeacherList:function(){var e=this;return this.searchKeyword?this.allTeacherList.filter((function(t){return t.teacherName&&t.teacherName.toLowerCase().includes(e.searchKeyword.toLowerCase())})):this.allTeacherList},weekTitle:function(){return"这周课程"},weekRangeText:function(){var e=this.getMondayOfWeek(),t=new Date(e);return t.setDate(e.getDate()+6),"".concat(f(e)," ~ ").concat(f(t))}},watch:{weekSchedule:{handler:function(t){if(this.selectedTeacher&&t.length>0){var o=this.selectedTeacher._id,c=this.getMondayOfWeek(this.currentDate),n=f(c),r="teacherScheduleCache_"+o+"_"+n;e.setStorageSync(r,t),console.log("数据已自动保存到缓存")}},deep:!0}},onShow:function(){var t=this;console.log("📱 页面显示，开始初始化...");var o=e.getStorageSync("userInfo"),c="";this.selectedTeacher&&this.selectedTeacher._id?(c=this.selectedTeacher._id,console.log("👤 使用已选中的教师ID:",c)):o&&o._id&&(c=o._id,console.log("👤 使用当前用户ID作为教师ID:",c)),console.log("👤 当前教师ID:",c),this.currentDate=this.getMondayOfWeek(new Date);var n=this.currentDate,r=f(n);console.log("📅 当前周:",r);var s="teacherScheduleCache_"+c+"_"+r,a=e.getStorageSync(s);a&&Array.isArray(a)&&7===a.length?(console.log("📦 发现缓存数据，长度:",a.length),this.weekSchedule=a,setTimeout((function(){t.selectedTeacher&&(console.log("🔄 异步更新数据..."),t.fetchTeacherSchedule())}),100)):(console.log("🆕 无缓存数据，构建新的周计划"),this.buildWeekSchedule()),this.checkAdminRoleAndFetchTeachers()},onUnload:function(){var t=e.getStorageSync("fromService");t&&(e.switchTab({url:"/pages/service/service"}),e.removeStorageSync("fromService"))},methods:{checkAdminRoleAndFetchTeachers:function(){var t=e.getStorageSync("userInfo"),o=t&&t.role&&t.role.includes("管理员")||"管理员"===t.permission,c=t&&"superadmin"===t.permission,n=t&&t.featureList&&t.featureList.includes("schedule");if(!(o||c||n))return e.showToast({title:"无权限访问",icon:"none"}),void setTimeout((function(){e.reLaunch({url:"/pages/home/home"})}),1200);this.fetchTeachers()},fetchTeachers:function(){var t=this;c.callFunction({name:"user-center",data:{action:"get-accounts"},success:function(){var o=(0,a.default)(r.default.mark((function o(c){var n;return r.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:if(n=c.result,200!==n.code||!n.data){o.next=8;break}return t.allTeacherList=n.data.filter((function(e){return e.role&&e.role.includes("教师")})),o.next=5,t.enrichTeachersWithOpenid();case 5:t.allTeacherList.length>0?t.selectTeacher(0):e.showToast({title:"暂无教师信息",icon:"none"}),o.next=9;break;case 8:e.showToast({title:"获取教师列表失败: "+(n.message||"未知错误"),icon:"none"});case 9:case"end":return o.stop()}}),o)})));return function(e){return o.apply(this,arguments)}}(),fail:function(t){e.showToast({title:"获取教师列表请求失败",icon:"none"})}})},enrichTeachersWithOpenid:function(){var e=this;return(0,a.default)(r.default.mark((function t(){var o,n,s,a;return r.default.wrap((function(t){while(1)switch(t.prev=t.next){case 0:t.prev=0,console.log("🔍 开始补充教师openid信息..."),o=0;case 3:if(!(o<e.allTeacherList.length)){t.next=18;break}return n=e.allTeacherList[o],t.prev=5,t.next=8,c.callFunction({name:"user-center",data:{action:"get-user-detail",params:{userId:n._id}}});case 8:s=t.sent,s.result&&200===s.result.code&&(a=s.result.data,a.openid?(e.allTeacherList[o].openid=a.openid,console.log("✅ 教师 ".concat(n.teacherName||n.username," openid 获取成功"))):console.log("⚠️ 教师 ".concat(n.teacherName||n.username," 没有openid"))),t.next=15;break;case 12:t.prev=12,t.t0=t["catch"](5),console.error("❌ 获取教师 ".concat(n.teacherName||n.username," openid 失败:"),t.t0);case 15:o++,t.next=3;break;case 18:console.log("✅ 教师openid信息补充完成"),t.next=24;break;case 21:t.prev=21,t.t1=t["catch"](0),console.error("❌ 补充教师openid信息失败:",t.t1);case 24:case"end":return t.stop()}}),t,null,[[0,21],[5,12]])})))()},selectTeacher:function(e){console.log("👤 选择教师，索引:",e),this.teacherIndex=e,this.selectedTeacher=this.filteredTeacherList[e],console.log("选中的教师:",this.selectedTeacher),this.currentDate=this.getMondayOfWeek(new Date),this.rawScheduleList=[],this.weekSchedule=[],this.initialScheduleState="",console.log("🔄 开始获取选中教师的课表..."),this.fetchTeacherSchedule()},fetchTeacherSchedule:function(){var t=this;if(this.selectedTeacher){this.isLoading=!0;var o=this.selectedTeacher._id,n=this.getMondayOfWeek(),r=new Date(n);r.setDate(n.getDate()+6),console.log("🔍 开始获取教师课表数据..."),console.log("选中的教师:",this.selectedTeacher),console.log("教师ID:",o),console.log("查询日期范围:",f(n),"到",f(r)),c.callFunction({name:"schedule-center",data:{action:"getSchedulesByTeacher",params:{teacher_id:o,startDate:f(n),endDate:f(r)}},success:function(c){console.log("📡 云函数返回结果:",c);var r=c.result;if(200===r.code&&r.data){console.log("✅ 获取课表数据成功，数据条数:",r.data.length),console.log("原始数据:",r.data),t.rawScheduleList=r.data,t.buildWeekSchedule();var s=f(n),a="teacherScheduleCache_"+o+"_"+s;e.setStorageSync(a,t.weekSchedule),console.log("✅ 新数据已保存到缓存")}else console.error("❌ 获取课表数据失败:",r.message||"未知错误"),t.rawScheduleList=[],t.buildWeekSchedule()},fail:function(e){console.error("❌ 请求失败:",e),t.rawScheduleList=[],t.buildWeekSchedule()},complete:function(){t.isLoading=!1,console.log("🏁 课表获取完成")}})}},buildWeekSchedule:function(){var e=this;this.currentDate=this.getMondayOfWeek(this.currentDate);var t=this.currentDate;console.log("🔨 开始构建周计划..."),console.log("当前日期:",this.currentDate),console.log("周一日期:",t),console.log("原始数据列表:",this.rawScheduleList),this.weekSchedule=[];for(var o=[],c=function(c){var n=new Date(t.getTime()+24*c*60*60*1e3),r=f(n);console.log("📅 处理第".concat(c,"天，日期: ").concat(r));var s={course_date:r,course_slot_1:"",course_slot_1_type:"无",course_slot_1_class:"",course_slot_1_location:"",course_slot_1_remark:"",course_slot_2:"",course_slot_2_type:"无",course_slot_2_class:"",course_slot_2_location:"",course_slot_2_remark:"",course_slot_3:"",course_slot_3_type:"无",course_slot_3_class:"",course_slot_3_location:"",course_slot_3_remark:"",course_slot_4:"",course_slot_4_type:"无",course_slot_4_class:"",course_slot_4_location:"",course_slot_4_remark:"",course_slot_5:"",course_slot_5_type:"无",course_slot_5_class:"",course_slot_5_location:"",course_slot_5_remark:"",course_slot_6:"",course_slot_6_type:"无",course_slot_6_class:"",course_slot_6_location:"",course_slot_6_remark:""},a=e.rawScheduleList.filter((function(e){var t=e.date;"string"===typeof t&&t.length>=10?t=t.slice(0,10):t instanceof Date&&(t=f(t));var o=t===r;return console.log("  课程日期: ".concat(t,", 匹配: ").concat(o)),o}));console.log("  找到 ".concat(a.length," 门课程")),a.forEach((function(e){if(console.log("  📚 处理课程: ".concat(e.course_name,", 时间段: ").concat(e.start_period)),e.start_period<1||e.start_period>6)console.log("    ⚠️ 时间段超出范围: ".concat(e.start_period));else{var t=e.start_period;t>=1&&t<=6&&(s["course_slot_".concat(t)]=e.course_name||"",s["course_slot_".concat(t,"_type")]=e.course_type||"无",s["course_slot_".concat(t,"_class")]=e.class_name||"",s["course_slot_".concat(t,"_location")]=e.location||"",s["course_slot_".concat(t,"_remark")]=e.remark||"",console.log("    ✅ 已映射到第".concat(t,"节课:"),{"课程名":e.course_name,"类型":e.course_type,"班级":e.class_name,"教室":e.location,"备注":e.remark}))}})),o.push(s),console.log("  📋 第".concat(c,"天课表:"),s)},n=0;n<7;n++)c(n);this.weekSchedule=o,this.initialScheduleState=JSON.stringify(this.weekSchedule),console.log("🎯 周计划构建完成:"),console.log("日期列表:",this.weekSchedule.map((function(e){return e.course_date}))),console.log("第一天数据结构:",this.weekSchedule[0]),this.$forceUpdate()},getMondayOfWeek:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.currentDate,t=new Date(e);t.setHours(0,0,0,0);var o=t.getDay(),c=0===o?6:o-1;return t.setDate(t.getDate()-c),t},onInputChange:function(t,o,c,n){var r=n?"course_slot_".concat(c,"_").concat(n):"course_slot_".concat(c),s=t.detail.value;if(console.log("输入事件触发:",{dayIndex:o,slot:c,field:n,value:s,event:t}),this.weekSchedule[o]){this.weekSchedule[o][r]=s,console.log("数据已更新:",{dayIndex:o,slot:c,field:n,value:s,key:r});var a=this.selectedTeacher?this.selectedTeacher._id:"",l=this.getMondayOfWeek(this.currentDate),i=f(l),u="teacherScheduleCache_"+a+"_"+i;e.setStorageSync(u,this.weekSchedule),console.log("数据已保存到缓存")}},onTypeChange:function(t,o,c){if(this.weekSchedule[o]){this.weekSchedule[o]["course_slot_".concat(c,"_type")]=this.courseTypes[t.detail.value],console.log("类型变化:",{dayIndex:o,slot:c,value:this.courseTypes[t.detail.value]});var n=this.selectedTeacher?this.selectedTeacher._id:"",r=this.getMondayOfWeek(this.currentDate),s=f(r),a="teacherScheduleCache_"+n+"_"+s;e.setStorageSync(a,this.weekSchedule)}},getTypeIndex:function(e){return this.courseTypes.indexOf(e)},getCourseOptionIndex:function(e){return this.courseOptions.indexOf(e)},getClassOptionIndex:function(e){return this.courseOptions.indexOf(e)},onCourseOptionChange:function(t,o,c){if(this.weekSchedule[o]){this.weekSchedule[o]["course_slot_".concat(c)]=this.courseOptions[t.detail.value],console.log("课程选项变化:",{dayIndex:o,slot:c,value:this.courseOptions[t.detail.value]});var n=this.selectedTeacher?this.selectedTeacher._id:"",r=this.getMondayOfWeek(this.currentDate),s=f(r),a="teacherScheduleCache_"+n+"_"+s;e.setStorageSync(a,this.weekSchedule)}},onClassOptionChange:function(t,o,c){if(this.weekSchedule[o]){var n=this.courseOptions[t.detail.value];this.weekSchedule[o]["course_slot_".concat(c,"_class")]=n,this.weekSchedule[o]["course_slot_".concat(c)]=n,console.log("班级选项变化:",{dayIndex:o,slot:c,value:n});var r=this.selectedTeacher?this.selectedTeacher._id:"",s=this.getMondayOfWeek(this.currentDate),a=f(s),l="teacherScheduleCache_"+r+"_"+a;e.setStorageSync(l,this.weekSchedule)}},changeWeek:function(t){var o=this;console.log("📅 切换周，偏移量:",t);var c=this.getMondayOfWeek(this.currentDate);c.setDate(c.getDate()+7*t),this.currentDate=c,console.log("新的当前日期:",this.currentDate),this.rawScheduleList=[],this.weekSchedule=[];var n=this.selectedTeacher?this.selectedTeacher._id:"",r=f(c),s="teacherScheduleCache_"+n+"_"+r,a=e.getStorageSync(s);a&&Array.isArray(a)&&7===a.length?(console.log("📦 发现缓存数据，长度:",a.length),this.weekSchedule=a,setTimeout((function(){o.selectedTeacher&&(console.log("🔄 异步更新数据..."),o.fetchTeacherSchedule())}),100)):(console.log("🆕 无缓存数据，重新获取数据"),this.selectedTeacher?this.fetchTeacherSchedule():this.buildWeekSchedule())},saveSchedule:function(){var t=this,o=this.weekSchedule.map((function(e){return d(d({},e),{},{teacher_id:t.selectedTeacher._id,uid:t.selectedTeacher._id,username:t.selectedTeacher.username})})),n=e.getStorageSync("userInfo"),s=n.realName||n.username||"管理员";c.callFunction({name:"schedule-center",data:{action:"updateSchedules",params:{schedules:o,adminName:s}},success:function(){var c=(0,a.default)(r.default.mark((function c(n){var s,a,l,i;return r.default.wrap((function(c){while(1)switch(c.prev=c.next){case 0:if(200!==n.result.code){c.next=12;break}return e.showToast({title:"排课保存成功!",icon:"success"}),s=t.selectedTeacher?t.selectedTeacher._id:"",a=t.getMondayOfWeek(t.currentDate),l=f(a),i="teacherScheduleCache_"+s+"_"+l,e.setStorageSync(i,t.weekSchedule),c.next=9,t.sendScheduleNotifications(o);case 9:t.fetchTeacherSchedule(),c.next=13;break;case 12:e.showToast({title:"保存失败: "+n.result.message,icon:"none"});case 13:case"end":return c.stop()}}),c)})));return function(e){return c.apply(this,arguments)}}(),fail:function(t){e.showToast({title:"保存请求失败",icon:"none"})}})},sendScheduleNotifications:function(e){var t=this;return(0,a.default)(r.default.mark((function o(){var n,s,a,l,u,h,f,g,p,_,m,S,v,T,y,k,b,w,D,x,O,C,W,N;return r.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:o.prev=0,console.log("开始发送排课订阅消息通知..."),n=t.selectedTeacher._id,s=null,a=null,l=null,u=i(e),o.prev=7,u.s();case 9:if((h=u.n()).done){o.next=18;break}if(f=h.value,g=f.course_date,p=f.uid,f.username,p===n){o.next=15;break}return console.log("跳过非当前教师的课程: ".concat(p," vs ").concat(n)),o.abrupt("continue",16);case 15:for(_=1;_<=6;_++)m="course_slot_".concat(_),S="course_slot_".concat(_,"_type"),v="course_slot_".concat(_,"_class"),T="course_slot_".concat(_,"_location"),y=f[m],k=f[S],b=f[v],w=f[T],y&&""!==y.trim()&&(D=new Date("".concat(g," ").concat(t.getSlotStartTime(_))),(!l||D>l)&&(l=D,s=f,a={courseName:y,courseType:k,className:b,location:w,date:g,slot:_},console.log("找到更晚的课程:",a,"时间:",D)));case 16:o.next=9;break;case 18:o.next=23;break;case 20:o.prev=20,o.t0=o["catch"](7),u.e(o.t0);case 23:return o.prev=23,u.f(),o.finish(23);case 26:if(!s||!a){o.next=58;break}if(console.log("准备发送最新排课课程的订阅消息:",a),x=t.selectedTeacher.openid||"",console.log("教师openid信息:",{teacherId:t.selectedTeacher._id,teacherName:t.selectedTeacher.teacherName||t.selectedTeacher.username,openid:x,hasOpenid:!!x,openidType:x?x.startsWith("mock_")?"测试模式":x.startsWith("temp_")?"临时模式":"真实openid":"无openid"}),x){o.next=33;break}return console.log("⚠️ 教师 ".concat(t.selectedTeacher.teacherName||t.selectedTeacher.username," 没有openid，跳过订阅消息发送")),o.abrupt("return");case 33:if(!x.startsWith("mock_")&&!x.startsWith("temp_")){o.next=36;break}return console.log("⚠️ 教师 ".concat(t.selectedTeacher.teacherName||t.selectedTeacher.username," 使用测试openid: ").concat(x,"，跳过订阅消息发送")),o.abrupt("return");case 36:if(o.prev=36,O=t.checkSessionSubscription(x),!O){o.next=46;break}return console.log("✅ 使用会话订阅发送排课通知，避免微信API限制"),o.next=42,t.sendScheduleNotificationWithSession(d(d({},a),{},{openid:x}));case 42:C=o.sent,C.success?console.log("最新排课课程会话订阅消息发送成功: ".concat(a.courseName)):console.log("会话订阅消息发送失败: ".concat(C.error)),o.next=51;break;case 46:return console.log("📱 使用微信API发送订阅消息"),o.next=49,c.callFunction({name:"subscription-message",data:{action:"send-schedule-notification",openid:t.selectedTeacher.openid||"",courseName:a.courseName,classTime:t.formatClassTime(a.date,a.slot),remark:(a.location||"未指定")+"教室",studentName:a.courseType||"未指定类型",page:"pages/schedule-tab/schedule-tab"}});case 49:W=o.sent,W.result&&200===W.result.code?console.log("最新排课课程订阅消息发送成功: ".concat(a.courseName)):(N=W.result&&W.result.error?W.result.error:"",console.log("最新排课课程订阅消息发送失败:",{message:W.result&&W.result.message?W.result.message:"",error:N,code:W.result&&W.result.code?W.result.code:""}),N&&N.includes("43101")&&(console.log('⚠️ 课程 "'.concat(a.courseName,'" 订阅消息被用户拒绝，需要重新授权')),t.createSessionSubscriptionForTeacher(x)));case 51:o.next=56;break;case 53:o.prev=53,o.t1=o["catch"](36),console.error("最新排课课程订阅消息发送失败:",o.t1);case 56:o.next=59;break;case 58:console.log("未找到需要发送订阅消息的课程");case 59:console.log("排课订阅消息通知发送完成"),o.next=65;break;case 62:o.prev=62,o.t2=o["catch"](0),console.error("发送排课订阅消息通知失败:",o.t2);case 65:case"end":return o.stop()}}),o,null,[[0,62],[7,20,23,26],[36,53]])})))()},getSlotStartTime:function(e){return["08:00","10:10","14:00","16:10","18:00","20:00"][e-1]||"08:00"},formatClassTime:function(e,t){var o=new Date(e),c=o.getFullYear(),n=(o.getMonth()+1).toString().padStart(2,"0"),r=o.getDate().toString().padStart(2,"0"),s=["08:00","10:10","14:00","16:10","18:00","20:00"][t-1]||"08:00";return"".concat(c,"-").concat(n,"-").concat(r," ").concat(s)},getDayOfWeek:function(e){var t=new Date(e).getDay();return["周日","周一","周二","周三","周四","周五","周六"][t]},getDayOfWeekIndex:function(e){return new Date(e).getDay()},getCourseColor:function(e,t){return(0,l.getCourseColor)(e,t)},goHome:function(){e.switchTab({url:"/pages/service/service"})},returnToCurrentWeek:function(){this.currentDate=this.getMondayOfWeek(new Date),this.buildWeekSchedule()},formatDateWithWeek:function(e){if(!e)return"";var t=new Date(e),o=t.getFullYear(),c=(t.getMonth()+1).toString().padStart(2,"0"),n=t.getDate().toString().padStart(2,"0"),r=["周日","周一","周二","周三","周四","周五","周六"][t.getDay()];return"".concat(o,"-").concat(c,"-").concat(n," ").concat(r)},onInputFocus:function(e){console.log("输入框获得焦点:",e)},checkSessionSubscription:function(t){try{var o="session_subscription_".concat(t),c=e.getStorageSync(o);if(c&&c.isValid){var n=Date.now();return n<c.expireTime?(console.log("✅ 找到有效的会话订阅"),!0):(console.log("⚠️ 会话订阅已过期"),!1)}return!1}catch(r){return console.error("检查会话订阅失败:",r),!1}},createSessionSubscriptionForTeacher:function(t){try{var o="session_subscription_".concat(t),c={isValid:!0,createTime:Date.now(),expireTime:Date.now()+864e5,usageCount:0,openid:t,type:"teacher_schedule"};return e.setStorageSync(o,c),console.log("🔐 为教师创建会话订阅成功:",c),!0}catch(n){return console.error("创建教师会话订阅失败:",n),!1}},sendScheduleNotificationWithSession:function(t){var o=this;return(0,a.default)(r.default.mark((function n(){var s,a,l;return r.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.prev=0,console.log("🔐 使用会话订阅发送排课通知..."),console.log("📤 发送参数:",{openid:t.openid,courseName:t.courseName,classTime:o.formatClassTime(t.date,t.slot),remark:(t.location||"未指定")+"教室",studentName:t.courseType||"未指定类型",isSessionSubscription:!0}),n.next=5,c.callFunction({name:"subscription-message",data:{action:"send-schedule-notification",openid:t.openid,courseName:t.courseName,classTime:o.formatClassTime(t.date,t.slot),remark:(t.location||"未指定")+"教室",studentName:t.courseType||"未指定类型",page:"pages/schedule-tab/schedule-tab",isSessionSubscription:!0}});case 5:if(s=n.sent,console.log("📥 云函数返回结果:",s),!s.result||200!==s.result.code){n.next=17;break}return console.log("✅ 会话订阅消息发送成功"),console.log("📊 返回数据:",s.result.data),a=s.result.data&&s.result.data.method,"session_subscription_bypass"===a&&(console.log("🎯 使用会话订阅特殊策略处理成功"),e.showModal({title:"会话订阅模式",content:"您的订阅消息已通过会话订阅模式处理成功！\n\n特点：\n• 无需重复授权\n• 可以无限次使用\n• 消息记录完整\n• 避免微信限制\n\n注意：这是会话订阅模式，消息会记录但不会重复发送微信通知。",showCancel:!1,confirmText:"明白了"})),o.logSessionScheduleMessage(t,s.result),o.updateSessionUsage(t.openid),n.abrupt("return",{success:!0,data:s.result});case 17:return console.log("❌ 会话订阅消息发送失败:",s.result&&s.result.message?s.result.message:"未知错误"),console.log("🔍 详细错误信息:",s.result),l=s.result&&s.result.error?s.result.error:"",l&&l.includes("43101")&&(console.log("⚠️ 检测到43101错误，用户需要重新授权订阅消息"),e.showModal({title:"订阅消息发送失败",content:'您的订阅消息授权已失效，需要重新授权才能接收通知。\n\n建议：\n1. 进入"订阅设置"页面\n2. 重新开启订阅开关\n3. 完成微信授权',showCancel:!0,cancelText:"稍后处理",confirmText:"去设置",success:function(t){t.confirm&&e.navigateTo({url:"/pages/subscription-settings/subscription-settings"})}})),n.next=23,o.fallbackToTraditionalSubscription(t);case 23:return n.abrupt("return",n.sent);case 24:n.next=32;break;case 26:return n.prev=26,n.t0=n["catch"](0),console.error("会话订阅发送排课通知失败:",n.t0),n.next=31,o.fallbackToTraditionalSubscription(t);case 31:return n.abrupt("return",n.sent);case 32:case"end":return n.stop()}}),n,null,[[0,26]])})))()},fallbackToTraditionalSubscription:function(e){var t=this;return(0,a.default)(r.default.mark((function o(){var n;return r.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:return o.prev=0,console.log("🔄 降级到传统订阅方式..."),o.next=4,c.callFunction({name:"subscription-message",data:{action:"send-schedule-notification",openid:e.openid,courseName:e.courseName,classTime:t.formatClassTime(e.date,e.slot),remark:(e.location||"未指定")+"教室",studentName:e.courseType||"未指定类型",page:"pages/schedule-tab/schedule-tab",isSessionSubscription:!1}});case 4:if(n=o.sent,!n.result||200!==n.result.code){o.next=10;break}return console.log("✅ 传统订阅方式发送成功"),o.abrupt("return",{success:!0,data:n.result,method:"traditional"});case 10:return console.log("❌ 传统订阅方式也失败:",n.result&&n.result.message?n.result.message:"未知错误"),o.abrupt("return",{success:!1,error:n.result&&n.result.message?n.result.message:"发送失败"});case 12:o.next=18;break;case 14:return o.prev=14,o.t0=o["catch"](0),console.error("传统订阅方式失败:",o.t0),o.abrupt("return",{success:!1,error:o.t0.message});case 18:case"end":return o.stop()}}),o,null,[[0,14]])})))()},logSessionScheduleMessage:function(t,o){try{var c=e.getStorageSync("session_schedule_messages")||[];c.push(d(d({},t),{},{result:o,timestamp:Date.now(),type:"schedule_notification"})),c.length>100&&c.splice(0,c.length-100),e.setStorageSync("session_schedule_messages",c),console.log("📝 会话排课消息已记录到本地日志")}catch(n){console.error("记录会话排课消息失败:",n)}},updateSessionUsage:function(t){try{var o="session_subscription_".concat(t),c=e.getStorageSync(o);c&&(c.usageCount=(c.usageCount||0)+1,c.lastUsageTime=Date.now(),c.expireTime=Date.now()+864e5,e.setStorageSync(o,c),console.log("📊 教师会话订阅使用次数: ".concat(c.usageCount)))}catch(n){console.error("更新会话使用次数失败:",n)}},formatDate:function(e){var t=e.getFullYear(),o=String(e.getMonth()+1).padStart(2,"0"),c=String(e.getDate()).padStart(2,"0");return"".concat(t,"-").concat(o,"-").concat(c)}}};t.default=g}).call(this,o("df3c")["default"],o("861b")["uniCloud"])}},[["4873","common/runtime","common/vendor"]]]);