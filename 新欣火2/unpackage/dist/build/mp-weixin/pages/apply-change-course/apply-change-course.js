(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/apply-change-course/apply-change-course"],{"045e":function(e,t,a){"use strict";a.r(t);var n=a("6f17"),o=a.n(n);for(var r in n)["default"].indexOf(r)<0&&function(e){a.d(t,e,(function(){return n[e]}))}(r);t["default"]=o.a},"0c7a":function(e,t,a){},1663:function(e,t,a){"use strict";var n=a("0c7a"),o=a.n(n);o.a},"3f81":function(e,t,a){"use strict";a.d(t,"b",(function(){return n})),a.d(t,"c",(function(){return o})),a.d(t,"a",(function(){}));var n=function(){var e=this.$createElement,t=(this._self._c,this.formData.reason.length);this.$mp.data=Object.assign({},{$root:{g0:t}})},o=[]},4687:function(e,t,a){"use strict";a.r(t);var n=a("3f81"),o=a("045e");for(var r in o)["default"].indexOf(r)<0&&function(e){a.d(t,e,(function(){return o[e]}))}(r);a("1663");var i=a("828b"),s=Object(i["a"])(o["default"],n["b"],n["c"],!1,null,"74a1dbe0",null,!1,n["a"],void 0);t["default"]=s.exports},"6f17":function(e,t,a){"use strict";(function(e,n){var o=a("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=o(a("7eb4")),i=o(a("ee10")),s={data:function(){return{courseInfo:{courseName:"",date:"",time:"",location:"",className:"",courseId:""},formData:{reason:"",newDate:"",newTime:""},today:"",timeOptions:["8:00-10:00","10:10-12:10","14:00-16:00","16:10-18:10","18:00-20:00","20:00-22:00"],timeIndex:-1,statusBarHeight:0,topBarPadding:0,isDetail:!1}},computed:{canSubmit:function(){return this.formData.reason.trim()&&this.formData.newDate&&this.formData.newTime},statusBarStyle:function(){return"height: ".concat(this.statusBarHeight,"px; background-color: #1976D2;")},topBarStyle:function(){return"padding-top: ".concat(this.topBarPadding,"px; background-color: #1976D2;")}},onLoad:function(t){var a=new Date;if(this.today=a.toISOString().split("T")[0],t.changeId?this.loadChangeDetail(t.changeId):t.courseInfo&&(this.courseInfo=JSON.parse(decodeURIComponent(t.courseInfo))),this.courseInfo.date&&this.courseInfo.time){var n=new Date,o=new Date(this.courseInfo.date),r=new Date(n.getFullYear(),n.getMonth(),n.getDate()+6);if(o<r)return e.showToast({title:"只能调五天之后的课程",icon:"none"}),void setTimeout((function(){e.navigateBack()}),1200);var i=null,s=null,c=/(\d{1,2}):(\d{2})-/.exec(this.courseInfo.time);if(c&&(i=parseInt(c[1],10),s=parseInt(c[2],10)),o.getFullYear()===n.getFullYear()&&o.getMonth()===n.getMonth()&&o.getDate()===n.getDate()&&null!==i&&null!==s){var u=60*n.getHours()+n.getMinutes(),l=60*i+s;u>=l&&(e.showToast({title:"课程已开始，无法调课",icon:"none"}),setTimeout((function(){e.navigateBack()}),1200))}}var f=e.getSystemInfoSync();this.statusBarHeight=f.statusBarHeight||20,this.topBarPadding=f.statusBarHeight?f.statusBarHeight/2:10},methods:{goBack:function(){e.navigateBack()},onDateChange:function(e){this.formData.newDate=e.detail.value},onTimeChange:function(e){this.timeIndex=e.detail.value,this.formData.newTime=this.timeOptions[this.timeIndex]},loadChangeDetail:function(t){var a=this;return(0,i.default)(r.default.mark((function o(){var i,s;return r.default.wrap((function(o){while(1)switch(o.prev=o.next){case 0:return o.prev=0,e.showLoading({title:"加载中..."}),o.next=4,n.database().collection("course_change_requests").doc(t).get();case 4:if(i=o.sent,s=i.result.data&&i.result.data[0],s){o.next=10;break}return e.showToast({title:"未找到调课申请",icon:"none"}),setTimeout((function(){e.navigateBack()}),1200),o.abrupt("return");case 10:a.courseInfo={courseName:s.courseName||"",date:s.originalDate||"",time:s.originalTime||"",location:s.location||"",className:s.className||"",courseId:s.courseId||""},a.formData={reason:s.reason||"",newDate:s.newDate||"",newTime:s.newTime||""},a.isDetail=!0,o.next=19;break;case 15:o.prev=15,o.t0=o["catch"](0),e.showToast({title:"加载失败",icon:"none"}),setTimeout((function(){e.navigateBack()}),1200);case 19:return o.prev=19,e.hideLoading(),o.finish(19);case 22:case"end":return o.stop()}}),o,null,[[0,15,19,22]])})))()},submitApplication:function(){var t=this;return(0,i.default)(r.default.mark((function a(){var o,i;return r.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(o=e.getStorageSync("userInfo"),console.log("提交参数",{courseId:t.courseInfo.courseId,originalDate:t.courseInfo.date,originalTime:t.courseInfo.time,reason:t.formData.reason,newDate:t.formData.newDate,newTime:t.formData.newTime,teacherId:o._id,teacherName:o.teacherName||o.username}),t.canSubmit){a.next=5;break}return e.showToast({title:"请填写完整信息",icon:"none"}),a.abrupt("return");case 5:if(t.courseInfo.courseId){a.next=8;break}return e.showToast({title:"课程ID缺失，无法提交",icon:"none"}),a.abrupt("return");case 8:return a.prev=8,e.showLoading({title:"提交中..."}),a.next=12,n.callFunction({name:"course-change",data:{action:"submit",courseId:t.courseInfo.courseId,originalDate:t.courseInfo.date,originalTime:t.courseInfo.time,reason:t.formData.reason,newDate:t.formData.newDate,newTime:t.formData.newTime,teacherId:o._id,teacherName:o.teacherName||o.username}});case 12:i=a.sent,console.log("云函数返回",i),i.result&&i.result.success||i.success?(e.showToast({title:"申请提交成功",icon:"success"}),setTimeout((function(){e.navigateBack()}),1500)):(console.error("云函数错误详情",i.result&&i.result.error||i.error),e.showToast({title:i.result&&i.result.message||i.message||"提交失败",icon:"none"})),a.next=21;break;case 17:a.prev=17,a.t0=a["catch"](8),console.error("云函数异常",a.t0),e.showToast({title:"提交失败，请重试",icon:"none"});case 21:return a.prev=21,e.hideLoading(),a.finish(21);case 24:case"end":return a.stop()}}),a,null,[[8,17,21,24]])})))()}}};t.default=s}).call(this,a("df3c")["default"],a("861b")["uniCloud"])},d391:function(e,t,a){"use strict";(function(e,t){var n=a("47a9");a("a226"),a("861b");n(a("3240"));var o=n(a("4687"));e.__webpack_require_UNI_MP_PLUGIN__=a,t(o.default)}).call(this,a("3223")["default"],a("df3c")["createPage"])}},[["d391","common/runtime","common/vendor"]]]);