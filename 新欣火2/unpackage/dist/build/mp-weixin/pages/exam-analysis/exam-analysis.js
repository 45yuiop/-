(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/exam-analysis/exam-analysis"],{1952:function(e,t,a){},"25e0":function(e,t,a){"use strict";a.r(t);var s=a("5307"),n=a("a346");for(var i in n)["default"].indexOf(i)<0&&function(e){a.d(t,e,(function(){return n[e]}))}(i);a("4451");var o=a("828b"),r=Object(o["a"])(n["default"],s["b"],s["c"],!1,null,"4c9fe918",null,!1,s["a"],void 0);t["default"]=r.exports},4451:function(e,t,a){"use strict";var s=a("1952"),n=a.n(s);n.a},5307:function(e,t,a){"use strict";a.d(t,"b",(function(){return s})),a.d(t,"c",(function(){return n})),a.d(t,"a",(function(){}));var s=function(){var e=this.$createElement,t=(this._self._c,this.examImageFileIDs.length),a=this.examImageFileIDs.length,s=this.examImages.length,n=this.analysisImageFileIDs.length,i=this.analysisImageFileIDs.length,o=this.analysisImages.length;this.$mp.data=Object.assign({},{$root:{g0:t,g1:a,g2:s,g3:n,g4:i,g5:o}})},n=[]},a346:function(e,t,a){"use strict";a.r(t);var s=a("d022"),n=a.n(s);for(var i in s)["default"].indexOf(i)<0&&function(e){a.d(t,e,(function(){return s[e]}))}(i);t["default"]=n.a},ba33:function(e,t,a){"use strict";(function(e,t){var s=a("47a9");a("a226"),a("861b");s(a("3240"));var n=s(a("25e0"));e.__webpack_require_UNI_MP_PLUGIN__=a,t(n.default)}).call(this,a("3223")["default"],a("df3c")["createPage"])},d022:function(e,t,a){"use strict";(function(e,s){var n=a("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(a("7eb4")),o=n(a("7ca3")),r=n(a("af34")),c=n(a("ee10"));function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);t&&(s=s.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,s)}return a}function u(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){(0,o.default)(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}var d={components:{ImageZoomViewer:function(){a.e("components/ImageZoomViewer").then(function(){return resolve(a("f9eb"))}.bind(null,a)).catch(a.oe)}},data:function(){return{gradeList:[],gradeIndex:0,selectedGrade:"",studentList:[],studentIndex:0,selectedStudent:null,yearList:[],yearIndex:0,selectedYear:"",monthList:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],monthIndex:0,selectedMonth:"",examTypes:["期中","元调","二调","四调","中考","月考","期末"],selectedExamType:"",customExamType:"",examImages:[],examImageFileIDs:[],analysisText:"",analysisImages:[],analysisImageFileIDs:[],difficultyRating:0,studentPerformance:0,isEdit:!1,editId:"",showImageZoom:!1,currentImages:[],currentImageIndex:0}},onLoad:function(t){var a=this;try{console.log("试卷分析页面加载开始");var s=e.getStorageSync("userInfo");console.log("onLoad - userInfo:",s),this.initYearList(),this.initDefaultValues(),this.loadGradeList(),t.id&&(this.isEdit=!0,this.editId=t.id,setTimeout((function(){a.loadAnalysisDetail(t.id)}),100)),console.log("试卷分析页面加载完成")}catch(n){console.error("试卷分析页面加载失败:",n),e.showToast({title:"页面加载失败",icon:"none"})}},methods:{initYearList:function(){try{console.log("初始化年份列表");for(var e=(new Date).getFullYear(),t=e-5;t<=e+1;t++)this.yearList.push(t+"年");this.selectedYear=this.yearList[0],console.log("年份列表初始化完成:",this.yearList)}catch(a){console.error("初始化年份列表失败:",a)}},initDefaultValues:function(){try{console.log("初始化默认值");var e=(new Date).getMonth();this.monthIndex=e,this.selectedMonth=this.monthList[e],console.log("默认值初始化完成:",{monthIndex:this.monthIndex,selectedMonth:this.selectedMonth})}catch(t){console.error("初始化默认值失败:",t)}},onGradeChange:function(e){this.gradeIndex=e.detail.value,this.selectedGrade=this.gradeList[this.gradeIndex],this.loadStudentsByGrade()},onStudentChange:function(e){this.studentIndex=e.detail.value,this.selectedStudent=this.studentList[this.studentIndex]},loadStudentsByGrade:function(){var t=this;return(0,c.default)(i.default.mark((function a(){var n,o,c;return i.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(t.selectedGrade){a.next=2;break}return a.abrupt("return");case 2:if(a.prev=2,n=e.getStorageSync("userInfo"),console.log("loadStudentsByGrade - userInfo:",n),n){a.next=8;break}return e.showToast({title:"请先登录",icon:"none"}),a.abrupt("return");case 8:return a.next=10,s.callFunction({name:"student-hours",data:{action:"getMyClassStudentsByType",teacherId:n._id}});case 10:o=a.sent,200===o.result.code?(c=[].concat((0,r.default)(o.result.data.classStudents),(0,r.default)(o.result.data.oneToOneStudents)),t.studentList=c.filter((function(e){return e.grade===t.selectedGrade})),t.selectedStudent=null,t.studentIndex=0,console.log("加载学生列表完成:",t.studentList)):e.showToast({title:o.result.message||"加载学生失败",icon:"none"}),a.next=18;break;case 14:a.prev=14,a.t0=a["catch"](2),console.error("加载学生列表失败:",a.t0),e.showToast({title:"加载学生失败，请重试",icon:"none"});case 18:case"end":return a.stop()}}),a,null,[[2,14]])})))()},loadGradeList:function(){var t=this;return(0,c.default)(i.default.mark((function a(){var n,o,c,l;return i.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(a.prev=0,n=e.getStorageSync("userInfo"),console.log("loadGradeList - userInfo:",n),n){a.next=6;break}return e.showToast({title:"请先登录",icon:"none"}),a.abrupt("return");case 6:return a.next=8,s.callFunction({name:"student-hours",data:{action:"getMyClassStudentsByType",teacherId:n._id}});case 8:if(o=a.sent,200!==o.result.code){a.next=21;break}if(c=[].concat((0,r.default)(o.result.data.classStudents),(0,r.default)(o.result.data.oneToOneStudents)),l=(0,r.default)(new Set(c.map((function(e){return e.grade})).filter(Boolean))),t.gradeList=l.sort(),!(t.gradeList.length>0)){a.next=18;break}return t.selectedGrade=t.gradeList[0],t.gradeIndex=0,a.next=18,t.loadStudentsByGrade();case 18:console.log("加载年级列表完成:",t.gradeList),a.next=22;break;case 21:e.showToast({title:o.result.message||"加载年级失败",icon:"none"});case 22:a.next=28;break;case 24:a.prev=24,a.t0=a["catch"](0),console.error("加载年级列表失败:",a.t0),e.showToast({title:"加载年级失败，请重试",icon:"none"});case 28:case"end":return a.stop()}}),a,null,[[0,24]])})))()},onYearChange:function(e){this.yearIndex=e.detail.value,this.selectedYear=this.yearList[this.yearIndex]},onMonthChange:function(e){this.monthIndex=e.detail.value,this.selectedMonth=this.monthList[this.monthIndex]},selectExamType:function(e){this.selectedExamType=e,this.customExamType=""},onCustomTypeInput:function(e){this.customExamType=e.detail.value,this.selectedExamType=""},chooseImage:function(){var t=this;e.chooseImage({count:5-this.examImages.length,sizeType:["compressed"],sourceType:["album","camera"],success:function(e){t.examImages=[].concat((0,r.default)(t.examImages),(0,r.default)(e.tempFilePaths))}})},deleteImage:function(e){this.examImages.splice(e,1)},chooseAnalysisImage:function(){var t=this;e.chooseImage({count:3-this.analysisImages.length,sizeType:["compressed"],sourceType:["album","camera"],success:function(e){t.analysisImages=[].concat((0,r.default)(t.analysisImages),(0,r.default)(e.tempFilePaths))}})},deleteAnalysisImage:function(e){this.analysisImages.splice(e,1)},setDifficultyRating:function(e){this.difficultyRating=e},setStudentPerformance:function(e){this.studentPerformance=e},submitAnalysis:function(){var t=this;return(0,c.default)(i.default.mark((function a(){var n,o,c,l,d,m,h,g,f,I,x,y;return i.default.wrap((function(a){while(1)switch(a.prev=a.next){case 0:if(t.selectedYear&&t.selectedMonth&&(t.selectedExamType||t.customExamType)){a.next=3;break}return e.showToast({title:"请填写完整的基本信息",icon:"none"}),a.abrupt("return");case 3:if(t.selectedStudent&&t.selectedGrade){a.next=6;break}return e.showToast({title:"请选择年级和学生",icon:"none"}),a.abrupt("return");case 6:if(t.examImages&&0!==t.examImages.length||t.examImageFileIDs&&0!==t.examImageFileIDs.length){a.next=9;break}return e.showToast({title:"请上传试卷图片",icon:"none"}),a.abrupt("return");case 9:if(t.analysisText&&""!==t.analysisText.trim()||t.analysisImages&&0!==t.analysisImages.length||t.analysisImageFileIDs&&0!==t.analysisImageFileIDs.length){a.next=12;break}return e.showToast({title:"请填写试卷分析或上传分析图片",icon:"none"}),a.abrupt("return");case 12:if(t.difficultyRating&&0!==t.difficultyRating){a.next=15;break}return e.showToast({title:"请选择考试难度",icon:"none"}),a.abrupt("return");case 15:if(t.studentPerformance&&0!==t.studentPerformance){a.next=18;break}return e.showToast({title:"请选择学生答题效果",icon:"none"}),a.abrupt("return");case 18:e.showLoading({title:"正在提交..."}),a.prev=19,console.log("开始上传图片到云存储"),n=(0,r.default)(t.examImageFileIDs),o=0;case 23:if(!(o<t.examImages.length)){a.next=45;break}return c=t.examImages[o],l="exam_images/".concat(Date.now(),"_").concat(o,"_").concat(Math.random().toString(36).substr(2,9),".jpg"),a.prev=26,a.next=29,s.uploadFile({filePath:c,cloudPath:l});case 29:d=a.sent,n.push(d.fileID),console.log("试卷图片 ".concat(o+1," 上传成功:"),d.fileID),a.next=42;break;case 34:if(a.prev=34,a.t0=a["catch"](26),console.error("试卷图片 ".concat(o+1," 上传失败:"),a.t0),!a.t0.message||!a.t0.message.includes("domain list")){a.next=41;break}throw new Error("图片上传失败：请检查微信小程序域名配置。请在微信开发者工具中配置云存储域名。");case 41:throw new Error("试卷图片 ".concat(o+1," 上传失败"));case 42:o++,a.next=23;break;case 45:m=(0,r.default)(t.analysisImageFileIDs),h=0;case 47:if(!(h<t.analysisImages.length)){a.next=69;break}return g=t.analysisImages[h],f="analysis_images/".concat(Date.now(),"_").concat(h,"_").concat(Math.random().toString(36).substr(2,9),".jpg"),a.prev=50,a.next=53,s.uploadFile({filePath:g,cloudPath:f});case 53:I=a.sent,m.push(I.fileID),console.log("分析图片 ".concat(h+1," 上传成功:"),I.fileID),a.next=66;break;case 58:if(a.prev=58,a.t1=a["catch"](50),console.error("分析图片 ".concat(h+1," 上传失败:"),a.t1),!a.t1.message||!a.t1.message.includes("domain list")){a.next=65;break}throw new Error("图片上传失败：请检查微信小程序域名配置。请在微信开发者工具中配置云存储域名。");case 65:throw new Error("分析图片 ".concat(h+1," 上传失败"));case 66:h++,a.next=47;break;case 69:if(console.log("所有图片上传完成，开始调用云函数"),x=e.getStorageSync("userInfo"),x){a.next=73;break}throw new Error("用户信息不存在");case 73:return a.next=75,s.callFunction({name:"exam-analysis",data:{action:t.isEdit?"update":"save",data:u(u({},t.isEdit&&{id:t.editId}),{},{year:t.selectedYear,month:t.selectedMonth,examType:t.selectedExamType||t.customExamType,examImages:n,analysisText:t.analysisText,analysisImages:m,difficultyRating:t.difficultyRating,studentPerformance:t.studentPerformance,studentId:t.selectedStudent._id,studentName:t.selectedStudent.studentName,grade:t.selectedGrade,userId:x._id,userRole:x.role,userName:x.teacherName||x.username||"未知用户"})}});case 75:y=a.sent,console.log("云函数调用结果:",y),e.hideLoading(),0===y.result.code?(e.showToast({title:t.isEdit?"更新成功":"提交成功",icon:"success"}),t.isEdit?setTimeout((function(){e.navigateBack()}),1500):t.resetForm()):(console.error("提交失败:",y.result.message),e.showToast({title:y.result.message||"提交失败",icon:"none"})),a.next=86;break;case 81:a.prev=81,a.t2=a["catch"](19),e.hideLoading(),console.error("提交失败:",a.t2),a.t2.message&&a.t2.message.includes("域名配置")?e.showModal({title:"配置提示",content:'图片上传失败，需要在微信开发者工具中配置云存储域名。\n\n配置步骤：\n1. 点击右上角"详情"\n2. 选择"域名信息"\n3. 在"uploadFile合法域名"中添加云存储域名\n4. 重新编译项目',showCancel:!1,confirmText:"我知道了"}):e.showToast({title:a.t2.message||"提交失败，请重试",icon:"none"});case 86:case"end":return a.stop()}}),a,null,[[19,81],[26,34],[50,58]])})))()},resetForm:function(){this.selectedYear=this.yearList[0],this.yearIndex=0,this.selectedMonth=this.monthList[(new Date).getMonth()],this.monthIndex=(new Date).getMonth(),this.selectedExamType="",this.customExamType="",this.examImages=[],this.examImageFileIDs=[],this.analysisText="",this.analysisImages=[],this.analysisImageFileIDs=[],this.difficultyRating=0,this.studentPerformance=0,this.selectedGrade=this.gradeList[0]||"",this.gradeIndex=0,this.selectedStudent=null,this.studentIndex=0,this.studentList=[],this.isEdit=!1,this.editId=""},loadAnalysisDetail:function(t){var a=this;return(0,c.default)(i.default.mark((function n(){var o,r,c,l,u,d,m,h,g;return i.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.prev=0,console.log("开始加载分析详情:",t),n.next=4,s.callFunction({name:"exam-analysis",data:{action:"getDetail",data:{id:t}}});case 4:if(o=n.sent,console.log("加载详情结果:",o),0!==o.result.code){n.next=33;break}if(r=o.result.data,console.log("详情数据:",r),a.selectedYear=r.year,c=a.yearList.indexOf(r.year),a.yearIndex=-1!==c?c:0,a.selectedMonth=r.month,l=a.monthList.indexOf(r.month),a.monthIndex=-1!==l?l:0,-1===c&&(a.selectedYear=a.yearList[0]),-1===l&&(a.selectedMonth=a.monthList[0]),u=a.examTypes.indexOf(r.examType),-1!==u?(a.selectedExamType=r.examType,a.customExamType=""):(a.selectedExamType="",a.customExamType=r.examType),r.examImages&&Array.isArray(r.examImages)?(d=r.examImages.filter((function(e){return"string"===typeof e&&e.startsWith("cloud://")})),r.examImages.filter((function(e){return"string"===typeof e&&!e.startsWith("cloud://")})),a.examImageFileIDs=d,a.examImages=[]):(a.examImageFileIDs=[],a.examImages=[]),a.analysisText=r.analysisText||"",r.analysisImages&&Array.isArray(r.analysisImages)?(m=r.analysisImages.filter((function(e){return"string"===typeof e&&e.startsWith("cloud://")})),r.analysisImages.filter((function(e){return"string"===typeof e&&!e.startsWith("cloud://")})),a.analysisImageFileIDs=m,a.analysisImages=[]):(a.analysisImageFileIDs=[],a.analysisImages=[]),a.difficultyRating=r.difficultyRating,a.studentPerformance=r.studentPerformance,r.grade&&(a.selectedGrade=r.grade,h=a.gradeList.indexOf(r.grade),a.gradeIndex=-1!==h?h:0),!r.studentId||!r.studentName){n.next=30;break}return n.next=28,a.loadStudentsByGrade();case 28:g=a.studentList.findIndex((function(e){return e._id===r.studentId})),-1!==g&&(a.selectedStudent=a.studentList[g],a.studentIndex=g);case 30:console.log("详情加载完成"),n.next=35;break;case 33:console.error("加载详情失败:",o.result.message),e.showToast({title:o.result.message||"加载失败",icon:"none"});case 35:n.next=41;break;case 37:n.prev=37,n.t0=n["catch"](0),console.error("加载详情失败:",n.t0),e.showToast({title:"加载失败，请重试",icon:"none"});case 41:case"end":return n.stop()}}),n,null,[[0,37]])})))()},goToList:function(){e.navigateTo({url:"/pages/exam-analysis/exam-analysis-list"})},goBack:function(){e.navigateBack()},openImageZoom:function(t,a){t&&0!==t.length?(this.currentImages=t,this.currentImageIndex=a,this.showImageZoom=!0):e.showToast({title:"没有图片可预览",icon:"none"})},closeImageZoom:function(){this.showImageZoom=!1,this.currentImages=[],this.currentImageIndex=0},switchImage:function(e){this.currentImageIndex=e},deleteCloudExamImage:function(t){var a=this,n=this.examImageFileIDs[t];n&&s.deleteFile({fileList:[n]}).then((function(){a.examImageFileIDs.splice(t,1),e.showToast({title:"图片删除成功",icon:"success"})})).catch((function(t){console.error("删除云存储图片失败:",t),e.showToast({title:"图片删除失败",icon:"none"})}))},deleteLocalExamImage:function(t){this.examImages.splice(t,1),e.showToast({title:"图片删除成功",icon:"success"})},deleteCloudAnalysisImage:function(t){var a=this,n=this.analysisImageFileIDs[t];n&&s.deleteFile({fileList:[n]}).then((function(){a.analysisImageFileIDs.splice(t,1),e.showToast({title:"图片删除成功",icon:"success"})})).catch((function(t){console.error("删除云存储图片失败:",t),e.showToast({title:"图片删除失败",icon:"none"})}))},deleteLocalAnalysisImage:function(t){this.analysisImages.splice(t,1),e.showToast({title:"图片删除成功",icon:"success"})},imageToBase64:function(t){return new Promise((function(a,s){e.getFileSystemManager().readFile({filePath:t,encoding:"base64",success:function(e){var s=t.split(".").pop().toLowerCase(),n="image/jpeg";"png"===s?n="image/png":"gif"===s?n="image/gif":"webp"===s&&(n="image/webp");var i="data:".concat(n,";base64,").concat(e.data);a(i)},fail:function(e){console.error("读取文件失败:",e),s(e)}})}))}}};t.default=d}).call(this,a("df3c")["default"],a("861b")["uniCloud"])}},[["ba33","common/runtime","common/vendor"]]]);