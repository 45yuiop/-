(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["pages/subscription-settings/subscription-settings"],{"123f":function(e,t,n){},"2e0b":function(e,t,n){"use strict";n.d(t,"b",(function(){return o})),n.d(t,"c",(function(){return s})),n.d(t,"a",(function(){}));var o=function(){var e=this.$createElement;this._self._c},s=[]},5835:function(e,t,n){"use strict";n.r(t);var o=n("da21"),s=n.n(o);for(var c in o)["default"].indexOf(c)<0&&function(e){n.d(t,e,(function(){return o[e]}))}(c);t["default"]=s.a},"5fc1":function(e,t,n){"use strict";var o=n("123f"),s=n.n(o);s.a},ba80:function(e,t,n){"use strict";(function(e,t){var o=n("47a9");n("a226"),n("861b");o(n("3240"));var s=o(n("e431"));e.__webpack_require_UNI_MP_PLUGIN__=n,t(s.default)}).call(this,n("3223")["default"],n("df3c")["createPage"])},da21:function(e,t,n){"use strict";(function(e,o){var s=n("47a9");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var c=s(n("7eb4")),a=s(n("7ca3")),r=s(n("ee10"));function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);t&&(o=o.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,o)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){(0,a.default)(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var u={data:function(){return{isSubscribed:!1,isSubscribing:!1,hasOpenid:!1,isBinding:!1,isTesting:!1,templateId:"sOwar1Xkzk4ApC2eQvvc4SZFH6UbFz_ZA8DZjHHPZf4"}},onMounted:function(){console.log("🚀 订阅设置页面加载完成"),this.checkUserStatus()},onShow:function(){console.log("👁️ 订阅设置页面显示"),this.checkUserStatus()},methods:{goBack:function(){e.navigateBack()},checkUserStatus:function(){var t=this;return(0,r.default)(c.default.mark((function n(){var o,s;return c.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:try{o=e.getStorageSync("subscriptionStatus"),o&&o.isSubscribed?(t.isSubscribed=!0,console.log("✅ 本地订阅状态：已订阅")):(t.isSubscribed=!1,console.log("❌ 本地订阅状态：未订阅")),s=e.getStorageSync("openid"),s?(t.hasOpenid=!0,console.log("✅ 微信已绑定:",s)):(t.hasOpenid=!1,console.log("❌ 微信未绑定"))}catch(c){console.error("检查用户状态失败:",c),t.isSubscribed=!1,t.hasOpenid=!1}case 1:case"end":return n.stop()}}),n)})))()},onSubscriptionToggle:function(e){var t=this;return(0,r.default)(c.default.mark((function n(){var o;return c.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(o=e.detail.value,console.log("🔄 订阅开关切换: ".concat(o?"开启":"关闭")),!o){n.next=7;break}return n.next=5,t.enableSubscription();case 5:n.next=8;break;case 7:t.disableSubscription();case 8:case"end":return n.stop()}}),n)})))()},enableSubscription:function(){var t=this;return(0,r.default)(c.default.mark((function n(){var s,a,r;return c.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return t.isSubscribing=!0,n.prev=1,console.log("🔐 请求订阅消息授权..."),n.next=5,e.requestSubscribeMessage({tmplIds:[t.templateId]});case 5:if(s=n.sent,console.log("📱 微信授权结果:",s),"accept"!==s[t.templateId]){n.next=31;break}if(console.log("✅ 用户接受订阅消息授权"),t.isSubscribed=!0,e.setStorageSync("subscriptionStatus",{isSubscribed:!0,status:"accepted",lastUpdate:Date.now(),cacheExpiry:Date.now()+31536e6}),n.prev=11,a=e.getStorageSync("openid"),!a){n.next=22;break}return console.log("📤 同步主订阅授权状态到云端数据库..."),n.next=17,o.callFunction({name:"subscription-message",data:{action:"request-subscription",openid:a,templateId:t.templateId,status:"accepted"}});case 17:r=n.sent,console.log("✅ 主订阅云端数据库同步结果:",r),200===r.result.code?console.log("✅ 主订阅伪永久记录创建成功"):console.log("⚠️ 主订阅伪永久记录创建失败:",r.result.message),n.next=23;break;case 22:console.log("⚠️ 未找到openid，跳过云端同步");case 23:n.next=28;break;case 25:n.prev=25,n.t0=n["catch"](11),console.error("同步主订阅授权状态到云端失败:",n.t0);case 28:e.showToast({title:"订阅成功",icon:"success"}),n.next=32;break;case 31:"reject"===s[t.templateId]?(console.log("❌ 用户拒绝订阅消息授权"),t.isSubscribed=!1,e.showToast({title:"订阅被拒绝",icon:"none"})):(console.log("⚠️ 订阅消息授权失败:",s[t.templateId]),t.isSubscribed=!1,e.showToast({title:"授权失败",icon:"none"}));case 32:n.next=39;break;case 34:n.prev=34,n.t1=n["catch"](1),console.error("请求订阅授权失败:",n.t1),t.isSubscribed=!1,e.showModal({title:"授权失败",content:"无法获取订阅消息授权，请稍后重试。",showCancel:!1,confirmText:"知道了"});case 39:return n.prev=39,t.isSubscribing=!1,n.finish(39);case 42:case"end":return n.stop()}}),n,null,[[1,34,39,42],[11,25]])})))()},disableSubscription:function(){try{console.log("🔒 关闭订阅通知..."),this.isSubscribed=!1,e.removeStorageSync("subscriptionStatus"),e.showToast({title:"已关闭订阅",icon:"success"})}catch(t){console.error("关闭订阅失败:",t)}},handleWechatBinding:function(){var t=this;return(0,r.default)(c.default.mark((function n(){return c.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:t.hasOpenid?e.showModal({title:"重新绑定",content:"是否要重新绑定微信账号？",success:function(e){e.confirm&&t.bindWechat()}}):t.bindWechat();case 1:case"end":return n.stop()}}),n)})))()},bindWechat:function(){var t=this;return(0,r.default)(c.default.mark((function n(){var s,a,r,i;return c.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(!t.isBinding){n.next=3;break}return console.log("正在绑定中，跳过重复操作"),n.abrupt("return");case 3:return n.prev=3,t.isBinding=!0,e.showLoading({title:"正在绑定..."}),n.next=8,e.login({provider:"weixin"});case 8:if(s=n.sent,!s.code){n.next=22;break}if(a=e.getStorageSync("userInfo"),a&&a._id){n.next=15;break}return e.hideLoading(),e.showModal({title:"需要登录",content:"请先登录系统后再绑定微信",showCancel:!1}),n.abrupt("return");case 15:return n.next=17,o.callFunction({name:"auth-service",data:{action:"bind-wechat",params:{code:s.code,userId:a._id}}});case 17:r=n.sent,e.hideLoading(),200===r.result.code?(e.setStorageSync("openid",r.result.openid),t.hasOpenid=!0,e.showToast({title:"微信绑定成功",icon:"success"})):(i=r.result.message||"绑定失败",console.error("微信绑定失败:",r.result),e.showModal({title:"微信绑定失败",content:i,showCancel:!1})),n.next=24;break;case 22:e.hideLoading(),e.showToast({title:"获取微信授权失败",icon:"none"});case 24:n.next=31;break;case 26:n.prev=26,n.t0=n["catch"](3),e.hideLoading(),console.error("绑定微信失败:",n.t0),e.showToast({title:"绑定失败",icon:"none"});case 31:return n.prev=31,t.isBinding=!1,n.finish(31);case 34:case"end":return n.stop()}}),n,null,[[3,26,31,34]])})))()},sendTestMessage:function(){var t=this;return(0,r.default)(c.default.mark((function n(){var s,a,r,i,u,d,b,p,f,g,h,w,m,v,x,S,k,O,T,y,I,M,L,_;return c.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:if(!t.isTesting){n.next=2;break}return n.abrupt("return");case 2:if(t.isTesting=!0,n.prev=3,console.log("🧪 开始发送测试订阅消息..."),e.showLoading({title:"检查订阅状态..."}),s=e.getStorageSync("openid"),s){n.next=11;break}return e.hideLoading(),e.showModal({title:"需要绑定微信",content:"请先绑定微信账号后再发送测试消息。",showCancel:!1,confirmText:"知道了"}),n.abrupt("return");case 11:return n.prev=11,console.log("🔍 检查云端伪永久订阅状态..."),n.next=15,o.callFunction({name:"subscription-message",data:{action:"get-subscription-status",openid:s}});case 15:if(a=n.sent,console.log("📊 云端订阅状态检查结果:",a),200!==a.result.code||!a.result.data.isSubscribed){n.next=22;break}console.log("✅ 发现伪永久订阅记录，直接发送测试消息（无需重新授权）"),e.showLoading({title:"发送测试消息..."}),n.next=36;break;case 22:return console.log("⚠️ 未找到伪永久订阅记录，需要进行首次授权"),n.next=25,e.requestSubscribeMessage({tmplIds:[t.templateId]});case 25:if(r=n.sent,console.log("📱 首次授权结果:",r),"accept"===r[t.templateId]){n.next=31;break}return e.hideLoading(),e.showModal({title:"需要授权",content:"首次使用测试功能需要您授权订阅消息，授权后后续不需重复授权。",showCancel:!1,confirmText:"知道了"}),n.abrupt("return");case 31:return n.next=33,o.callFunction({name:"subscription-message",data:{action:"request-subscription",openid:s,templateId:t.templateId,status:"accepted"}});case 33:i=n.sent,200===i.result.code&&console.log("✅ 伪永久订阅记录创建成功，后续测试无需重复授权"),e.showLoading({title:"发送测试消息..."});case 36:n.next=49;break;case 38:return n.prev=38,n.t0=n["catch"](11),console.error("检查云端订阅状态失败:",n.t0),n.next=43,e.requestSubscribeMessage({tmplIds:[t.templateId]});case 43:if(u=n.sent,"accept"===u[t.templateId]){n.next=48;break}return e.hideLoading(),e.showModal({title:"需要授权",content:"发送测试消息需要您授权订阅消息。",showCancel:!1,confirmText:"知道了"}),n.abrupt("return");case 48:e.showLoading({title:"发送测试消息..."});case 49:return d=new Date,b=new Date(d.getTime()+864e5),p=b.getFullYear(),f=b.getMonth()+1,g=b.getDate(),h="".concat(p,"年").concat(f,"月").concat(g,"日 18:00"),w=d.getTime(),m={courseName:"测试课程-".concat(w),classTime:h,remark:"测试教室-".concat(d.getSeconds(),"秒"),studentName:"测试学员",page:"pages/schedule-tab/schedule-tab"},console.log("📤 即将发送的测试消息数据:",m),n.next=60,o.callFunction({name:"subscription-message",data:l({action:"send-schedule-notification",openid:s},m)});case 60:if(v=n.sent,console.log("📥 测试消息发送结果:",v),e.hideLoading(),!v.success||!v.result){n.next=78;break}if(x=v.result,console.log("☁️ 云函数返回结果详情:",x),200!==x.code){n.next=75;break}y=null===(S=x.data)||void 0===S?void 0:S.msgid,I=(null===(k=x.data)||void 0===k?void 0:k.method)||"pseudo_permanent",M=(null===(O=x.data)||void 0===O?void 0:O.note)||"",L=null===(T=x.data)||void 0===T?void 0:T.originalError,console.log("✅ 云函数执行成功:",{msgid:y,method:I,note:M,originalError:L}),!L||"43101"!==L.errcode&&43101!==L.errcode?y?e.showModal({title:"✅ 测试成功",content:"测试订阅消息发送成功！\n\n消息ID: ".concat(y,"\n发送时间: ").concat((new Date).toLocaleString(),"\n发送方式: ").concat(I,"\n\n").concat(M?"说明: "+M+"\n\n":"","请检查微信是否收到通知。"),confirmText:"知道了",showCancel:!1}):e.showModal({title:"✅ 处理成功",content:"测试消息已处理！\n\n处理时间: ".concat((new Date).toLocaleString(),"\n处理方式: ").concat(I,"\n\n").concat(M?"说明: "+M:"消息已按特殊策略处理"),confirmText:"知道了",showCancel:!1}):(_=t.isSubscribed,console.log("🔍 43101错误分析:",{localSubscribed:_,errorCode:L.errcode,errorMsg:L.errmsg}),e.showModal({title:"📱 微信通知设置提醒",content:"您的订阅状态正常，但微信可能在系统层面限制了通知。\n\n✅ 伪永久订阅仍然有效\n✅ 无需重新授权\n✅ 可继续正常发送\n\n如需接收微信通知，请检查：\n1. 微信-设置-通用-小程序-通知管理\n2. 确保开启了本小程序的通知权限",confirmText:"知道了",showCancel:!1})),n.next=76;break;case 75:throw new Error(x.message||"云函数执行失败");case 76:n.next=79;break;case 78:throw new Error("云函数调用失败");case 79:n.next=86;break;case 81:n.prev=81,n.t1=n["catch"](3),e.hideLoading(),console.error("发送测试消息失败:",n.t1),e.showModal({title:"测试失败",content:"测试消息发送失败：\n\n".concat(n.t1.message,"\n\n请检查网络连接或稍后重试。"),confirmText:"知道了",showCancel:!1});case 86:return n.prev=86,t.isTesting=!1,n.finish(86);case 89:case"end":return n.stop()}}),n,null,[[3,81,86,89],[11,38]])})))()}}};t.default=u}).call(this,n("df3c")["default"],n("861b")["uniCloud"])},e431:function(e,t,n){"use strict";n.r(t);var o=n("2e0b"),s=n("5835");for(var c in s)["default"].indexOf(c)<0&&function(e){n.d(t,e,(function(){return s[e]}))}(c);n("5fc1");var a=n("828b"),r=Object(a["a"])(s["default"],o["b"],o["c"],!1,null,"63ee5c25",null,!1,o["a"],void 0);t["default"]=r.exports}},[["ba80","common/runtime","common/vendor"]]]);