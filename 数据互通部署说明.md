# 新欣火企业官网与小程序数据互通部署说明

## 📋 系统概述

本系统实现了企业官网与uniCloud小程序的真实数据互通，官网能够实时显示小程序云数据库中的统计数据。

## 🏗️ 系统架构

```
小程序 (uniCloud) → 云数据库 → 云函数 → 官网数据大屏
```

## 📁 文件结构

```
新欣火企业官网/
├── index.html                    # 官网首页（已中文化）
├── api/
│   ├── unicloud-stats.php       # PHP API接口（备用）
│   └── data-provider.js         # Node.js API（备用）
├── 新欣火2/
│   └── uniCloud-aliyun/
│       └── cloudfunctions/
│           └── data-stats/       # 数据统计云函数
│               ├── index.js      # 云函数主文件
│               └── package.json  # 云函数依赖
└── 数据互通部署说明.md           # 本文档
```

## 🚀 部署步骤

### 1. 部署云函数

1. 登录 [uniCloud控制台](https://unicloud.dcloud.net.cn/)
2. 选择对应的服务空间
3. 在云函数目录中创建 `data-stats` 云函数
4. 将 `新欣火2/uniCloud-aliyun/cloudfunctions/data-stats/` 目录下的文件上传到云函数
5. **重要**: 如果遇到依赖安装错误，请确保package.json中的dependencies为空对象 `{}`
6. 部署云函数

**注意**: uniCloud云函数环境已内置所需功能，无需额外依赖包。

### 2. 配置云函数权限

确保云函数有以下权限：
- 读取 `students` 集合
- 读取 `courses` 集合  
- 读取 `classes` 集合
- 读取 `uni-id-users` 集合
- 读取 `schedules` 集合

### 3. 获取云函数URL

部署完成后，在uniCloud控制台获取云函数的HTTP调用URL，格式类似：
```
https://fc-mp-{appid}.next.bspapp.com/data-stats
```

### 4. 更新官网配置

在 `index.html` 中更新云函数URL（第2924行）：
```javascript
const response = await fetch('https://fc-mp-9670c93e-7aef-46ce-bbba-401692257cfc.next.bspapp.com', {
```

**注意**: 已更新为您的实际云函数URL。

## 📊 数据说明

### 学生统计数据
- `totalStudents`: 学生总数
- `activeStudents`: 活跃学生数
- `newStudentsThisMonth`: 本月新增学生数
- `studentsByGrade`: 按年级统计
- `studentsBySubject`: 按学科统计

### 课程统计数据
- `totalCourses`: 课程总数
- `activeCourses`: 活跃课程数
- `coursesThisMonth`: 本月新增课程数
- `coursesBySubject`: 按学科统计
- `coursesByGrade`: 按年级统计

### 教师统计数据
- `totalTeachers`: 教师总数
- `activeTeachers`: 活跃教师数
- `newTeachersThisMonth`: 本月新增教师数
- `teachersBySubject`: 按学科统计

### 班级统计数据
- `totalClasses`: 班级总数
- `activeClasses`: 活跃班级数
- `newClassesThisMonth`: 本月新增班级数
- `classesByGrade`: 按年级统计
- `classesBySubject`: 按学科统计

## 🔧 功能特点

### 实时数据更新
- 每30秒自动刷新数据
- 从uniCloud云数据库实时获取最新数据
- 无需修改小程序代码

### 中文化界面
- 所有界面文字已改为中文
- 保持原有UI风格和颜色
- 符合中国用户使用习惯

### 错误处理
- 完善的错误处理机制
- 网络异常时显示友好提示
- 数据加载失败时显示默认状态

## 🌐 访问方式

### 官网首页
```
http://localhost:8001
```

### 数据大屏
在官网首页的"实时数据大屏"区域查看：
- 在校学生数量
- 开设课程数量  
- 教师团队数量
- 班级数量

## 🔍 故障排除

### 1. 云函数部署失败 - npm依赖错误
**错误信息**: `npm ERR! 404 Not Found - GET https://registry.npmjs.org/uni-cloud`

**解决方案**:
1. 确保 `package.json` 中的 `dependencies` 为空对象 `{}`
2. uniCloud环境已内置所需功能，无需额外依赖
3. 重新上传并部署云函数

### 2. 数据加载失败
- 检查云函数是否正常部署
- 确认云函数URL是否正确
- 检查网络连接是否正常
- 查看浏览器控制台错误信息

### 3. 数据不更新
- 确认小程序中有数据写入云数据库
- 检查云函数权限配置
- 查看云函数日志

### 4. 跨域问题
- 云函数已配置CORS支持
- 如仍有问题，可在云函数中添加更多CORS头

## 📝 注意事项

1. **不修改小程序代码**: 按照要求，无需修改小程序代码
2. **保持UI风格**: 严格保持原有模板的颜色和UI风格
3. **中文化**: 所有用户可见文字已改为中文
4. **实时性**: 数据每30秒自动刷新，确保实时性
5. **安全性**: 云函数只提供读取权限，不涉及数据修改

## 🎯 使用流程

1. 小程序正常使用，数据自动保存到uniCloud云数据库
2. 官网自动从云数据库读取最新数据
3. 数据大屏实时显示统计信息
4. 无需任何额外操作，完全自动化

## 📞 技术支持

如有问题，请检查：
1. 云函数部署状态
2. 数据库权限配置
3. 网络连接状态
4. 浏览器控制台错误信息

---

**部署完成后，您的企业官网将能够实时显示小程序中的真实数据！** 🎉
